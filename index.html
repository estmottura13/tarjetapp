<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TarjetApp Â· GestiÃ³n de Tarjetas</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg:#0B0F19;
  --bg-2:#0F1626;
  --glass:rgba(255,255,255,.05);
  --glass-strong:rgba(255,255,255,.08);
  --border:rgba(255,255,255,.08);

  --text:#F8FAFC;
  --text-soft:#94A3B8;

  --primary:#8B5CF6;
  --primary-2:#EC4899;
  --green:#10B981;
  --red:#EF4444;

  --radius:22px;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:'Plus Jakarta Sans',sans-serif;
  background:
    radial-gradient(circle at 10% 10%,rgba(139,92,246,.25),transparent 40%),
    radial-gradient(circle at 90% 20%,rgba(236,72,153,.25),transparent 40%),
    var(--bg);
  color:var(--text);
  min-height:100vh;
}

/* LAYOUT */

.layout{display:flex;min-height:100vh}

.sidebar{
  width:260px;
  background:rgba(15,22,38,.85);
  backdrop-filter:blur(18px);
  border-right:1px solid var(--border);
  padding:20px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

.brand-name{
  font-weight:800;
  font-size:18px;
  background:linear-gradient(90deg,var(--primary),var(--primary-2));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.nav-item{
  margin-top:10px;
  padding:12px 14px;
  border-radius:14px;
  cursor:pointer;
  display:flex;
  gap:10px;
  align-items:center;
  color:var(--text-soft);
  transition:.25s;
  background:transparent;
  border:1px solid transparent;
}

.nav-item:hover{
  background:var(--glass);
  color:white;
}

.nav-item.active{
  background:linear-gradient(90deg,var(--primary),var(--primary-2));
  color:white;
  border:none;
}

.main{
  flex:1;
  padding:30px;
}

/* TOPBAR */

.topbar{
  background:var(--glass);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px 28px;
  backdrop-filter:blur(20px);
  margin-bottom:30px;
}

.topbar-title{
  font-size:20px;
  font-weight:800;
}

/* CARDS */

.stat-card,
.detail-card,
.cc-card{
  background:var(--glass);
  border:1px solid var(--border);
  backdrop-filter:blur(20px);
  border-radius:var(--radius);
  padding:22px;
  transition:.3s;
}

.stat-card:hover,
.cc-card:hover{
  transform:translateY(-6px);
  box-shadow:0 20px 40px rgba(139,92,246,.35);
}

.sc-amount,
.detail-amount{
  font-size:28px;
  font-weight:800;
  background:linear-gradient(90deg,var(--primary),var(--primary-2));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

/* TABLE */

.data-table{
  width:100%;
  border-collapse:collapse;
}

.data-table th{
  text-align:left;
  padding:14px;
  color:var(--text-soft);
  font-size:12px;
  border-bottom:1px solid var(--border);
}

.data-table td{
  padding:16px;
  border-bottom:1px solid var(--border);
}

.data-table tr:hover{
  background:rgba(255,255,255,.03);
}

/* BUTTONS */

.btn{
  border-radius:14px;
  padding:10px 18px;
  font-weight:600;
  cursor:pointer;
  border:none;
  transition:.25s;
}

.btn-primary{
  background:linear-gradient(90deg,var(--primary),var(--primary-2));
  color:white;
}

.btn-primary:hover{
  transform:translateY(-3px);
  box-shadow:0 12px 25px rgba(139,92,246,.45);
}

.btn-secondary{
  background:var(--glass);
  color:var(--text);
  border:1px solid var(--border);
}

.btn-danger{
  background:var(--red);
  color:white;
}

/* CREDIT CARDS */

.cc-card{
  min-height:170px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  background:linear-gradient(145deg,var(--primary),var(--primary-2));
  color:white;
  box-shadow:0 25px 50px rgba(139,92,246,.45);
}

.cc-bank{font-weight:700;font-size:15px}
.cc-number{letter-spacing:3px}

/* MODALS */

.modal{
  background:rgba(15,22,38,.95);
  backdrop-filter:blur(20px);
  border-radius:var(--radius);
  border:1px solid var(--border);
}

input,select{
  background:var(--bg-2);
  border:1px solid var(--border);
  color:white;
  border-radius:14px;
  padding:12px;
}

/* TOAST */

.toast{
  background:linear-gradient(90deg,var(--primary),var(--primary-2));
  border-radius:14px;
  padding:14px 20px;
}

/* MOBILE */

@media(max-width:768px){

  .sidebar{
    position:fixed;
    bottom:0;
    top:auto;
    height:70px;
    width:100%;
    flex-direction:row;
    align-items:center;
    justify-content:space-around;
    padding:0;
    border-right:none;
    border-top:1px solid var(--border);
  }

  .main{
    padding:20px;
    margin-bottom:80px;
  }

  .nav-item{
    flex-direction:column;
    font-size:11px;
  }

}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-screen" id="loading-screen">
  <div class="loading-brand">
    <div class="loading-brand-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/>
      </svg>
    </div>
    <div class="loading-name">TarjetApp</div>
  </div>
  <div class="loading-bar-wrap"><div class="loading-bar"></div></div>
  <div class="loading-sub">Conectando con base de datosâ€¦</div>
</div>

<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <div class="brand-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/>
        </svg>
      </div>
      <div>
        <div class="brand-name">Tarjet<span>App</span></div>
        <div class="brand-sub">GestiÃ³n de gastos</div>
      </div>
    </div>
    <div class="nav-wrap">
      <div class="nav-group-label">Principal</div>
      <button class="nav-item active" onclick="showPage('resumen',this)">
        <span class="nav-icon">ğŸ“Š</span><span>Resumen</span>
      </button>
      <button class="nav-item" onclick="showPage('gastos',this)">
        <span class="nav-icon">ğŸ’³</span><span>Gastos</span>
      </button>
      <div class="nav-group-label">ConfiguraciÃ³n</div>
      <button class="nav-item" onclick="showPage('tarjetas',this)">
        <span class="nav-icon">ğŸ—‚ï¸</span><span>Tarjetas</span>
      </button>
    </div>
    <div class="sidebar-foot">
      <span class="sync-dot" id="sync-dot"></span>
      <span class="sync-label" id="sync-label">Conectandoâ€¦</span>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <!-- TOPBAR -->
    <header class="topbar">
      <div class="topbar-left">
        <div class="topbar-title" id="topbar-title">Resumen</div>
        <div class="topbar-sub" id="topbar-sub">PerÃ­odos de facturaciÃ³n por tarjeta</div>
      </div>
      <div class="topbar-actions" id="topbar-actions"></div>
    </header>

    <div class="content">

      <!-- â•â•â•â• RESUMEN â•â•â•â• -->
      <div class="page active" id="page-resumen">
        <div class="period-nav">
          <button class="period-arrow" onclick="changePeriod(-1)">â€¹</button>
          <div class="period-mid">
            <div class="period-month" id="period-month">â€”</div>
            <div class="period-badge" id="period-badge">â€”</div>
          </div>
          <button class="period-arrow" onclick="changePeriod(1)">â€º</button>
        </div>
        <div class="stats-row" id="stats-row"></div>
        <div id="detail-area"></div>
      </div>

      <!-- â•â•â•â• GASTOS â•â•â•â• -->
      <div class="page" id="page-gastos">
        <div class="filter-tabs">
          <button class="filter-tab active" onclick="filterGastos('todos',this)">Todos</button>
          <button class="filter-tab" onclick="filterGastos('pendientes',this)">Pendientes</button>
          <button class="filter-tab" onclick="filterGastos('pasados',this)">Pasados</button>
        </div>
        <div class="detail-card">
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>DescripciÃ³n</th><th>Tarjeta</th><th>Fecha compra</th>
                  <th style="text-align:right;">Monto total</th><th>Cuotas</th>
                  <th style="width:90px;"></th>
                </tr>
              </thead>
              <tbody id="gastos-tbody"></tbody>
            </table>
            <div id="gastos-empty" class="empty-state" style="display:none;">
              <div class="empty-icon">ğŸ›ï¸</div>
              <div class="empty-title">Sin gastos registrados</div>
              <div class="empty-sub">UsÃ¡ el botÃ³n "Nuevo gasto" para empezar a registrar</div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â•â• TARJETAS â•â•â•â• -->
      <div class="page" id="page-tarjetas">
        <div class="cc-grid" id="cc-grid"></div>
        <div id="tarjetas-empty" class="empty-state" style="display:none;">
          <div class="empty-icon">ğŸ’³</div>
          <div class="empty-title">Sin tarjetas configuradas</div>
          <div class="empty-sub">AgregÃ¡ tu primera tarjeta para comenzar</div>
        </div>
        <div class="cierres-panel" id="cierres-panel">
          <div class="cierres-head">
            <div>
              <div style="font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--green);margin-bottom:2px;">Fechas de cierre</div>
              <div class="cierres-title" id="cierres-title">â€”</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="closeCierres()">âœ• Cerrar</button>
          </div>
          <div class="cierres-grid" id="cierres-grid"></div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /layout -->

<!-- MODAL TARJETA -->
<div class="modal-overlay" id="modal-tarjeta">
  <div class="modal">
    <div class="modal-head">
      <div>
        <div class="modal-eyebrow" id="mt-eyebrow">Nueva tarjeta</div>
        <div class="modal-title" id="mt-title">Agregar tarjeta</div>
      </div>
      <button class="modal-close" onclick="closeModal('modal-tarjeta')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div><label class="field-label">Banco / Emisor</label><input type="text" id="tc-banco" placeholder="Ej: Galicia, BBVA, Santanderâ€¦"></div>
        <div><label class="field-label">Nombre de la tarjeta</label><input type="text" id="tc-nombre" placeholder="Ej: Visa Gold, Mastercardâ€¦"></div>
        <div><label class="field-label">Ãšltimos 4 dÃ­gitos (opcional)</label><input type="text" id="tc-digitos" maxlength="4" placeholder="1234"></div>
        <div>
          <label class="field-label">Color de la tarjeta</label>
          <div class="color-picker" id="color-picker">
            <div class="color-dot selected" style="background:#16A34A" data-color="#16A34A" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#0EA5E9" data-color="#0EA5E9" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#7C3AED" data-color="#7C3AED" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#F59E0B" data-color="#F59E0B" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#EF4444" data-color="#EF4444" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#EC4899" data-color="#EC4899" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#0F766E" data-color="#0F766E" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#475569" data-color="#475569" onclick="selectColor(this)"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('modal-tarjeta')">Cancelar</button>
      <button class="btn btn-primary" id="btn-save-tarjeta" onclick="saveTarjeta()">Guardar tarjeta</button>
    </div>
  </div>
</div>

<!-- MODAL GASTO -->
<div class="modal-overlay" id="modal-gasto">
  <div class="modal">
    <div class="modal-head">
      <div>
        <div class="modal-eyebrow" id="mg-eyebrow">Nuevo gasto</div>
        <div class="modal-title" id="mg-title">Registrar compra</div>
      </div>
      <button class="modal-close" onclick="closeModal('modal-gasto')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div><label class="field-label">DescripciÃ³n</label><input type="text" id="g-desc" placeholder="Ej: Supermercado, Netflix, Ropaâ€¦"></div>
        <div class="form-row">
          <div><label class="field-label">Tarjeta</label><select id="g-tarjeta" onchange="previewCuotas()"></select></div>
          <div><label class="field-label">Fecha de compra</label><input type="date" id="g-fecha" onchange="previewCuotas()"></div>
        </div>
        <div class="form-row">
          <div><label class="field-label">Monto total ($)</label><input type="number" id="g-monto" placeholder="0,00" min="0" step="0.01" oninput="previewCuotas()"></div>
          <div><label class="field-label">Cantidad de cuotas</label><input type="number" id="g-cuotas" value="1" min="1" max="60" oninput="previewCuotas()"></div>
        </div>
        <div id="cuotas-preview-wrap" style="display:none;">
          <div class="cuota-preview">
            <div class="cuota-preview-title">DistribuciÃ³n de cuotas</div>
            <div id="cuotas-preview-content"></div>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label class="field-label">CategorÃ­a (opcional)</label>
            <select id="g-categoria">
              <option value="">Sin categorÃ­a</option>
              <option>ğŸ›’ Supermercado</option><option>ğŸ½ï¸ Restaurantes</option>
              <option>â›½ Combustible</option><option>ğŸ¥ Salud</option>
              <option>âœˆï¸ Viajes</option><option>ğŸ¬ Entretenimiento</option>
              <option>ğŸ‘— Ropa</option><option>ğŸ  Hogar</option>
              <option>ğŸ“± TecnologÃ­a</option><option>ğŸ’¼ Trabajo</option>
              <option>ğŸ“ EducaciÃ³n</option><option>Otro</option>
            </select>
          </div>
          <div><label class="field-label">Nota (opcional)</label><input type="text" id="g-nota" placeholder="Detalle adicionalâ€¦"></div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('modal-gasto')">Cancelar</button>
      <button class="btn btn-primary" id="btn-save-gasto" onclick="saveGasto()">Registrar gasto</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUPABASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SURL = 'https://ndiunufkwvgyrbtqctwp.supabase.co';
const SKEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXVudWZrd3ZneXJidHFjdHdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDE3NDksImV4cCI6MjA4NzE3Nzc0OX0.jwry-uF9hstCHLrQyq4OfeGfarsxBaxich6enVOLR2U';
const sb = supabase.createClient(SURL, SKEY);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let tarjetas = [], cierres = [], gastos = [];
let selectedColor = '#16A34A';
let editingTarjetaId = null;
let editingGastoId = null;
let gastoFilter = 'todos';
let allPeriods = [], currentPeriodIdx = 0;
let selectedTarjetaId = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function init() {
  try {
    const [t, c, g] = await Promise.all([
      sb.from('tarjetas').select('*').order('created_at'),
      sb.from('cierres').select('*'),
      sb.from('gastos').select('*').order('created_at', { ascending: false }),
    ]);
    if (t.error || c.error || g.error) throw new Error();
    tarjetas = t.data; cierres = c.data; gastos = g.data;
    setSyncStatus(true);
  } catch {
    setSyncStatus(false);
    showToast('Error al conectar con la base de datos', 'error');
  }
  setTimeout(() => {
    const ls = document.getElementById('loading-screen');
    ls.style.transition = 'opacity .4s'; ls.style.opacity = '0';
    setTimeout(() => ls.style.display = 'none', 400);
  }, 1200);
  buildAllPeriods(); setCurrentPeriod(); renderResumen();
}

function setSyncStatus(ok) {
  document.getElementById('sync-dot').style.background = ok ? '#16A34A' : '#DC2626';
  document.getElementById('sync-label').textContent = ok ? 'Sincronizado' : 'Sin conexiÃ³n';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PAGE_META = {
  resumen:  { title: 'Resumen',  sub: 'PerÃ­odos de facturaciÃ³n por tarjeta', action: null },
  gastos:   { title: 'Gastos',   sub: 'RegistrÃ¡ cada compra, en una o mÃ¡s cuotas', action: () => `<button class="btn btn-primary" onclick="openModalGasto()">ï¼‹ Nuevo gasto</button>` },
  tarjetas: { title: 'Tarjetas', sub: 'ConfigurÃ¡ tus tarjetas y fechas de cierre', action: () => `<button class="btn btn-primary" onclick="openModalTarjeta()">ï¼‹ Nueva tarjeta</button>` },
};

function showPage(name, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  el.classList.add('active');
  const meta = PAGE_META[name];
  document.getElementById('topbar-title').textContent = meta.title;
  document.getElementById('topbar-sub').textContent = meta.sub;
  document.getElementById('topbar-actions').innerHTML = meta.action ? meta.action() : '';
  window.scrollTo({ top: 0 });
  if (name === 'resumen') renderResumen();
  if (name === 'gastos') renderGastos();
  if (name === 'tarjetas') renderTarjetas();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERIOD LOGIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getMonthKey(y, m) { return `${y}-${String(m + 1).padStart(2, '0')}`; }
function nextMk(mk) { const [y, m] = mk.split('-').map(Number); const d = new Date(y, m, 1); return getMonthKey(d.getFullYear(), d.getMonth()); }
function getCierreDia(tid, mk) { const c = cierres.find(c => c.tarjeta_id === tid && c.mes_key === mk); return c ? c.dia : null; }

function getCierreForFecha(tid, fechaStr) {
  const fc = new Date(fechaStr + 'T12:00:00');
  for (let i = 0; i < 36; i++) {
    const d = new Date(fc.getFullYear(), fc.getMonth() + i, 1);
    const mk = getMonthKey(d.getFullYear(), d.getMonth());
    const dia = getCierreDia(tid, mk);
    if (!dia) continue;
    if (new Date(d.getFullYear(), d.getMonth(), dia) >= fc) return mk;
  }
  return getMonthKey(fc.getFullYear(), fc.getMonth());
}

function getCuotasPorPeriodo(g) {
  const r = {};
  const mk0 = getCierreForFecha(g.tarjeta_id, g.fecha);
  if (!mk0) return r;
  const cm = g.monto / g.cuotas;
  let mk = mk0;
  for (let i = 0; i < g.cuotas; i++) { r[mk] = (r[mk] || 0) + cm; mk = nextMk(mk); }
  return r;
}

function getPeriodRange(tid, mk) {
  const [y, m] = mk.split('-').map(Number);
  const dA = getCierreDia(tid, mk);
  const d = new Date(y, m - 1, 1);
  const mkP = getMonthKey(d.getFullYear(), d.getMonth() - 1);
  const dP = getCierreDia(tid, mkP);
  if (dA && dP) return { desde: new Date(d.getFullYear(), d.getMonth() - 1, dP + 1), hasta: new Date(d.getFullYear(), d.getMonth(), dA), exacto: true };
  return { desde: new Date(y, m - 1, 1), hasta: new Date(y, m, 0), exacto: false };
}

function buildAllPeriods() {
  const now = new Date();
  const mkNow = getMonthKey(now.getFullYear(), now.getMonth());
  const mk2back = getMonthKey(now.getFullYear(), now.getMonth() - 2);
  const res = new Set();
  cierres.forEach(c => { if (c.mes_key >= mk2back && c.mes_key <= mkNow) res.add(c.mes_key); });
  gastos.forEach(g => {
    const dist = getCuotasPorPeriodo(g);
    Object.keys(dist).forEach(mk => { if (mk > mkNow) res.add(mk); });
  });
  allPeriods = [...res].sort();
}

function setCurrentPeriod() {
  if (!allPeriods.length) return;
  const now = new Date();
  const mkN = getMonthKey(now.getFullYear(), now.getMonth());
  const idx = allPeriods.indexOf(mkN);
  currentPeriodIdx = idx >= 0 ? idx : allPeriods.length - 1;
}

function changePeriod(dir) {
  currentPeriodIdx = Math.max(0, Math.min(allPeriods.length - 1, currentPeriodIdx + dir));
  selectedTarjetaId = null;
  renderResumen();
}

function mkToLabel(mk) {
  const [y, m] = mk.split('-').map(Number);
  return ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][m - 1] + ' ' + y;
}
function mkToShort(mk) {
  const [y, m] = mk.split('-').map(Number);
  return ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][m - 1] + ' ' + y;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESUMEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderResumen() {
  buildAllPeriods();
  const statsEl = document.getElementById('stats-row');
  const detailEl = document.getElementById('detail-area');

  if (!tarjetas.length) {
    document.getElementById('period-month').textContent = 'â€”';
    document.getElementById('period-badge').textContent = 'â€”';
    statsEl.innerHTML = '';
    detailEl.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><div class="empty-title">Sin tarjetas configuradas</div><div class="empty-sub">AndÃ¡ a Tarjetas y configurÃ¡ tus primeras tarjetas</div></div>';
    return;
  }
  if (!allPeriods.length) {
    document.getElementById('period-month').textContent = 'â€”';
    document.getElementById('period-badge').textContent = 'â€”';
    statsEl.innerHTML = '';
    detailEl.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“…</div><div class="empty-title">Sin perÃ­odos disponibles</div><div class="empty-sub">ConfigurÃ¡ fechas de cierre o cargÃ¡ gastos para ver perÃ­odos</div></div>';
    return;
  }

  if (currentPeriodIdx >= allPeriods.length) currentPeriodIdx = allPeriods.length - 1;
  const mk = allPeriods[currentPeriodIdx];
  const [y, m] = mk.split('-').map(Number);
  const esFuturo = new Date(y, m - 1, 28) > new Date();

  document.getElementById('period-month').textContent = mkToLabel(mk);
  const badge = document.getElementById('period-badge');
  badge.textContent = esFuturo ? 'â†— PerÃ­odo futuro â€” estimado' : 'âœ“ PerÃ­odo en curso o cerrado';
  badge.className = 'period-badge' + (esFuturo ? ' future' : '');

  let totalGeneral = 0;
  const perTarjeta = tarjetas.map(t => {
    let total = 0; const gEP = [];
    gastos.forEach(g => {
      if (g.tarjeta_id !== t.id) return;
      const dist = getCuotasPorPeriodo(g);
      if (dist[mk]) { total += dist[mk]; gEP.push({ g, monto: dist[mk] }); }
    });
    totalGeneral += total;
    return { t, total, gEP, range: getPeriodRange(t.id, mk) };
  });

  // Stats cards
  let sHTML = `
    <div class="stat-card total-card">
      <div class="sc-label">Total del perÃ­odo</div>
      <div class="sc-amount${esFuturo ? ' future' : ''}">$${fmt(totalGeneral)}</div>
      <div class="sc-sub">${esFuturo ? 'ğŸ“… Monto estimado' : 'âœ… Monto facturado'}</div>
    </div>`;

  perTarjeta.forEach(({ t, total }) => {
    const pct = totalGeneral ? Math.round(total / totalGeneral * 100) : 0;
    const isSel = selectedTarjetaId === t.id;
    sHTML += `
      <div class="stat-card clickable${isSel ? ' selected' : ''}" onclick="selectTarjeta('${t.id}')">
        <div class="sc-label"><span class="sc-dot" style="background:${t.color}"></span>${t.banco}</div>
        <div class="sc-amount${esFuturo ? ' future' : ''}">$${fmt(total)}</div>
        <div class="sc-bar"><div class="sc-bar-fill" style="width:${pct}%;background:${t.color}"></div></div>
        <div class="sc-sub">${pct}% del total</div>
        <div class="sc-hint">${isSel ? 'â–² Ocultar detalle' : 'â–¼ Ver detalle'}</div>
      </div>`;
  });
  statsEl.innerHTML = sHTML;

  // Detail
  if (!selectedTarjetaId) {
    detailEl.innerHTML = '<div class="hint-box">SeleccionÃ¡ una tarjeta para ver el detalle de sus gastos en este perÃ­odo</div>';
    return;
  }
  const item = perTarjeta.find(x => x.t.id === selectedTarjetaId);
  if (!item) { detailEl.innerHTML = ''; return; }
  const { t, total, gEP, range } = item;
  const rangoStr = range.exacto
    ? `${formatDate(range.desde)} â†’ ${formatDate(range.hasta)}`
    : `${formatDate(range.desde)} â†’ ${formatDate(range.hasta)} <span style="color:var(--ink4);font-size:11px;">(mes completo)</span>`;

  const rows = gEP.map(({ g, monto }) => {
    const cn = Object.keys(getCuotasPorPeriodo(g)).sort().indexOf(mk) + 1;
    const isSingle = g.cuotas === 1;
    const pillClass = isSingle ? 'pill-green' : 'pill-blue';
    return `<tr>
      <td>
        <div style="font-weight:600;">${g.categoria ? g.categoria + ' ' : ''}${g.descripcion}</div>
        ${g.nota ? `<div style="font-size:11px;color:var(--ink4);margin-top:2px;">${g.nota}</div>` : ''}
      </td>
      <td style="color:var(--ink3);">${formatDate(new Date(g.fecha + 'T12:00:00'))}</td>
      <td><span class="pill ${pillClass}">${isSingle ? '1 pago' : `${cn} / ${g.cuotas}`}</span></td>
      <td style="text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">$${fmt(monto)}</td>
    </tr>`;
  }).join('');

  detailEl.innerHTML = `
    <div class="detail-card" style="border-top:3px solid ${t.color};">
      <div class="detail-card-head">
        <div class="detail-card-head-left">
          <div class="detail-stripe" style="background:${t.color};"></div>
          <div>
            <div class="detail-bank">${t.banco} <span style="font-weight:400;color:var(--ink4);">â€” ${t.nombre}${t.digitos ? ' Â·Â·Â·Â· ' + t.digitos : ''}</span></div>
            <div class="detail-meta">PerÃ­odo: ${rangoStr}</div>
          </div>
        </div>
        <div>
          <div class="detail-amount${esFuturo ? ' future' : ''}">$${fmt(total)}</div>
          <div class="detail-tag">${esFuturo ? 'estimado' : 'facturado'}</div>
        </div>
      </div>
      ${gEP.length ? `
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr>
              <th>Concepto</th><th>Fecha compra</th><th>Cuotas</th>
              <th style="text-align:right;">Monto</th>
            </tr></thead>
            <tbody>${rows}</tbody>
            <tfoot><tr>
              <td colspan="3" style="font-size:11px;text-transform:uppercase;letter-spacing:.8px;">Total tarjeta</td>
              <td style="text-align:right;">$${fmt(total)}</td>
            </tr></tfoot>
          </table>
        </div>` : `<div style="padding:20px 24px;color:var(--ink4);font-size:13px;">Sin gastos registrados en este perÃ­odo.</div>`}
    </div>`;
}

function selectTarjeta(tid) {
  selectedTarjetaId = selectedTarjetaId === tid ? null : tid;
  renderResumen();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GASTOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderGastos() {
  const tbody = document.getElementById('gastos-tbody');
  const empty = document.getElementById('gastos-empty');
  const now = new Date();
  let lista = [...gastos];

  if (gastoFilter === 'pendientes') lista = lista.filter(g => {
    const mks = Object.keys(getCuotasPorPeriodo(g)).sort();
    if (!mks.length) return true;
    const [y, m] = mks[mks.length - 1].split('-').map(Number);
    return new Date(y, m - 1, 28) >= now;
  });
  else if (gastoFilter === 'pasados') lista = lista.filter(g => {
    const mks = Object.keys(getCuotasPorPeriodo(g)).sort();
    if (!mks.length) return false;
    const [y, m] = mks[mks.length - 1].split('-').map(Number);
    return new Date(y, m - 1, 28) < now;
  });

  if (!lista.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  tbody.innerHTML = lista.map(g => {
    const t = tarjetas.find(t => t.id === g.tarjeta_id);
    const montoCuota = g.monto / g.cuotas;
    return `<tr>
      <td>
        <div style="font-weight:600;">${g.categoria ? g.categoria + ' ' : ''}${g.descripcion}</div>
        ${g.nota ? `<div style="font-size:11px;color:var(--ink4);margin-top:2px;">${g.nota}</div>` : ''}
      </td>
      <td>${t ? `<span class="pill cc-pill" style="background:${t.color}20;color:${t.color};border:1px solid ${t.color}40;">${t.banco}</span>` : 'â€”'}</td>
      <td style="color:var(--ink3);">${formatDate(new Date(g.fecha + 'T12:00:00'))}</td>
      <td style="text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">$${fmt(g.monto)}</td>
      <td><span class="pill pill-gray">${g.cuotas > 1 ? `${g.cuotas}Ã— $${fmt(montoCuota)}` : '1 pago'}</span></td>
      <td>
        <div style="display:flex;gap:6px;justify-content:flex-end;">
          <button class="btn btn-secondary btn-xs" onclick="openModalEditGasto('${g.id}')" title="Editar">âœ</button>
          <button class="btn btn-danger btn-xs" onclick="deleteGasto('${g.id}')" title="Eliminar">âœ•</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function filterGastos(f, el) {
  gastoFilter = f;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderGastos();
}

function openModalGasto() {
  if (!tarjetas.length) { showToast('Primero agregÃ¡ una tarjeta', 'error'); return; }
  editingGastoId = null;
  document.getElementById('mg-eyebrow').textContent = 'Nuevo gasto';
  document.getElementById('mg-title').textContent = 'Registrar compra';
  document.getElementById('btn-save-gasto').textContent = 'Registrar gasto';
  document.getElementById('g-tarjeta').innerHTML = tarjetas.map(t => `<option value="${t.id}">${t.banco} â€“ ${t.nombre}</option>`).join('');
  document.getElementById('g-fecha').value = new Date().toISOString().split('T')[0];
  ['g-monto', 'g-desc', 'g-nota'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('g-cuotas').value = 1;
  document.getElementById('g-categoria').value = '';
  document.getElementById('cuotas-preview-wrap').style.display = 'none';
  openModal('modal-gasto');
}

function openModalEditGasto(id) {
  const g = gastos.find(g => g.id === id); if (!g) return;
  editingGastoId = id;
  document.getElementById('mg-eyebrow').textContent = 'Editar gasto';
  document.getElementById('mg-title').textContent = 'Modificar compra';
  document.getElementById('btn-save-gasto').textContent = 'Guardar cambios';
  document.getElementById('g-tarjeta').innerHTML = tarjetas.map(t => `<option value="${t.id}"${t.id === g.tarjeta_id ? ' selected' : ''}>${t.banco} â€“ ${t.nombre}</option>`).join('');
  document.getElementById('g-desc').value = g.descripcion;
  document.getElementById('g-fecha').value = g.fecha;
  document.getElementById('g-monto').value = g.monto;
  document.getElementById('g-cuotas').value = g.cuotas;
  document.getElementById('g-categoria').value = g.categoria || '';
  document.getElementById('g-nota').value = g.nota || '';
  previewCuotas();
  openModal('modal-gasto');
}

function previewCuotas() {
  const cuotas = parseInt(document.getElementById('g-cuotas').value) || 1;
  const monto = parseFloat(document.getElementById('g-monto').value) || 0;
  const tid = document.getElementById('g-tarjeta').value;
  const fecha = document.getElementById('g-fecha').value;
  const wrap = document.getElementById('cuotas-preview-wrap');
  if (cuotas <= 1 || !monto || !fecha || !tid) { wrap.style.display = 'none'; return; }
  const dist = getCuotasPorPeriodo({ tarjeta_id: tid, fecha, monto, cuotas });
  const mks = Object.keys(dist).sort();
  if (!mks.length) { wrap.style.display = 'none'; return; }
  document.getElementById('cuotas-preview-content').innerHTML = mks.map((mk, i) =>
    `<div class="cuota-row">
      <span class="cuota-row-label">Cuota ${i + 1}/${cuotas} Â· ${mkToShort(mk)}</span>
      <span class="cuota-row-val">$${fmt(monto / cuotas)}</span>
    </div>`
  ).join('');
  wrap.style.display = 'block';
}

async function saveGasto() {
  const descripcion = document.getElementById('g-desc').value.trim();
  const tarjeta_id = document.getElementById('g-tarjeta').value;
  const fecha = document.getElementById('g-fecha').value;
  const monto = parseFloat(document.getElementById('g-monto').value);
  const cuotas = parseInt(document.getElementById('g-cuotas').value) || 1;
  const categoria = document.getElementById('g-categoria').value;
  const nota = document.getElementById('g-nota').value.trim();
  if (!descripcion) { showToast('IngresÃ¡ una descripciÃ³n', 'error'); return; }
  if (!fecha) { showToast('IngresÃ¡ la fecha', 'error'); return; }
  if (!monto || monto <= 0) { showToast('IngresÃ¡ un monto vÃ¡lido', 'error'); return; }
  const btn = document.getElementById('btn-save-gasto');
  const isEditing = !!editingGastoId;
  btn.disabled = true; btn.innerHTML = '<div class="loader"></div> Guardandoâ€¦';
  if (isEditing) {
    const { data, error } = await sb.from('gastos').update({ descripcion, tarjeta_id, fecha, monto, cuotas, categoria, nota }).eq('id', editingGastoId).select();
    if (error) { showToast('Error al actualizar', 'error'); }
    else { const idx = gastos.findIndex(g => g.id === editingGastoId); if (idx >= 0) gastos[idx] = data[0]; closeModal('modal-gasto'); renderGastos(); buildAllPeriods(); showToast('Gasto actualizado'); }
  } else {
    const { data, error } = await sb.from('gastos').insert([{ descripcion, tarjeta_id, fecha, monto, cuotas, categoria, nota }]).select();
    if (error) { showToast('Error al guardar', 'error'); }
    else { gastos.unshift(data[0]); closeModal('modal-gasto'); renderGastos(); buildAllPeriods(); showToast('Gasto registrado'); }
  }
  btn.disabled = false; btn.innerHTML = isEditing ? 'Guardar cambios' : 'Registrar gasto';
}

async function deleteGasto(id) {
  if (!confirm('Â¿Eliminar este gasto?')) return;
  const { error } = await sb.from('gastos').delete().eq('id', id);
  if (error) { showToast('Error al eliminar', 'error'); return; }
  gastos = gastos.filter(g => g.id !== id);
  renderGastos();
  buildAllPeriods();
  showToast('Gasto eliminado');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TARJETAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTarjetas() {
  const grid = document.getElementById('cc-grid');
  const empty = document.getElementById('tarjetas-empty');
  if (!tarjetas.length) { grid.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  grid.innerHTML = tarjetas.map(t => {
    const count = cierres.filter(c => c.tarjeta_id === t.id).length;
    const bg = `linear-gradient(135deg, ${t.color} 0%, ${darken(t.color, 30)} 100%)`;
    return `<div class="cc-card" style="background:${bg};" onclick="openCierres('${t.id}')">
      <div><div class="cc-bank">${t.banco}</div><div class="cc-name">${t.nombre}</div></div>
      <div class="cc-chip">â—¼</div>
      <div>
        <div class="cc-number">${t.digitos ? 'â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ' + t.digitos : 'â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢'}</div>
        <div class="cc-count">${count} cierre${count !== 1 ? 's' : ''} configurado${count !== 1 ? 's' : ''}</div>
        <div class="cc-btns" onclick="event.stopPropagation()">
          <button class="cc-btn" onclick="openCierres('${t.id}')">ğŸ“… Cierres</button>
          <button class="cc-btn" onclick="editTarjeta('${t.id}')">âœ Editar</button>
          <button class="cc-btn" onclick="deleteTarjeta('${t.id}')">âœ•</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function darken(hex, amount = 30) {
  try {
    const r = Math.max(0, parseInt(hex.slice(1, 3), 16) - amount);
    const g = Math.max(0, parseInt(hex.slice(3, 5), 16) - amount);
    const b = Math.max(0, parseInt(hex.slice(5, 7), 16) - amount);
    return `rgb(${r},${g},${b})`;
  } catch { return hex; }
}

function openModalTarjeta() {
  editingTarjetaId = null;
  document.getElementById('mt-eyebrow').textContent = 'Nueva tarjeta';
  document.getElementById('mt-title').textContent = 'Agregar tarjeta';
  ['tc-banco', 'tc-nombre', 'tc-digitos'].forEach(id => document.getElementById(id).value = '');
  selectedColor = '#16A34A';
  document.querySelectorAll('.color-dot').forEach(d => d.classList.toggle('selected', d.dataset.color === selectedColor));
  openModal('modal-tarjeta');
}

function editTarjeta(id) {
  const t = tarjetas.find(t => t.id === id); if (!t) return;
  editingTarjetaId = id;
  document.getElementById('mt-eyebrow').textContent = 'Editar tarjeta';
  document.getElementById('mt-title').textContent = 'Modificar tarjeta';
  document.getElementById('tc-banco').value = t.banco;
  document.getElementById('tc-nombre').value = t.nombre;
  document.getElementById('tc-digitos').value = t.digitos || '';
  selectedColor = t.color;
  document.querySelectorAll('.color-dot').forEach(d => d.classList.toggle('selected', d.dataset.color === t.color));
  openModal('modal-tarjeta');
}

async function saveTarjeta() {
  const banco = document.getElementById('tc-banco').value.trim();
  const nombre = document.getElementById('tc-nombre').value.trim();
  const digitos = document.getElementById('tc-digitos').value.trim();
  if (!banco) { showToast('IngresÃ¡ el nombre del banco', 'error'); return; }
  if (!nombre) { showToast('IngresÃ¡ el nombre de la tarjeta', 'error'); return; }
  const btn = document.getElementById('btn-save-tarjeta');
  btn.disabled = true; btn.innerHTML = '<div class="loader" style="border-top-color:white;"></div>';
  if (editingTarjetaId) {
    const { error } = await sb.from('tarjetas').update({ banco, nombre, digitos, color: selectedColor }).eq('id', editingTarjetaId);
    if (error) { showToast('Error al actualizar', 'error'); }
    else { Object.assign(tarjetas.find(t => t.id === editingTarjetaId), { banco, nombre, digitos, color: selectedColor }); closeModal('modal-tarjeta'); renderTarjetas(); showToast('Tarjeta actualizada'); }
  } else {
    const { data, error } = await sb.from('tarjetas').insert([{ banco, nombre, digitos, color: selectedColor }]).select();
    if (error) { showToast('Error al guardar', 'error'); }
    else { tarjetas.push(data[0]); closeModal('modal-tarjeta'); renderTarjetas(); showToast('Tarjeta creada'); }
  }
  btn.disabled = false; btn.innerHTML = 'Guardar tarjeta';
}

async function deleteTarjeta(id) {
  if (!confirm('Â¿Eliminar esta tarjeta y todos sus datos asociados?')) return;
  const { error } = await sb.from('tarjetas').delete().eq('id', id);
  if (error) { showToast('Error al eliminar', 'error'); return; }
  tarjetas = tarjetas.filter(t => t.id !== id);
  cierres = cierres.filter(c => c.tarjeta_id !== id);
  gastos = gastos.filter(g => g.tarjeta_id !== id);
  renderTarjetas();
  document.getElementById('cierres-panel').classList.remove('open');
  showToast('Tarjeta eliminada');
}

function selectColor(el) {
  selectedColor = el.dataset.color;
  document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
  el.classList.add('selected');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CIERRES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openCierres(tid) {
  const t = tarjetas.find(t => t.id === tid);
  document.getElementById('cierres-title').textContent = `${t.banco} â€” ${t.nombre}`;
  const panel = document.getElementById('cierres-panel');
  panel.classList.add('open'); panel.dataset.tid = tid;
  renderCierresGrid(tid);
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderCierresGrid(tid) {
  const now = new Date();
  const MESES = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  let html = '';
  for (let o = -3; o <= 9; o++) {
    const d = new Date(now.getFullYear(), now.getMonth() + o, 1);
    const mk = getMonthKey(d.getFullYear(), d.getMonth());
    const cierre = cierres.find(c => c.tarjeta_id === tid && c.mes_key === mk);
    const dia = cierre ? cierre.dia : '';
    html += `<div class="cierre-cell">
      <div class="cierre-month">${MESES[d.getMonth()]} ${d.getFullYear()}</div>
      <div class="cierre-row">
        <input type="number" min="1" max="31" placeholder="â€”" style="width:64px;padding:7px 10px;font-size:14px;font-weight:600;" value="${dia}"
          onchange="saveCierre('${tid}','${mk}',this.value,'${cierre ? cierre.id : ''}')">
        <span class="cierre-val" id="cv-${mk}">${dia ? 'dÃ­a ' + dia : ''}</span>
      </div>
    </div>`;
  }
  document.getElementById('cierres-grid').innerHTML = html;
}

async function saveCierre(tid, mk, valor, existingId) {
  const dia = parseInt(valor);
  if (dia >= 1 && dia <= 31) {
    if (existingId) {
      const { error } = await sb.from('cierres').update({ dia }).eq('id', existingId);
      if (!error) { const c = cierres.find(c => c.id === existingId); if (c) c.dia = dia; const lbl = document.getElementById('cv-' + mk); if (lbl) lbl.textContent = 'dÃ­a ' + dia; }
    } else {
      const { data, error } = await sb.from('cierres').insert([{ tarjeta_id: tid, mes_key: mk, dia }]).select();
      if (!error) { cierres.push(data[0]); renderCierresGrid(tid); }
    }
    buildAllPeriods(); showToast('Cierre guardado');
  } else if (!valor && existingId) {
    await sb.from('cierres').delete().eq('id', existingId);
    cierres = cierres.filter(c => c.id !== existingId);
    renderCierresGrid(tid); buildAllPeriods();
  }
}

function closeCierres() { document.getElementById('cierres-panel').classList.remove('open'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function fmt(n) {
  if (!n) return '0';
  const r = Math.round(n * 100) / 100;
  return r % 1 === 0 ? r.toLocaleString('es-AR') : r.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatDate(d) {
  if (!d || isNaN(d)) return 'â€”';
  return `${d.getDate()} ${['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][d.getMonth()]} ${d.getFullYear()}`;
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = (type === 'success' ? 'âœ“  ' : 'âœ•  ') + msg;
  t.className = `toast show ${type}`;
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.className = 'toast', 3000);
}

document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); }));

init();
</script>
</body>
</html>
