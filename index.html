<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TarjetApp ¬∑ Gesti√≥n de Tarjetas</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg:        #F4F6F9;
  --canvas:    #FFFFFF;
  --s1:        #F0F3F8;
  --s2:        #E6EAF2;
  --border:    #DDE1EB;
  --border2:   #C8CEDB;

  --ink:       #0F172A;
  --ink2:      #334155;
  --ink3:      #64748B;
  --ink4:      #94A3B8;

  --green:     #0D7A5F;
  --green-lt:  #EAF5F1;
  --green-mid: #C6E8DE;
  --green-dk:  #085A45;
  --green-glow:rgba(13,122,95,.12);

  --slate:     #3B5BDB;
  --slate-lt:  #EEF2FF;

  --amber:     #B45309;
  --amber-lt:  #FFFBEB;

  --red:       #DC2626;
  --red-lt:    #FEF2F2;

  --r-xs: 6px;
  --r-sm: 8px;
  --r:    12px;
  --r-lg: 16px;
  --r-xl: 20px;

  --sh-xs: 0 1px 2px rgba(15,23,42,.05);
  --sh-sm: 0 1px 4px rgba(15,23,42,.06), 0 2px 8px rgba(15,23,42,.04);
  --sh:    0 4px 16px rgba(15,23,42,.08), 0 1px 4px rgba(15,23,42,.04);
  --sh-lg: 0 16px 40px rgba(15,23,42,.12), 0 4px 12px rgba(15,23,42,.06);

  --t: .14s ease;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { -webkit-font-smoothing: antialiased; scroll-behavior: smooth; }
body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--ink); font-size: 14px; line-height: 1.6; min-height: 100vh; }
input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { display: none; }
input[type=number] { -moz-appearance: textfield; }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.layout { display: flex; min-height: 100vh; }
.sidebar {
  width: 248px; background: var(--canvas); border-right: 1px solid var(--border);
  display: flex; flex-direction: column; padding: 0;
  flex-shrink: 0; position: fixed; top: 0; left: 0; bottom: 0; z-index: 40;
  box-shadow: var(--sh-xs);
}
.sidebar-brand {
  padding: 22px 20px 20px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
}
.brand-icon {
  width: 38px; height: 38px; background: var(--green); border-radius: var(--r-sm);
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.brand-icon svg { width: 20px; height: 20px; }
.brand-name { font-size: 15px; font-weight: 700; color: var(--ink); letter-spacing: -.3px; }
.brand-name span { color: var(--green); }
.brand-sub { font-size: 11px; color: var(--ink4); margin-top: 1px; }

.nav-wrap { padding: 16px 12px; flex: 1; overflow-y: auto; }
.nav-group-label { font-size: 10px; font-weight: 700; letter-spacing: 1.2px; text-transform: uppercase; color: var(--ink4); padding: 0 10px; margin: 16px 0 6px; }
.nav-group-label:first-child { margin-top: 0; }
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 10px; border-radius: var(--r-sm); cursor: pointer;
  color: var(--ink3); font-size: 13.5px; font-weight: 500;
  transition: all var(--t); user-select: none;
  border: none; background: none; width: 100%; text-align: left;
  margin-bottom: 2px;
}
.nav-item:hover { background: var(--s1); color: var(--ink2); }
.nav-item.active { background: var(--green-lt); color: var(--green-dk); font-weight: 600; }
.nav-icon {
  width: 30px; height: 30px; border-radius: var(--r-xs);
  display: flex; align-items: center; justify-content: center; font-size: 15px;
  flex-shrink: 0; background: var(--s1); transition: background var(--t);
}
.nav-item.active .nav-icon { background: var(--green-mid); }

.sidebar-foot {
  padding: 14px 20px; border-top: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
}
.sync-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--ink4); flex-shrink: 0; transition: background .5s; }
.sync-label { font-size: 11.5px; color: var(--ink4); }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main { margin-left: 248px; min-height: 100vh; display: flex; flex-direction: column; }
.topbar {
  height: 62px; background: var(--canvas); border-bottom: 1px solid var(--border);
  padding: 0 32px; display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 30; flex-shrink: 0;
}
.topbar-left { display: flex; flex-direction: column; }
.topbar-title { font-size: 15px; font-weight: 700; color: var(--ink); line-height: 1.2; }
.topbar-sub { font-size: 12px; color: var(--ink4); }
.topbar-actions { display: flex; gap: 10px; align-items: center; }

.content { flex: 1; padding: 28px 32px; }
.page { display: none; }
.page.active { display: block; animation: fadeUp .2s ease; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 9px 18px; border-radius: var(--r-sm); border: none;
  cursor: pointer; font-family: inherit; font-size: 13px; font-weight: 600;
  transition: all var(--t); white-space: nowrap; line-height: 1;
}
.btn-primary { background: var(--green); color: #fff; }
.btn-primary:hover { background: var(--green-dk); box-shadow: 0 4px 14px var(--green-glow); transform: translateY(-1px); }
.btn-secondary { background: var(--canvas); color: var(--ink2); border: 1px solid var(--border); box-shadow: var(--sh-xs); }
.btn-secondary:hover { background: var(--s1); border-color: var(--border2); }
.btn-danger { background: var(--red-lt); color: var(--red); border: 1px solid rgba(220,38,38,.18); }
.btn-danger:hover { background: #FECACA; }
.btn-sm { padding: 6px 13px; font-size: 12px; }
.btn-xs { padding: 4px 10px; font-size: 11px; }
.btn:disabled { opacity: .45; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

/* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
.section-hd { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 20px; gap: 16px; }
.section-hd-title { font-size: 16px; font-weight: 700; color: var(--ink); letter-spacing: -.2px; }
.section-hd-sub { font-size: 13px; color: var(--ink4); margin-top: 2px; }

/* ‚îÄ‚îÄ PERIOD NAVIGATOR ‚îÄ‚îÄ */
.period-nav {
  display: flex; align-items: stretch;
  background: var(--canvas); border: 1px solid var(--border);
  border-radius: var(--r-lg); box-shadow: var(--sh-sm);
  overflow: hidden; width: fit-content; margin-bottom: 24px;
}
.period-arrow {
  padding: 0 18px; background: none; border: none; cursor: pointer;
  color: var(--ink3); font-size: 18px; transition: all var(--t);
  display: flex; align-items: center; min-height: 56px;
}
.period-arrow:hover { background: var(--s1); color: var(--green); }
.period-mid {
  padding: 10px 28px; border-left: 1px solid var(--border); border-right: 1px solid var(--border);
  text-align: center; min-width: 230px; display: flex; flex-direction: column; justify-content: center;
}
.period-month {
  font-family: 'Instrument Serif', serif; font-size: 21px; color: var(--ink); line-height: 1.1;
}
.period-badge {
  display: inline-flex; align-items: center; gap: 4px; margin-top: 3px;
  font-size: 10.5px; font-weight: 600; text-transform: uppercase; letter-spacing: .7px; color: var(--ink4);
}
.period-badge.future { color: var(--green); }

/* ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ */
.stats-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px,1fr)); gap: 14px; margin-bottom: 24px; }
.stat-card {
  background: var(--canvas); border: 1px solid var(--border);
  border-radius: var(--r-lg); padding: 18px 20px; box-shadow: var(--sh-xs);
  transition: all var(--t); position: relative; overflow: hidden;
}
.stat-card.total-card { border-left: 3px solid var(--green); }
.stat-card.clickable { cursor: pointer; }
.stat-card.clickable:hover { border-color: var(--green-mid); box-shadow: var(--sh-sm); transform: translateY(-1px); }
.stat-card.selected { border-color: var(--green); background: var(--green-lt); }
.stat-card.selected::after { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:var(--green); }
.sc-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .8px; color: var(--ink4); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
.sc-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.sc-amount { font-family: 'Instrument Serif', serif; font-size: 26px; color: var(--ink); letter-spacing: -.3px; line-height: 1.1; }
.sc-amount.future { color: var(--green); }
.sc-sub { font-size: 11px; color: var(--ink4); margin-top: 5px; }
.sc-bar { height: 3px; background: var(--s2); border-radius: 2px; margin-top: 12px; overflow: hidden; }
.sc-bar-fill { height: 100%; border-radius: 2px; transition: width .6s cubic-bezier(.4,0,.2,1); }
.sc-hint { font-size: 10px; color: var(--green); margin-top: 8px; font-weight: 600; letter-spacing: .5px; }

/* ‚îÄ‚îÄ DETAIL CARD ‚îÄ‚îÄ */
.detail-card {
  background: var(--canvas); border: 1px solid var(--border);
  border-radius: var(--r-lg); box-shadow: var(--sh-sm); overflow: hidden;
}
.detail-card-head {
  padding: 18px 24px; display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid var(--border); background: var(--s1);
}
.detail-card-head-left { display: flex; align-items: center; gap: 14px; }
.detail-stripe { width: 4px; height: 36px; border-radius: 2px; flex-shrink: 0; }
.detail-bank { font-size: 15px; font-weight: 700; color: var(--ink); }
.detail-meta { font-size: 12px; color: var(--ink4); margin-top: 2px; }
.detail-amount { font-family: 'Instrument Serif', serif; font-size: 28px; color: var(--ink); letter-spacing: -.3px; text-align: right; }
.detail-amount.future { color: var(--green); }
.detail-tag { font-size: 11px; color: var(--ink4); text-align: right; text-transform: uppercase; letter-spacing: .6px; }

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-wrap { overflow: hidden; }
.data-table { width: 100%; border-collapse: collapse; }
.data-table th {
  text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase;
  letter-spacing: .8px; color: var(--ink4); padding: 11px 24px;
  border-bottom: 1px solid var(--border); background: var(--s1);
}
.data-table td { padding: 13px 24px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
.data-table tr:last-child td { border-bottom: none; }
.data-table tbody tr { transition: background var(--t); }
.data-table tbody tr:hover td { background: var(--s1); }
.data-table tfoot td { background: var(--green-lt); color: var(--green-dk); font-weight: 700; font-size: 13px; border-top: 1px solid var(--green-mid); }

.pill {
  display: inline-flex; align-items: center; padding: 3px 9px;
  border-radius: 20px; font-size: 11px; font-weight: 600;
}
.pill-green { background: var(--green-lt); color: var(--green-dk); }
.pill-blue  { background: var(--slate-lt); color: var(--slate); }
.pill-amber { background: var(--amber-lt); color: var(--amber); }
.pill-gray  { background: var(--s2); color: var(--ink3); }
.cc-pill    { color: #111; font-weight: 700; }

/* ‚îÄ‚îÄ CREDIT CARD VISUAL ‚îÄ‚îÄ */
.cc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap: 16px; margin-bottom: 28px; }
.cc-card {
  border-radius: var(--r-xl); padding: 24px; min-height: 168px;
  display: flex; flex-direction: column; justify-content: space-between;
  position: relative; overflow: hidden; cursor: pointer;
  transition: transform .22s ease, box-shadow .22s ease;
  box-shadow: var(--sh);
}
.cc-card:hover { transform: translateY(-4px) scale(1.01); box-shadow: var(--sh-lg); }
.cc-card::before {
  content: ''; position: absolute; width: 200px; height: 200px; border-radius: 50%;
  background: rgba(255,255,255,.1); top: -70px; right: -50px; pointer-events: none;
}
.cc-card::after {
  content: ''; position: absolute; width: 140px; height: 140px; border-radius: 50%;
  background: rgba(255,255,255,.06); bottom: -50px; right: 20px; pointer-events: none;
}
.cc-bank { font-weight: 800; font-size: 15px; color: rgba(0,0,0,.65); letter-spacing: .2px; }
.cc-name { font-size: 11px; color: rgba(0,0,0,.45); margin-top: 2px; }
.cc-chip { font-size: 22px; }
.cc-number { font-size: 13px; color: rgba(0,0,0,.55); letter-spacing: 3px; font-weight: 600; }
.cc-count { font-size: 11px; color: rgba(0,0,0,.4); margin-top: 4px; }
.cc-btns { display: flex; gap: 6px; margin-top: 8px; }
.cc-btn {
  padding: 4px 11px; border-radius: var(--r-xs); border: none; cursor: pointer;
  font-size: 11px; font-weight: 600; font-family: inherit;
  background: rgba(0,0,0,.18); color: rgba(0,0,0,.6); transition: background var(--t);
}
.cc-btn:hover { background: rgba(0,0,0,.28); }

/* ‚îÄ‚îÄ CIERRES PANEL ‚îÄ‚îÄ */
.cierres-panel {
  background: var(--canvas); border: 1px solid var(--border); border-radius: var(--r-lg);
  box-shadow: var(--sh-sm); margin-top: 20px; overflow: hidden;
  display: none;
}
.cierres-panel.open { display: block; animation: fadeUp .2s ease; }
.cierres-head {
  padding: 16px 24px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  background: var(--s1);
}
.cierres-title { font-size: 14px; font-weight: 700; color: var(--ink); }
.cierres-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(148px,1fr)); gap: 10px; padding: 20px 24px; }
.cierre-cell {
  background: var(--s1); border: 1px solid var(--border); border-radius: var(--r-sm); padding: 12px 14px;
  transition: border-color var(--t);
}
.cierre-cell:focus-within { border-color: var(--green); background: var(--green-lt); }
.cierre-month { font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--ink4); margin-bottom: 8px; }
.cierre-row { display: flex; align-items: center; gap: 8px; }
.cierre-val { font-size: 11px; color: var(--ink4); }

/* ‚îÄ‚îÄ FORMS & MODAL ‚îÄ‚îÄ */
.form-group { margin-bottom: 16px; }
.form-grid { display: grid; gap: 14px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.field-label {
  display: block; font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: .8px; color: var(--ink3); margin-bottom: 6px;
}
input, select {
  width: 100%; background: var(--s1); border: 1px solid var(--border);
  border-radius: var(--r-sm); padding: 10px 14px; color: var(--ink);
  font-family: inherit; font-size: 13.5px; outline: none;
  transition: border-color var(--t), background var(--t), box-shadow var(--t);
}
input:focus, select:focus { border-color: var(--green); background: var(--canvas); box-shadow: 0 0 0 3px var(--green-glow); }
select option { background: var(--canvas); }

.modal-overlay {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(15,23,42,.4); align-items: center; justify-content: center;
  backdrop-filter: blur(4px);
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--canvas); border: 1px solid var(--border);
  border-radius: var(--r-xl); padding: 0; width: 520px; max-width: 95vw;
  max-height: 92vh; overflow-y: auto;
  box-shadow: var(--sh-lg); animation: modalIn .2s cubic-bezier(.4,0,.2,1);
}
@keyframes modalIn { from { transform: scale(.96) translateY(12px); opacity: 0; } }
.modal-head {
  padding: 24px 28px 20px; border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: flex-start; position: sticky; top: 0; background: var(--canvas); z-index: 1;
}
.modal-eyebrow { font-size: 10px; font-weight: 700; letter-spacing: 1.2px; text-transform: uppercase; color: var(--green); margin-bottom: 3px; }
.modal-title { font-size: 18px; font-weight: 700; color: var(--ink); letter-spacing: -.3px; }
.modal-close {
  width: 30px; height: 30px; border-radius: 50%; background: var(--s1);
  border: none; cursor: pointer; font-size: 18px; color: var(--ink3);
  display: flex; align-items: center; justify-content: center;
  transition: all var(--t); flex-shrink: 0;
}
.modal-close:hover { background: var(--s2); color: var(--ink); }
.modal-body { padding: 24px 28px; }
.modal-foot { padding: 16px 28px 24px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid var(--border); }

/* ‚îÄ‚îÄ CUOTA PREVIEW ‚îÄ‚îÄ */
.cuota-preview {
  background: var(--green-lt); border: 1px solid var(--green-mid);
  border-left: 3px solid var(--green); border-radius: var(--r-sm); padding: 14px 16px;
}
.cuota-preview-title { font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--green); margin-bottom: 10px; }
.cuota-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(13,122,95,.1); font-size: 12.5px; }
.cuota-row:last-child { border-bottom: none; }
.cuota-row-label { color: var(--ink3); }
.cuota-row-val { font-weight: 700; color: var(--green-dk); }

/* ‚îÄ‚îÄ COLOR PICKER ‚îÄ‚îÄ */
.color-picker { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 4px; }
.color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: transform var(--t), border-color var(--t); }
.color-dot:hover { transform: scale(1.15); }
.color-dot.selected { border-color: var(--ink2); box-shadow: 0 0 0 2px white inset; }

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state { text-align: center; padding: 72px 24px; color: var(--ink4); }
.empty-icon { font-size: 44px; margin-bottom: 14px; opacity: .6; }
.empty-title { font-size: 16px; font-weight: 700; color: var(--ink3); margin-bottom: 6px; }
.empty-sub { font-size: 13px; }

/* ‚îÄ‚îÄ FILTER TABS ‚îÄ‚îÄ */
.filter-tabs { display: flex; gap: 0; background: var(--s1); border: 1px solid var(--border); border-radius: var(--r-sm); padding: 3px; width: fit-content; margin-bottom: 20px; }
.filter-tab { padding: 7px 16px; border-radius: var(--r-xs); cursor: pointer; font-size: 12.5px; font-weight: 600; color: var(--ink4); transition: all var(--t); border: none; background: none; font-family: inherit; }
.filter-tab.active { background: var(--canvas); color: var(--green); box-shadow: var(--sh-xs); }
.filter-tab:hover:not(.active) { color: var(--ink2); }

/* ‚îÄ‚îÄ LOADER / TOAST ‚îÄ‚îÄ */
.loader { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.3); border-top-color: #fff; border-radius: 50%; animation: spin .6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.toast {
  position: fixed; bottom: 24px; right: 24px; z-index: 999;
  background: var(--ink); color: #fff; border-radius: var(--r-sm);
  padding: 12px 18px; font-size: 13px; font-weight: 500;
  display: none; align-items: center; gap: 10px;
  box-shadow: var(--sh-lg); animation: fadeUp .2s ease;
  max-width: 320px;
}
.toast.show { display: flex; }
.toast.success { background: var(--green); }
.toast.error { background: var(--red); }

/* ‚îÄ‚îÄ LOADING SCREEN ‚îÄ‚îÄ */
.loading-screen {
  position: fixed; inset: 0; background: var(--canvas); z-index: 500;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
}
.loading-brand {
  display: flex; align-items: center; gap: 12px;
}
.loading-brand-icon { width: 48px; height: 48px; background: var(--green); border-radius: var(--r); display: flex; align-items: center; justify-content: center; }
.loading-brand-icon svg { width: 26px; height: 26px; }
.loading-name { font-size: 22px; font-weight: 800; color: var(--ink); letter-spacing: -.5px; }
.loading-bar-wrap { width: 160px; height: 3px; background: var(--s2); border-radius: 2px; overflow: hidden; }
.loading-bar { height: 100%; background: var(--green); border-radius: 2px; animation: loadBar 1.4s ease-in-out; }
@keyframes loadBar { from { width: 0; } to { width: 100%; } }
.loading-sub { font-size: 12px; color: var(--ink4); letter-spacing: .5px; }

/* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
.divider { height: 1px; background: var(--border); margin: 20px 0; }

/* ‚îÄ‚îÄ HINT BOX ‚îÄ‚îÄ */
.hint-box { background: var(--s1); border: 1px solid var(--border); border-radius: var(--r-sm); padding: 14px 18px; font-size: 13px; color: var(--ink3); text-align: center; }

@media (max-width: 768px) {
  .sidebar { width: 60px; }
  .brand-name, .brand-sub, .nav-item span:not(.nav-icon) { display: none; }
  .sidebar-brand { padding: 16px; justify-content: center; }
  .main { margin-left: 60px; }
  .content { padding: 20px 16px; }
  .topbar { padding: 0 20px; }
  .form-row { grid-template-columns: 1fr; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .period-mid { min-width: 160px; }
}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-screen" id="loading-screen">
  <div class="loading-brand">
    <div class="loading-brand-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/>
      </svg>
    </div>
    <div class="loading-name">TarjetApp</div>
  </div>
  <div class="loading-bar-wrap"><div class="loading-bar"></div></div>
  <div class="loading-sub">Conectando con base de datos‚Ä¶</div>
</div>

<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <div class="brand-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/>
        </svg>
      </div>
      <div>
        <div class="brand-name">Tarjet<span>App</span></div>
        <div class="brand-sub">Gesti√≥n de gastos</div>
      </div>
    </div>
    <div class="nav-wrap">
      <div class="nav-group-label">Principal</div>
      <button class="nav-item active" onclick="showPage('resumen',this)">
        <span class="nav-icon">üìä</span><span>Resumen</span>
      </button>
      <button class="nav-item" onclick="showPage('gastos',this)">
        <span class="nav-icon">üí≥</span><span>Gastos</span>
      </button>
      <div class="nav-group-label">Configuraci√≥n</div>
      <button class="nav-item" onclick="showPage('tarjetas',this)">
        <span class="nav-icon">üóÇÔ∏è</span><span>Tarjetas</span>
      </button>
    </div>
    <div class="sidebar-foot">
      <span class="sync-dot" id="sync-dot"></span>
      <span class="sync-label" id="sync-label">Conectando‚Ä¶</span>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <!-- TOPBAR -->
    <header class="topbar">
      <div class="topbar-left">
        <div class="topbar-title" id="topbar-title">Resumen</div>
        <div class="topbar-sub" id="topbar-sub">Per√≠odos de facturaci√≥n por tarjeta</div>
      </div>
      <div class="topbar-actions" id="topbar-actions"></div>
    </header>

    <div class="content">

      <!-- ‚ïê‚ïê‚ïê‚ïê RESUMEN ‚ïê‚ïê‚ïê‚ïê -->
      <div class="page active" id="page-resumen">
        <div class="period-nav">
          <button class="period-arrow" onclick="changePeriod(-1)">‚Äπ</button>
          <div class="period-mid">
            <div class="period-month" id="period-month">‚Äî</div>
            <div class="period-badge" id="period-badge">‚Äî</div>
          </div>
          <button class="period-arrow" onclick="changePeriod(1)">‚Ä∫</button>
        </div>
        <div class="stats-row" id="stats-row"></div>
        <div id="detail-area"></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê GASTOS ‚ïê‚ïê‚ïê‚ïê -->
      <div class="page" id="page-gastos">
        <div class="filter-tabs">
          <button class="filter-tab active" onclick="filterGastos('todos',this)">Todos</button>
          <button class="filter-tab" onclick="filterGastos('pendientes',this)">Pendientes</button>
          <button class="filter-tab" onclick="filterGastos('pasados',this)">Pasados</button>
        </div>
        <div class="detail-card">
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Descripci√≥n</th><th>Tarjeta</th><th>Fecha compra</th>
                  <th style="text-align:right;">Monto total</th><th>Cuotas</th>
                  <th style="width:90px;"></th>
                </tr>
              </thead>
              <tbody id="gastos-tbody"></tbody>
            </table>
            <div id="gastos-empty" class="empty-state" style="display:none;">
              <div class="empty-icon">üõçÔ∏è</div>
              <div class="empty-title">Sin gastos registrados</div>
              <div class="empty-sub">Us√° el bot√≥n "Nuevo gasto" para empezar a registrar</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê TARJETAS ‚ïê‚ïê‚ïê‚ïê -->
      <div class="page" id="page-tarjetas">
        <div class="cc-grid" id="cc-grid"></div>
        <div id="tarjetas-empty" class="empty-state" style="display:none;">
          <div class="empty-icon">üí≥</div>
          <div class="empty-title">Sin tarjetas configuradas</div>
          <div class="empty-sub">Agreg√° tu primera tarjeta para comenzar</div>
        </div>
        <div class="cierres-panel" id="cierres-panel">
          <div class="cierres-head">
            <div>
              <div style="font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--green);margin-bottom:2px;">Fechas de cierre</div>
              <div class="cierres-title" id="cierres-title">‚Äî</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="closeCierres()">‚úï Cerrar</button>
          </div>
          <div class="cierres-grid" id="cierres-grid"></div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /layout -->

<!-- MODAL TARJETA -->
<div class="modal-overlay" id="modal-tarjeta">
  <div class="modal">
    <div class="modal-head">
      <div>
        <div class="modal-eyebrow" id="mt-eyebrow">Nueva tarjeta</div>
        <div class="modal-title" id="mt-title">Agregar tarjeta</div>
      </div>
      <button class="modal-close" onclick="closeModal('modal-tarjeta')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div><label class="field-label">Banco / Emisor</label><input type="text" id="tc-banco" placeholder="Ej: Galicia, BBVA, Santander‚Ä¶"></div>
        <div><label class="field-label">Nombre de la tarjeta</label><input type="text" id="tc-nombre" placeholder="Ej: Visa Gold, Mastercard‚Ä¶"></div>
        <div><label class="field-label">√öltimos 4 d√≠gitos (opcional)</label><input type="text" id="tc-digitos" maxlength="4" placeholder="1234"></div>
        <div>
          <label class="field-label">Color de la tarjeta</label>
          <div class="color-picker" id="color-picker">
            <div class="color-dot selected" style="background:#16A34A" data-color="#16A34A" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#0EA5E9" data-color="#0EA5E9" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#7C3AED" data-color="#7C3AED" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#F59E0B" data-color="#F59E0B" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#EF4444" data-color="#EF4444" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#EC4899" data-color="#EC4899" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#0F766E" data-color="#0F766E" onclick="selectColor(this)"></div>
            <div class="color-dot" style="background:#475569" data-color="#475569" onclick="selectColor(this)"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('modal-tarjeta')">Cancelar</button>
      <button class="btn btn-primary" id="btn-save-tarjeta" onclick="saveTarjeta()">Guardar tarjeta</button>
    </div>
  </div>
</div>

<!-- MODAL GASTO -->
<div class="modal-overlay" id="modal-gasto">
  <div class="modal">
    <div class="modal-head">
      <div>
        <div class="modal-eyebrow" id="mg-eyebrow">Nuevo gasto</div>
        <div class="modal-title" id="mg-title">Registrar compra</div>
      </div>
      <button class="modal-close" onclick="closeModal('modal-gasto')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div><label class="field-label">Descripci√≥n</label><input type="text" id="g-desc" placeholder="Ej: Supermercado, Netflix, Ropa‚Ä¶"></div>
        <div class="form-row">
          <div><label class="field-label">Tarjeta</label><select id="g-tarjeta" onchange="previewCuotas()"></select></div>
          <div><label class="field-label">Fecha de compra</label><input type="date" id="g-fecha" onchange="previewCuotas()"></div>
        </div>
        <div class="form-row">
          <div><label class="field-label">Monto total ($)</label><input type="number" id="g-monto" placeholder="0,00" min="0" step="0.01" oninput="previewCuotas()"></div>
          <div><label class="field-label">Cantidad de cuotas</label><input type="number" id="g-cuotas" value="1" min="1" max="60" oninput="previewCuotas()"></div>
        </div>
        <div id="cuotas-preview-wrap" style="display:none;">
          <div class="cuota-preview">
            <div class="cuota-preview-title">Distribuci√≥n de cuotas</div>
            <div id="cuotas-preview-content"></div>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label class="field-label">Categor√≠a (opcional)</label>
            <select id="g-categoria">
              <option value="">Sin categor√≠a</option>
              <option>üõí Supermercado</option><option>üçΩÔ∏è Restaurantes</option>
              <option>‚õΩ Combustible</option><option>üè• Salud</option>
              <option>‚úàÔ∏è Viajes</option><option>üé¨ Entretenimiento</option>
              <option>üëó Ropa</option><option>üè† Hogar</option>
              <option>üì± Tecnolog√≠a</option><option>üíº Trabajo</option>
              <option>üéì Educaci√≥n</option><option>Otro</option>
            </select>
          </div>
          <div><label class="field-label">Nota (opcional)</label><input type="text" id="g-nota" placeholder="Detalle adicional‚Ä¶"></div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('modal-gasto')">Cancelar</button>
      <button class="btn btn-primary" id="btn-save-gasto" onclick="saveGasto()">Registrar gasto</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SUPABASE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SURL = 'https://ndiunufkwvgyrbtqctwp.supabase.co';
const SKEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXVudWZrd3ZneXJidHFjdHdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDE3NDksImV4cCI6MjA4NzE3Nzc0OX0.jwry-uF9hstCHLrQyq4OfeGfarsxBaxich6enVOLR2U';
const sb = supabase.createClient(SURL, SKEY);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let tarjetas = [], cierres = [], gastos = [];
let selectedColor = '#16A34A';
let editingTarjetaId = null;
let editingGastoId = null;
let gastoFilter = 'todos';
let allPeriods = [], currentPeriodIdx = 0;
let selectedTarjetaId = null;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function init() {
  try {
    const [t, c, g] = await Promise.all([
      sb.from('tarjetas').select('*').order('created_at'),
      sb.from('cierres').select('*'),
      sb.from('gastos').select('*').order('created_at', { ascending: false }),
    ]);
    if (t.error || c.error || g.error) throw new Error();
    tarjetas = t.data; cierres = c.data; gastos = g.data;
    setSyncStatus(true);
  } catch {
    setSyncStatus(false);
    showToast('Error al conectar con la base de datos', 'error');
  }
  setTimeout(() => {
    const ls = document.getElementById('loading-screen');
    ls.style.transition = 'opacity .4s'; ls.style.opacity = '0';
    setTimeout(() => ls.style.display = 'none', 400);
  }, 1200);
  buildAllPeriods(); setCurrentPeriod(); renderResumen();
}

function setSyncStatus(ok) {
  document.getElementById('sync-dot').style.background = ok ? '#16A34A' : '#DC2626';
  document.getElementById('sync-label').textContent = ok ? 'Sincronizado' : 'Sin conexi√≥n';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NAVIGATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const PAGE_META = {
  resumen:  { title: 'Resumen',  sub: 'Per√≠odos de facturaci√≥n por tarjeta', action: null },
  gastos:   { title: 'Gastos',   sub: 'Registr√° cada compra, en una o m√°s cuotas', action: () => `<button class="btn btn-primary" onclick="openModalGasto()">Ôºã Nuevo gasto</button>` },
  tarjetas: { title: 'Tarjetas', sub: 'Configur√° tus tarjetas y fechas de cierre', action: () => `<button class="btn btn-primary" onclick="openModalTarjeta()">Ôºã Nueva tarjeta</button>` },
};

function showPage(name, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  el.classList.add('active');
  const meta = PAGE_META[name];
  document.getElementById('topbar-title').textContent = meta.title;
  document.getElementById('topbar-sub').textContent = meta.sub;
  document.getElementById('topbar-actions').innerHTML = meta.action ? meta.action() : '';
  window.scrollTo({ top: 0 });
  if (name === 'resumen') renderResumen();
  if (name === 'gastos') renderGastos();
  if (name === 'tarjetas') renderTarjetas();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PERIOD LOGIC
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getMonthKey(y, m) { return `${y}-${String(m + 1).padStart(2, '0')}`; }
function nextMk(mk) { const [y, m] = mk.split('-').map(Number); const d = new Date(y, m, 1); return getMonthKey(d.getFullYear(), d.getMonth()); }
function getCierreDia(tid, mk) { const c = cierres.find(c => c.tarjeta_id === tid && c.mes_key === mk); return c ? c.dia : null; }

function getCierreForFecha(tid, fechaStr) {
  const fc = new Date(fechaStr + 'T12:00:00');
  for (let i = 0; i < 36; i++) {
    const d = new Date(fc.getFullYear(), fc.getMonth() + i, 1);
    const mk = getMonthKey(d.getFullYear(), d.getMonth());
    const dia = getCierreDia(tid, mk);
    if (!dia) continue;
    if (new Date(d.getFullYear(), d.getMonth(), dia) >= fc) return mk;
  }
  return getMonthKey(fc.getFullYear(), fc.getMonth());
}

function getCuotasPorPeriodo(g) {
  const r = {};
  const mk0 = getCierreForFecha(g.tarjeta_id, g.fecha);
  if (!mk0) return r;
  const cm = g.monto / g.cuotas;
  let mk = mk0;
  for (let i = 0; i < g.cuotas; i++) { r[mk] = (r[mk] || 0) + cm; mk = nextMk(mk); }
  return r;
}

function getPeriodRange(tid, mk) {
  const [y, m] = mk.split('-').map(Number);
  const dA = getCierreDia(tid, mk);
  const d = new Date(y, m - 1, 1);
  const mkP = getMonthKey(d.getFullYear(), d.getMonth() - 1);
  const dP = getCierreDia(tid, mkP);
  if (dA && dP) return { desde: new Date(d.getFullYear(), d.getMonth() - 1, dP + 1), hasta: new Date(d.getFullYear(), d.getMonth(), dA), exacto: true };
  return { desde: new Date(y, m - 1, 1), hasta: new Date(y, m, 0), exacto: false };
}

function buildAllPeriods() {
  const now = new Date();
  const mkNow = getMonthKey(now.getFullYear(), now.getMonth());
  const mk2back = getMonthKey(now.getFullYear(), now.getMonth() - 2);
  const res = new Set();
  cierres.forEach(c => { if (c.mes_key >= mk2back && c.mes_key <= mkNow) res.add(c.mes_key); });
  gastos.forEach(g => {
    const dist = getCuotasPorPeriodo(g);
    Object.keys(dist).forEach(mk => { if (mk > mkNow) res.add(mk); });
  });
  allPeriods = [...res].sort();
}

function setCurrentPeriod() {
  if (!allPeriods.length) return;
  const now = new Date();
  const mkN = getMonthKey(now.getFullYear(), now.getMonth());
  const idx = allPeriods.indexOf(mkN);
  currentPeriodIdx = idx >= 0 ? idx : allPeriods.length - 1;
}

function changePeriod(dir) {
  currentPeriodIdx = Math.max(0, Math.min(allPeriods.length - 1, currentPeriodIdx + dir));
  selectedTarjetaId = null;
  renderResumen();
}

function mkToLabel(mk) {
  const [y, m] = mk.split('-').map(Number);
  return ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][m - 1] + ' ' + y;
}
function mkToShort(mk) {
  const [y, m] = mk.split('-').map(Number);
  return ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][m - 1] + ' ' + y;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RESUMEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderResumen() {
  buildAllPeriods();
  const statsEl = document.getElementById('stats-row');
  const detailEl = document.getElementById('detail-area');

  if (!tarjetas.length) {
    document.getElementById('period-month').textContent = '‚Äî';
    document.getElementById('period-badge').textContent = '‚Äî';
    statsEl.innerHTML = '';
    detailEl.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-title">Sin tarjetas configuradas</div><div class="empty-sub">And√° a Tarjetas y configur√° tus primeras tarjetas</div></div>';
    return;
  }
  if (!allPeriods.length) {
    document.getElementById('period-month').textContent = '‚Äî';
    document.getElementById('period-badge').textContent = '‚Äî';
    statsEl.innerHTML = '';
    detailEl.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÖ</div><div class="empty-title">Sin per√≠odos disponibles</div><div class="empty-sub">Configur√° fechas de cierre o carg√° gastos para ver per√≠odos</div></div>';
    return;
  }

  if (currentPeriodIdx >= allPeriods.length) currentPeriodIdx = allPeriods.length - 1;
  const mk = allPeriods[currentPeriodIdx];
  const [y, m] = mk.split('-').map(Number);
  const esFuturo = new Date(y, m - 1, 28) > new Date();

  document.getElementById('period-month').textContent = mkToLabel(mk);
  const badge = document.getElementById('period-badge');
  badge.textContent = esFuturo ? '‚Üó Per√≠odo futuro ‚Äî estimado' : '‚úì Per√≠odo en curso o cerrado';
  badge.className = 'period-badge' + (esFuturo ? ' future' : '');

  let totalGeneral = 0;
  const perTarjeta = tarjetas.map(t => {
    let total = 0; const gEP = [];
    gastos.forEach(g => {
      if (g.tarjeta_id !== t.id) return;
      const dist = getCuotasPorPeriodo(g);
      if (dist[mk]) { total += dist[mk]; gEP.push({ g, monto: dist[mk] }); }
    });
    totalGeneral += total;
    return { t, total, gEP, range: getPeriodRange(t.id, mk) };
  });

  // Stats cards
  let sHTML = `
    <div class="stat-card total-card">
      <div class="sc-label">Total del per√≠odo</div>
      <div class="sc-amount${esFuturo ? ' future' : ''}">$${fmt(totalGeneral)}</div>
      <div class="sc-sub">${esFuturo ? 'üìÖ Monto estimado' : '‚úÖ Monto facturado'}</div>
    </div>`;

  perTarjeta.forEach(({ t, total }) => {
    const pct = totalGeneral ? Math.round(total / totalGeneral * 100) : 0;
    const isSel = selectedTarjetaId === t.id;
    sHTML += `
      <div class="stat-card clickable${isSel ? ' selected' : ''}" onclick="selectTarjeta('${t.id}')">
        <div class="sc-label"><span class="sc-dot" style="background:${t.color}"></span>${t.banco}</div>
        <div class="sc-amount${esFuturo ? ' future' : ''}">$${fmt(total)}</div>
        <div class="sc-bar"><div class="sc-bar-fill" style="width:${pct}%;background:${t.color}"></div></div>
        <div class="sc-sub">${pct}% del total</div>
        <div class="sc-hint">${isSel ? '‚ñ≤ Ocultar detalle' : '‚ñº Ver detalle'}</div>
      </div>`;
  });
  statsEl.innerHTML = sHTML;

  // Detail
  if (!selectedTarjetaId) {
    detailEl.innerHTML = '<div class="hint-box">Seleccion√° una tarjeta para ver el detalle de sus gastos en este per√≠odo</div>';
    return;
  }
  const item = perTarjeta.find(x => x.t.id === selectedTarjetaId);
  if (!item) { detailEl.innerHTML = ''; return; }
  const { t, total, gEP, range } = item;
  const rangoStr = range.exacto
    ? `${formatDate(range.desde)} ‚Üí ${formatDate(range.hasta)}`
    : `${formatDate(range.desde)} ‚Üí ${formatDate(range.hasta)} <span style="color:var(--ink4);font-size:11px;">(mes completo)</span>`;

  const rows = gEP.map(({ g, monto }) => {
    const cn = Object.keys(getCuotasPorPeriodo(g)).sort().indexOf(mk) + 1;
    const isSingle = g.cuotas === 1;
    const pillClass = isSingle ? 'pill-green' : 'pill-blue';
    return `<tr>
      <td>
        <div style="font-weight:600;">${g.categoria ? g.categoria + ' ' : ''}${g.descripcion}</div>
        ${g.nota ? `<div style="font-size:11px;color:var(--ink4);margin-top:2px;">${g.nota}</div>` : ''}
      </td>
      <td style="color:var(--ink3);">${formatDate(new Date(g.fecha + 'T12:00:00'))}</td>
      <td><span class="pill ${pillClass}">${isSingle ? '1 pago' : `${cn} / ${g.cuotas}`}</span></td>
      <td style="text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">$${fmt(monto)}</td>
    </tr>`;
  }).join('');

  detailEl.innerHTML = `
    <div class="detail-card" style="border-top:3px solid ${t.color};">
      <div class="detail-card-head">
        <div class="detail-card-head-left">
          <div class="detail-stripe" style="background:${t.color};"></div>
          <div>
            <div class="detail-bank">${t.banco} <span style="font-weight:400;color:var(--ink4);">‚Äî ${t.nombre}${t.digitos ? ' ¬∑¬∑¬∑¬∑ ' + t.digitos : ''}</span></div>
            <div class="detail-meta">Per√≠odo: ${rangoStr}</div>
          </div>
        </div>
        <div>
          <div class="detail-amount${esFuturo ? ' future' : ''}">$${fmt(total)}</div>
          <div class="detail-tag">${esFuturo ? 'estimado' : 'facturado'}</div>
        </div>
      </div>
      ${gEP.length ? `
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr>
              <th>Concepto</th><th>Fecha compra</th><th>Cuotas</th>
              <th style="text-align:right;">Monto</th>
            </tr></thead>
            <tbody>${rows}</tbody>
            <tfoot><tr>
              <td colspan="3" style="font-size:11px;text-transform:uppercase;letter-spacing:.8px;">Total tarjeta</td>
              <td style="text-align:right;">$${fmt(total)}</td>
            </tr></tfoot>
          </table>
        </div>` : `<div style="padding:20px 24px;color:var(--ink4);font-size:13px;">Sin gastos registrados en este per√≠odo.</div>`}
    </div>`;
}

function selectTarjeta(tid) {
  selectedTarjetaId = selectedTarjetaId === tid ? null : tid;
  renderResumen();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GASTOS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderGastos() {
  const tbody = document.getElementById('gastos-tbody');
  const empty = document.getElementById('gastos-empty');
  const now = new Date();
  let lista = [...gastos];

  if (gastoFilter === 'pendientes') lista = lista.filter(g => {
    const mks = Object.keys(getCuotasPorPeriodo(g)).sort();
    if (!mks.length) return true;
    const [y, m] = mks[mks.length - 1].split('-').map(Number);
    return new Date(y, m - 1, 28) >= now;
  });
  else if (gastoFilter === 'pasados') lista = lista.filter(g => {
    const mks = Object.keys(getCuotasPorPeriodo(g)).sort();
    if (!mks.length) return false;
    const [y, m] = mks[mks.length - 1].split('-').map(Number);
    return new Date(y, m - 1, 28) < now;
  });

  if (!lista.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  tbody.innerHTML = lista.map(g => {
    const t = tarjetas.find(t => t.id === g.tarjeta_id);
    const montoCuota = g.monto / g.cuotas;
    return `<tr>
      <td>
        <div style="font-weight:600;">${g.categoria ? g.categoria + ' ' : ''}${g.descripcion}</div>
        ${g.nota ? `<div style="font-size:11px;color:var(--ink4);margin-top:2px;">${g.nota}</div>` : ''}
      </td>
      <td>${t ? `<span class="pill cc-pill" style="background:${t.color}20;color:${t.color};border:1px solid ${t.color}40;">${t.banco}</span>` : '‚Äî'}</td>
      <td style="color:var(--ink3);">${formatDate(new Date(g.fecha + 'T12:00:00'))}</td>
      <td style="text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">$${fmt(g.monto)}</td>
      <td><span class="pill pill-gray">${g.cuotas > 1 ? `${g.cuotas}√ó $${fmt(montoCuota)}` : '1 pago'}</span></td>
      <td>
        <div style="display:flex;gap:6px;justify-content:flex-end;">
          <button class="btn btn-secondary btn-xs" onclick="openModalEditGasto('${g.id}')" title="Editar">‚úè</button>
          <button class="btn btn-danger btn-xs" onclick="deleteGasto('${g.id}')" title="Eliminar">‚úï</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function filterGastos(f, el) {
  gastoFilter = f;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderGastos();
}

function openModalGasto() {
  if (!tarjetas.length) { showToast('Primero agreg√° una tarjeta', 'error'); return; }
  editingGastoId = null;
  document.getElementById('mg-eyebrow').textContent = 'Nuevo gasto';
  document.getElementById('mg-title').textContent = 'Registrar compra';
  document.getElementById('btn-save-gasto').textContent = 'Registrar gasto';
  document.getElementById('g-tarjeta').innerHTML = tarjetas.map(t => `<option value="${t.id}">${t.banco} ‚Äì ${t.nombre}</option>`).join('');
  document.getElementById('g-fecha').value = new Date().toISOString().split('T')[0];
  ['g-monto', 'g-desc', 'g-nota'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('g-cuotas').value = 1;
  document.getElementById('g-categoria').value = '';
  document.getElementById('cuotas-preview-wrap').style.display = 'none';
  openModal('modal-gasto');
}

function openModalEditGasto(id) {
  const g = gastos.find(g => g.id === id); if (!g) return;
  editingGastoId = id;
  document.getElementById('mg-eyebrow').textContent = 'Editar gasto';
  document.getElementById('mg-title').textContent = 'Modificar compra';
  document.getElementById('btn-save-gasto').textContent = 'Guardar cambios';
  document.getElementById('g-tarjeta').innerHTML = tarjetas.map(t => `<option value="${t.id}"${t.id === g.tarjeta_id ? ' selected' : ''}>${t.banco} ‚Äì ${t.nombre}</option>`).join('');
  document.getElementById('g-desc').value = g.descripcion;
  document.getElementById('g-fecha').value = g.fecha;
  document.getElementById('g-monto').value = g.monto;
  document.getElementById('g-cuotas').value = g.cuotas;
  document.getElementById('g-categoria').value = g.categoria || '';
  document.getElementById('g-nota').value = g.nota || '';
  previewCuotas();
  openModal('modal-gasto');
}

function previewCuotas() {
  const cuotas = parseInt(document.getElementById('g-cuotas').value) || 1;
  const monto = parseFloat(document.getElementById('g-monto').value) || 0;
  const tid = document.getElementById('g-tarjeta').value;
  const fecha = document.getElementById('g-fecha').value;
  const wrap = document.getElementById('cuotas-preview-wrap');
  if (cuotas <= 1 || !monto || !fecha || !tid) { wrap.style.display = 'none'; return; }
  const dist = getCuotasPorPeriodo({ tarjeta_id: tid, fecha, monto, cuotas });
  const mks = Object.keys(dist).sort();
  if (!mks.length) { wrap.style.display = 'none'; return; }
  document.getElementById('cuotas-preview-content').innerHTML = mks.map((mk, i) =>
    `<div class="cuota-row">
      <span class="cuota-row-label">Cuota ${i + 1}/${cuotas} ¬∑ ${mkToShort(mk)}</span>
      <span class="cuota-row-val">$${fmt(monto / cuotas)}</span>
    </div>`
  ).join('');
  wrap.style.display = 'block';
}

async function saveGasto() {
  const descripcion = document.getElementById('g-desc').value.trim();
  const tarjeta_id = document.getElementById('g-tarjeta').value;
  const fecha = document.getElementById('g-fecha').value;
  const monto = parseFloat(document.getElementById('g-monto').value);
  const cuotas = parseInt(document.getElementById('g-cuotas').value) || 1;
  const categoria = document.getElementById('g-categoria').value;
  const nota = document.getElementById('g-nota').value.trim();
  if (!descripcion) { showToast('Ingres√° una descripci√≥n', 'error'); return; }
  if (!fecha) { showToast('Ingres√° la fecha', 'error'); return; }
  if (!monto || monto <= 0) { showToast('Ingres√° un monto v√°lido', 'error'); return; }
  const btn = document.getElementById('btn-save-gasto');
  const isEditing = !!editingGastoId;
  btn.disabled = true; btn.innerHTML = '<div class="loader"></div> Guardando‚Ä¶';
  if (isEditing) {
    const { data, error } = await sb.from('gastos').update({ descripcion, tarjeta_id, fecha, monto, cuotas, categoria, nota }).eq('id', editingGastoId).select();
    if (error) { showToast('Error al actualizar', 'error'); }
    else { const idx = gastos.findIndex(g => g.id === editingGastoId); if (idx >= 0) gastos[idx] = data[0]; closeModal('modal-gasto'); renderGastos(); buildAllPeriods(); showToast('Gasto actualizado'); }
  } else {
    const { data, error } = await sb.from('gastos').insert([{ descripcion, tarjeta_id, fecha, monto, cuotas, categoria, nota }]).select();
    if (error) { showToast('Error al guardar', 'error'); }
    else { gastos.unshift(data[0]); closeModal('modal-gasto'); renderGastos(); buildAllPeriods(); showToast('Gasto registrado'); }
  }
  btn.disabled = false; btn.innerHTML = isEditing ? 'Guardar cambios' : 'Registrar gasto';
}

async function deleteGasto(id) {
  if (!confirm('¬øEliminar este gasto?')) return;
  const { error } = await sb.from('gastos').delete().eq('id', id);
  if (error) { showToast('Error al eliminar', 'error'); return; }
  gastos = gastos.filter(g => g.id !== id);
  renderGastos();
  buildAllPeriods();
  showToast('Gasto eliminado');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TARJETAS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderTarjetas() {
  const grid = document.getElementById('cc-grid');
  const empty = document.getElementById('tarjetas-empty');
  if (!tarjetas.length) { grid.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  grid.innerHTML = tarjetas.map(t => {
    const count = cierres.filter(c => c.tarjeta_id === t.id).length;
    const bg = `linear-gradient(135deg, ${t.color} 0%, ${darken(t.color, 30)} 100%)`;
    return `<div class="cc-card" style="background:${bg};" onclick="openCierres('${t.id}')">
      <div><div class="cc-bank">${t.banco}</div><div class="cc-name">${t.nombre}</div></div>
      <div class="cc-chip">‚óº</div>
      <div>
        <div class="cc-number">${t.digitos ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + t.digitos : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</div>
        <div class="cc-count">${count} cierre${count !== 1 ? 's' : ''} configurado${count !== 1 ? 's' : ''}</div>
        <div class="cc-btns" onclick="event.stopPropagation()">
          <button class="cc-btn" onclick="openCierres('${t.id}')">üìÖ Cierres</button>
          <button class="cc-btn" onclick="editTarjeta('${t.id}')">‚úè Editar</button>
          <button class="cc-btn" onclick="deleteTarjeta('${t.id}')">‚úï</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function darken(hex, amount = 30) {
  try {
    const r = Math.max(0, parseInt(hex.slice(1, 3), 16) - amount);
    const g = Math.max(0, parseInt(hex.slice(3, 5), 16) - amount);
    const b = Math.max(0, parseInt(hex.slice(5, 7), 16) - amount);
    return `rgb(${r},${g},${b})`;
  } catch { return hex; }
}

function openModalTarjeta() {
  editingTarjetaId = null;
  document.getElementById('mt-eyebrow').textContent = 'Nueva tarjeta';
  document.getElementById('mt-title').textContent = 'Agregar tarjeta';
  ['tc-banco', 'tc-nombre', 'tc-digitos'].forEach(id => document.getElementById(id).value = '');
  selectedColor = '#16A34A';
  document.querySelectorAll('.color-dot').forEach(d => d.classList.toggle('selected', d.dataset.color === selectedColor));
  openModal('modal-tarjeta');
}

function editTarjeta(id) {
  const t = tarjetas.find(t => t.id === id); if (!t) return;
  editingTarjetaId = id;
  document.getElementById('mt-eyebrow').textContent = 'Editar tarjeta';
  document.getElementById('mt-title').textContent = 'Modificar tarjeta';
  document.getElementById('tc-banco').value = t.banco;
  document.getElementById('tc-nombre').value = t.nombre;
  document.getElementById('tc-digitos').value = t.digitos || '';
  selectedColor = t.color;
  document.querySelectorAll('.color-dot').forEach(d => d.classList.toggle('selected', d.dataset.color === t.color));
  openModal('modal-tarjeta');
}

async function saveTarjeta() {
  const banco = document.getElementById('tc-banco').value.trim();
  const nombre = document.getElementById('tc-nombre').value.trim();
  const digitos = document.getElementById('tc-digitos').value.trim();
  if (!banco) { showToast('Ingres√° el nombre del banco', 'error'); return; }
  if (!nombre) { showToast('Ingres√° el nombre de la tarjeta', 'error'); return; }
  const btn = document.getElementById('btn-save-tarjeta');
  btn.disabled = true; btn.innerHTML = '<div class="loader" style="border-top-color:white;"></div>';
  if (editingTarjetaId) {
    const { error } = await sb.from('tarjetas').update({ banco, nombre, digitos, color: selectedColor }).eq('id', editingTarjetaId);
    if (error) { showToast('Error al actualizar', 'error'); }
    else { Object.assign(tarjetas.find(t => t.id === editingTarjetaId), { banco, nombre, digitos, color: selectedColor }); closeModal('modal-tarjeta'); renderTarjetas(); showToast('Tarjeta actualizada'); }
  } else {
    const { data, error } = await sb.from('tarjetas').insert([{ banco, nombre, digitos, color: selectedColor }]).select();
    if (error) { showToast('Error al guardar', 'error'); }
    else { tarjetas.push(data[0]); closeModal('modal-tarjeta'); renderTarjetas(); showToast('Tarjeta creada'); }
  }
  btn.disabled = false; btn.innerHTML = 'Guardar tarjeta';
}

async function deleteTarjeta(id) {
  if (!confirm('¬øEliminar esta tarjeta y todos sus datos asociados?')) return;
  const { error } = await sb.from('tarjetas').delete().eq('id', id);
  if (error) { showToast('Error al eliminar', 'error'); return; }
  tarjetas = tarjetas.filter(t => t.id !== id);
  cierres = cierres.filter(c => c.tarjeta_id !== id);
  gastos = gastos.filter(g => g.tarjeta_id !== id);
  renderTarjetas();
  document.getElementById('cierres-panel').classList.remove('open');
  showToast('Tarjeta eliminada');
}

function selectColor(el) {
  selectedColor = el.dataset.color;
  document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
  el.classList.add('selected');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CIERRES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openCierres(tid) {
  const t = tarjetas.find(t => t.id === tid);
  document.getElementById('cierres-title').textContent = `${t.banco} ‚Äî ${t.nombre}`;
  const panel = document.getElementById('cierres-panel');
  panel.classList.add('open'); panel.dataset.tid = tid;
  renderCierresGrid(tid);
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderCierresGrid(tid) {
  const now = new Date();
  const MESES = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  let html = '';
  for (let o = -3; o <= 9; o++) {
    const d = new Date(now.getFullYear(), now.getMonth() + o, 1);
    const mk = getMonthKey(d.getFullYear(), d.getMonth());
    const cierre = cierres.find(c => c.tarjeta_id === tid && c.mes_key === mk);
    const dia = cierre ? cierre.dia : '';
    html += `<div class="cierre-cell">
      <div class="cierre-month">${MESES[d.getMonth()]} ${d.getFullYear()}</div>
      <div class="cierre-row">
        <input type="number" min="1" max="31" placeholder="‚Äî" style="width:64px;padding:7px 10px;font-size:14px;font-weight:600;" value="${dia}"
          onchange="saveCierre('${tid}','${mk}',this.value,'${cierre ? cierre.id : ''}')">
        <span class="cierre-val" id="cv-${mk}">${dia ? 'd√≠a ' + dia : ''}</span>
      </div>
    </div>`;
  }
  document.getElementById('cierres-grid').innerHTML = html;
}

async function saveCierre(tid, mk, valor, existingId) {
  const dia = parseInt(valor);
  if (dia >= 1 && dia <= 31) {
    if (existingId) {
      const { error } = await sb.from('cierres').update({ dia }).eq('id', existingId);
      if (!error) { const c = cierres.find(c => c.id === existingId); if (c) c.dia = dia; const lbl = document.getElementById('cv-' + mk); if (lbl) lbl.textContent = 'd√≠a ' + dia; }
    } else {
      const { data, error } = await sb.from('cierres').insert([{ tarjeta_id: tid, mes_key: mk, dia }]).select();
      if (!error) { cierres.push(data[0]); renderCierresGrid(tid); }
    }
    buildAllPeriods(); showToast('Cierre guardado');
  } else if (!valor && existingId) {
    await sb.from('cierres').delete().eq('id', existingId);
    cierres = cierres.filter(c => c.id !== existingId);
    renderCierresGrid(tid); buildAllPeriods();
  }
}

function closeCierres() { document.getElementById('cierres-panel').classList.remove('open'); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UTILS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function fmt(n) {
  if (!n) return '0';
  const r = Math.round(n * 100) / 100;
  return r % 1 === 0 ? r.toLocaleString('es-AR') : r.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatDate(d) {
  if (!d || isNaN(d)) return '‚Äî';
  return `${d.getDate()} ${['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][d.getMonth()]} ${d.getFullYear()}`;
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = (type === 'success' ? '‚úì  ' : '‚úï  ') + msg;
  t.className = `toast show ${type}`;
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.className = 'toast', 3000);
}

document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); }));

init();
</script>
</body>
</html>
