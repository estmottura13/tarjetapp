<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>TarjetApp</title>

<!-- PWA / Homescreen icon -->
<meta name="application-name" content="TarjetApp">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TarjetApp">
<meta name="theme-color" content="#09090f">
<meta name="mobile-web-app-capable" content="yes">

<!-- Inline SVG favicon (funciona en Android Chrome como Ã­cono de pestaÃ±a) -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='112' fill='%2309090f'/%3E%3Crect x='20' y='20' width='472' height='472' rx='96' fill='url(%23g)'/%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%237c3aed'/%3E%3Cstop offset='60%25' stop-color='%236366f1'/%3E%3Cstop offset='100%25' stop-color='%2306b6d4'/%3E%3C/linearGradient%3E%3Crect x='88' y='168' width='336' height='220' rx='28' fill='none' stroke='white' stroke-width='24'/%3E%3Crect x='88' y='222' width='336' height='52' fill='white'/%3E%3Crect x='116' y='316' width='80' height='20' rx='10' fill='rgba(255,255,255,.6)'/%3E%3Crect x='216' y='316' width='60' height='20' rx='10' fill='rgba(255,255,255,.4)'/%3E%3C/svg%3E">

<!-- Apple touch icon (192x192 SVG como PNG base64 inline) -->
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='112' fill='%2309090f'/%3E%3Crect x='20' y='20' width='472' height='472' rx='96' fill='url(%23g)'/%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%237c3aed'/%3E%3Cstop offset='60%25' stop-color='%236366f1'/%3E%3Cstop offset='100%25' stop-color='%2306b6d4'/%3E%3C/linearGradient%3E%3Crect x='88' y='168' width='336' height='220' rx='28' fill='none' stroke='white' stroke-width='24'/%3E%3Crect x='88' y='222' width='336' height='52' fill='white'/%3E%3Crect x='116' y='316' width='80' height='20' rx='10' fill='rgba(255,255,255,.6)'/%3E%3Crect x='216' y='316' width='60' height='20' rx='10' fill='rgba(255,255,255,.4)'/%3E%3C/svg%3E">

<!-- Web App Manifest inline -->
<script>
(function(){
  const manifest = {
    name: "TarjetApp",
    short_name: "TarjetApp",
    description: "GestiÃ³n de gastos con tarjetas de crÃ©dito",
    start_url: "./",
    display: "standalone",
    background_color: "#09090f",
    theme_color: "#7c3aed",
    orientation: "portrait",
    icons: [
      {
        src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='112' fill='%2309090f'/%3E%3Crect x='20' y='20' width='472' height='472' rx='96' fill='url(%23g)'/%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%237c3aed'/%3E%3Cstop offset='100%25' stop-color='%2306b6d4'/%3E%3C/linearGradient%3E%3Crect x='88' y='168' width='336' height='220' rx='28' fill='none' stroke='white' stroke-width='24'/%3E%3Crect x='88' y='222' width='336' height='52' fill='white'/%3E%3C/svg%3E",
        sizes: "512x512",
        type: "image/svg+xml",
        purpose: "any maskable"
      }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('link');
  link.rel = 'manifest'; link.href = url;
  document.head.appendChild(link);
})();
</script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â• TOKENS â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg:#09090f;
  --bg2:#0e0e1a;
  --bg3:#13131f;
  --surface:#16162a;
  --surface2:#1c1c32;
  --border:rgba(255,255,255,.07);
  --border2:rgba(255,255,255,.13);

  --text:#f0f0ff;
  --text2:#a8a8cc;
  --text3:#6060a0;

  --v:#7c3aed;   /* violet */
  --v2:#a855f7;
  --v3:#c084fc;
  --c:#06b6d4;   /* cyan */
  --c2:#22d3ee;
  --i:#6366f1;   /* indigo */
  --em:#10b981;  /* emerald */
  --em2:#34d399;
  --amber:#f59e0b;
  --red:#f43f5e;

  --grad-h: linear-gradient(135deg,#7c3aed 0%,#6366f1 40%,#06b6d4 100%);
  --grad-card: linear-gradient(145deg,rgba(255,255,255,.06) 0%,rgba(255,255,255,.02) 100%);
  --glow-v: 0 0 40px rgba(124,58,237,.35);
  --glow-c: 0 0 40px rgba(6,182,212,.35);
  --glow-em: 0 0 30px rgba(16,185,129,.3);

  --r-xs:6px; --r-sm:10px; --r:14px; --r-lg:18px; --r-xl:24px; --r-2xl:32px;
  --t:.18s cubic-bezier(.4,0,.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
body{
  font-family:'DM Sans',sans-serif;
  background:var(--bg);
  color:var(--text);
  font-size:14px;
  line-height:1.6;
  min-height:100vh;
  overflow-x:hidden;
  max-width:100vw;
}
/* Evitar que cualquier elemento desborde el viewport en mobile */
.page, .content, .main{max-width:100%;}
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{display:none;}
input[type=number]{-moz-appearance:textfield;}

/* â•â•â•â•â•â•â•â•â•â• NOISE OVERLAY â•â•â•â•â•â•â•â•â•â• */
body::before{
  content:'';position:fixed;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.03'/%3E%3C/svg%3E");
  pointer-events:none;z-index:0;opacity:.6;
}

/* â•â•â•â•â•â•â•â•â•â• AMBIENT ORBS â•â•â•â•â•â•â•â•â•â• */
.orb{position:fixed;border-radius:50%;filter:blur(80px);pointer-events:none;z-index:0;opacity:.18;}
.orb-1{width:600px;height:600px;background:radial-gradient(circle,#7c3aed,transparent 70%);top:-200px;left:-150px;}
.orb-2{width:500px;height:500px;background:radial-gradient(circle,#06b6d4,transparent 70%);bottom:-150px;right:-100px;}
.orb-3{width:400px;height:400px;background:radial-gradient(circle,#6366f1,transparent 70%);top:40%;left:30%;opacity:.1;}

/* â•â•â•â•â•â•â•â•â•â• LAYOUT â•â•â•â•â•â•â•â•â•â• */
.app{display:flex;min-height:100vh;position:relative;z-index:1;}

/* SIDEBAR */
.sidebar{
  width:260px;flex-shrink:0;
  background:linear-gradient(180deg,rgba(22,22,42,.95) 0%,rgba(14,14,26,.98) 100%);
  backdrop-filter:blur(24px);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  position:fixed;top:0;left:0;bottom:0;z-index:100;
  padding:0;
  transition:transform var(--t);
}
.sidebar-inner{
  display:flex;flex-direction:column;height:100%;padding:24px 16px;
  gap:0;
}
.brand{
  display:flex;align-items:center;gap:12px;
  padding:4px 8px 28px;
  border-bottom:1px solid var(--border);
  margin-bottom:20px;
}
.brand-logo{
  width:40px;height:40px;border-radius:12px;
  background:var(--grad-h);
  display:flex;align-items:center;justify-content:center;
  font-size:20px;flex-shrink:0;
  box-shadow:var(--glow-v);
}
.brand-name{font-family:'Outfit',sans-serif;font-size:18px;font-weight:800;letter-spacing:-.5px;}
.brand-name em{font-style:normal;background:var(--grad-h);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.brand-ver{font-size:10px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-top:1px;}

.nav-section-label{
  font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--text3);padding:0 8px;margin:8px 0 6px;
}
.nav-btn{
  display:flex;align-items:center;gap:12px;
  padding:11px 12px;border-radius:var(--r-sm);
  cursor:pointer;color:var(--text2);font-size:13.5px;font-weight:500;
  transition:all var(--t);border:none;background:none;
  font-family:'DM Sans',sans-serif;width:100%;text-align:left;
  margin-bottom:2px;position:relative;
}
.nav-btn:hover{background:rgba(255,255,255,.05);color:var(--text);}
.nav-btn.active{
  background:rgba(124,58,237,.15);color:#c084fc;font-weight:600;
  border:1px solid rgba(124,58,237,.25);
}
.nav-btn.active::before{
  content:'';position:absolute;left:0;top:6px;bottom:6px;width:3px;
  background:var(--grad-h);border-radius:0 3px 3px 0;
}
.nav-icon{
  width:32px;height:32px;border-radius:var(--r-xs);
  display:flex;align-items:center;justify-content:center;
  font-size:15px;flex-shrink:0;
  background:rgba(255,255,255,.05);
  transition:background var(--t);
}
.nav-btn.active .nav-icon{background:rgba(124,58,237,.2);}
.nav-label{flex:1;}
.nav-badge{
  font-size:10px;font-weight:700;background:rgba(124,58,237,.25);
  color:var(--v3);padding:2px 7px;border-radius:20px;
}

.sidebar-bottom{
  margin-top:auto;padding:16px 8px 0;
  border-top:1px solid var(--border);
}
.sync-chip{
  display:flex;align-items:center;gap:8px;
  padding:10px 12px;border-radius:var(--r-sm);
  background:rgba(255,255,255,.04);
}
.sync-led{width:8px;height:8px;border-radius:50%;background:var(--text3);transition:all .5s;}
.sync-led.ok{background:var(--em2);box-shadow:0 0 10px rgba(52,211,153,.6);}
.sync-led.err{background:var(--red);}
.sync-txt{font-size:12px;color:var(--text3);}

/* MAIN */
.main{flex:1;margin-left:260px;display:flex;flex-direction:column;min-height:100vh;}

/* TOPBAR */
.topbar{
  padding:18px 28px 14px;
  display:flex;align-items:flex-end;justify-content:space-between;
  flex-shrink:0;border-bottom:1px solid var(--border);
  background:rgba(9,9,15,.7);backdrop-filter:blur(20px);
  position:sticky;top:0;z-index:50;gap:12px;
}
.topbar-left{}
.tb-section{font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:2px;}
.tb-title{font-family:'Outfit',sans-serif;font-size:22px;font-weight:800;letter-spacing:-.5px;line-height:1.1;}
.tb-title span{background:var(--grad-h);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.topbar-actions{display:flex;gap:10px;align-items:center;}

.content{flex:1;padding:28px;max-width:1200px;width:100%;}
.page{display:none;}
.page.active{display:block;animation:fadeUp .25s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:none;}}

/* â•â•â•â•â•â•â•â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â• */
.btn{
  display:inline-flex;align-items:center;gap:7px;
  padding:10px 20px;border-radius:var(--r-sm);border:none;
  cursor:pointer;font-family:'DM Sans',sans-serif;
  font-size:13px;font-weight:600;transition:all var(--t);
  white-space:nowrap;line-height:1;position:relative;overflow:hidden;
}
.btn-primary{
  background:var(--grad-h);color:#fff;
  box-shadow:0 4px 20px rgba(124,58,237,.35);
}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(124,58,237,.5);}
.btn-primary::after{
  content:'';position:absolute;inset:0;background:rgba(255,255,255,.1);
  opacity:0;transition:opacity var(--t);
}
.btn-primary:hover::after{opacity:1;}
.btn-ghost{
  background:rgba(255,255,255,.06);color:var(--text2);
  border:1px solid var(--border2);
}
.btn-ghost:hover{background:rgba(255,255,255,.1);color:var(--text);}
.btn-danger{background:rgba(244,63,94,.15);color:#f87171;border:1px solid rgba(244,63,94,.25);}
.btn-danger:hover{background:rgba(244,63,94,.25);}
.btn-sm{padding:7px 14px;font-size:12px;}
.btn-xs{padding:5px 10px;font-size:11px;border-radius:var(--r-xs);}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important;box-shadow:none!important;}

/* â•â•â•â•â•â•â•â•â•â• PERIOD NAV â•â•â•â•â•â•â•â•â•â• */
.period-nav{
  display:flex;align-items:center;
  background:var(--surface);
  border:1px solid var(--border2);
  border-radius:var(--r-xl);
  overflow:hidden;width:fit-content;max-width:100%;margin-bottom:24px;
}
.period-arrow{
  padding:0 16px;background:none;border:none;cursor:pointer;
  color:var(--text3);font-size:22px;
  transition:all var(--t);display:flex;align-items:center;min-height:60px;
  font-family:'DM Sans',sans-serif;flex-shrink:0;
}
.period-arrow:hover{background:rgba(255,255,255,.05);color:var(--v3);}
.period-mid{
  padding:10px 20px;
  border-left:1px solid var(--border);
  border-right:1px solid var(--border);
  text-align:center;min-width:180px;
}
.period-month{
  font-family:'Outfit',sans-serif;font-size:22px;font-weight:800;
  background:var(--grad-h);-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  line-height:1.1;
}
.period-tag{font-size:11px;color:var(--text3);margin-top:3px;letter-spacing:.5px;}
.period-tag.future{color:var(--em2);}

/* â•â•â•â•â•â•â•â•â•â• STATS GRID â•â•â•â•â•â•â•â•â•â• */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-bottom:24px;}

.stat-card{
  background:var(--grad-card);
  backdrop-filter:blur(10px);
  border:1px solid var(--border);
  border-radius:var(--r-lg);
  padding:20px;
  transition:all var(--t);
  position:relative;overflow:hidden;
}
.stat-card::before{
  content:'';position:absolute;top:-60px;right:-60px;
  width:160px;height:160px;border-radius:50%;
  background:radial-gradient(circle,rgba(124,58,237,.12),transparent 70%);
  pointer-events:none;
}
.stat-card.total{
  border-color:rgba(124,58,237,.3);
  background:linear-gradient(145deg,rgba(124,58,237,.1),rgba(99,102,241,.05));
}
.stat-card.total::before{background:radial-gradient(circle,rgba(124,58,237,.2),transparent 70%);}
.stat-card.clickable{cursor:pointer;}
.stat-card.clickable:hover{border-color:var(--border2);transform:translateY(-3px);box-shadow:0 12px 32px rgba(0,0,0,.4);}
.stat-card.selected{
  border-color:rgba(124,58,237,.5);
  box-shadow:0 0 0 1px rgba(124,58,237,.3),0 12px 32px rgba(124,58,237,.15);
}
.stat-card.selected::after{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:var(--grad-h);
}
.sc-label{font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--text3);margin-bottom:10px;display:flex;align-items:center;gap:7px;}
.sc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.sc-amount{font-family:'DM Mono',monospace;font-size:26px;font-weight:500;letter-spacing:-.5px;line-height:1;}
.sc-amount.future{background:linear-gradient(90deg,var(--em),var(--c2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.sc-sub{font-size:11px;color:var(--text3);margin-top:6px;}
.sc-bar{height:3px;background:rgba(255,255,255,.07);border-radius:2px;margin-top:14px;overflow:hidden;}
.sc-bar-fill{height:100%;border-radius:2px;transition:width .7s cubic-bezier(.4,0,.2,1);}
.sc-hint{font-size:10px;color:var(--v3);margin-top:10px;font-weight:600;letter-spacing:.5px;}

/* â•â•â•â•â•â•â•â•â•â• DETAIL CARD â•â•â•â•â•â•â•â•â•â• */
.detail-glass{
  background:linear-gradient(145deg,rgba(22,22,42,.9),rgba(19,19,31,.95));
  border:1px solid var(--border2);border-radius:var(--r-xl);
  overflow:hidden;animation:fadeUp .2s ease;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.detail-head{
  padding:20px 24px;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:16px;
}
.detail-head-left{display:flex;align-items:center;gap:14px;}
.detail-stripe{width:4px;height:44px;border-radius:2px;flex-shrink:0;}
.detail-bank{font-family:'Outfit',sans-serif;font-size:16px;font-weight:800;letter-spacing:-.3px;}
.detail-meta{font-size:12px;color:var(--text3);margin-top:3px;}
.detail-amount{font-family:'DM Mono',monospace;font-size:28px;font-weight:500;letter-spacing:-.5px;text-align:right;}
.detail-amount.future{background:linear-gradient(90deg,var(--em),var(--c2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.detail-tag{font-size:10px;color:var(--text3);text-align:right;text-transform:uppercase;letter-spacing:.8px;margin-top:3px;}

/* â•â•â•â•â•â•â•â•â•â• TABLE â•â•â•â•â•â•â•â•â•â• */
.data-table{width:100%;border-collapse:collapse;table-layout:fixed;}
.data-table th{
  text-align:left;font-size:10px;font-weight:700;letter-spacing:1.2px;
  text-transform:uppercase;color:var(--text3);
  padding:11px 16px;
  border-bottom:1px solid var(--border);
  background:rgba(255,255,255,.02);
  white-space:nowrap;overflow:hidden;
}
.data-table td{
  padding:13px 16px;border-bottom:1px solid var(--border);
  font-size:13px;vertical-align:middle;
  overflow:hidden;
}
.data-table tr:last-child td{border-bottom:none;}
.data-table tbody tr{transition:background var(--t);}
.data-table tbody tr:hover td{background:rgba(255,255,255,.03);}
.data-table tfoot td{
  background:rgba(124,58,237,.08);
  color:var(--v3);font-weight:700;font-size:13px;
  border-top:1px solid rgba(124,58,237,.2);
  padding:11px 16px;
}

/* Anchos fijos de columnas en la tabla de gastos */
.col-desc   { width:120px; min-width:80px; }
.col-cat    { width:100px; }
.col-banco  { width:110px; }
.col-marca  { width:120px; }
.col-fecha  { width:100px; white-space:nowrap; }
.col-monto  { width:110px; text-align:right; white-space:nowrap; }
.col-cuotas { width:90px; }
.col-acc    { width:72px; }

/* Mobile: tabla con menos padding y columnas adaptadas */
@media(max-width:640px){
  .data-table th, .data-table td{ padding:10px 10px; }
  .col-cat  { width:80px; }
  .col-banco{ width:90px; }
  .col-marca{ width:100px; }
  .col-monto{ width:90px; font-size:12px; }
  .col-acc  { width:60px; }
}
@media(max-width:480px){
  .data-table th, .data-table td{ padding:9px 8px; font-size:12px; }
  .col-monto{ width:80px; font-size:11px; }
  .col-cat  { width:70px; }
  .col-banco{ width:80px; }
  .col-marca{ width:88px; }
}

.pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.3px;}
.pill-v{background:rgba(124,58,237,.2);color:var(--v3);}
.pill-c{background:rgba(6,182,212,.15);color:var(--c2);}
.pill-em{background:rgba(16,185,129,.15);color:var(--em2);}
.pill-gray{background:rgba(255,255,255,.07);color:var(--text2);}

/* â•â•â•â•â•â•â•â•â•â• CREDIT CARDS â•â•â•â•â•â•â•â•â•â• */
.cc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-bottom:28px;}
.cc-card{
  border-radius:20px;padding:26px;min-height:180px;
  display:flex;flex-direction:column;justify-content:space-between;
  position:relative;overflow:hidden;cursor:pointer;
  transition:transform .25s cubic-bezier(.4,0,.2,1),box-shadow .25s ease;
  box-shadow:0 8px 32px rgba(0,0,0,.5);
}
.cc-card:hover{transform:translateY(-6px) rotate(.5deg);box-shadow:0 20px 50px rgba(0,0,0,.6);}
.cc-card::before{
  content:'';position:absolute;width:280px;height:280px;border-radius:50%;
  background:rgba(255,255,255,.08);top:-120px;right:-80px;pointer-events:none;
}
.cc-card::after{
  content:'';position:absolute;width:180px;height:180px;border-radius:50%;
  background:rgba(255,255,255,.05);bottom:-70px;left:-40px;pointer-events:none;
}
.cc-top{position:relative;z-index:1;display:flex;justify-content:space-between;align-items:flex-start;}
/* cc-nombre y cc-bank ahora definidos abajo */
.cc-nfc{font-size:22px;opacity:.5;}
.cc-mid{position:relative;z-index:1;}
.cc-chip-icon{font-size:28px;margin-bottom:2px;opacity:.8;}
.cc-bottom{position:relative;z-index:1;}
.cc-number{font-size:14px;letter-spacing:3px;font-weight:600;opacity:.7;}
.cc-meta{display:flex;gap:16px;margin-top:4px;}
.cc-meta-item{font-size:10px;opacity:.5;text-transform:uppercase;letter-spacing:.5px;}
.cc-meta-item span{display:block;font-size:12px;font-weight:700;opacity:.85;letter-spacing:.5px;margin-top:1px;}
.cc-actions{
  display:flex;gap:8px;margin-top:12px;
  position:relative;z-index:1;
  opacity:0;transform:translateY(6px);transition:all .2s ease;
}
.cc-card:hover .cc-actions{opacity:1;transform:none;}
.cc-action-btn{
  padding:5px 12px;border-radius:var(--r-xs);border:none;cursor:pointer;
  font-size:11px;font-weight:700;font-family:'DM Sans',sans-serif;
  background:rgba(0,0,0,.3);color:rgba(255,255,255,.8);
  transition:background var(--t);backdrop-filter:blur(8px);
}
.cc-action-btn:hover{background:rgba(0,0,0,.5);}

/* â•â•â•â•â•â•â•â•â•â• CIERRES â•â•â•â•â•â•â•â•â•â• */
.cierres-panel{
  background:var(--surface);border:1px solid var(--border2);
  border-radius:var(--r-xl);overflow:hidden;display:none;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.cierres-panel.open{display:block;animation:fadeUp .2s ease;}
.cierres-head{
  padding:18px 24px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  background:rgba(124,58,237,.06);
}
.cierres-label{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--v3);margin-bottom:3px;}
.cierres-bank{font-family:'Outfit',sans-serif;font-size:16px;font-weight:800;}
.cierres-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;padding:20px 24px;}
.cierre-cell{
  background:rgba(255,255,255,.03);border:1px solid var(--border);
  border-radius:var(--r-sm);padding:14px;transition:all var(--t);
}
.cierre-cell:focus-within{border-color:rgba(124,58,237,.5);background:rgba(124,58,237,.05);}
.cierre-month{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-bottom:10px;}
.cierre-input-row{display:flex;align-items:center;gap:6px;}
.cierre-val{font-size:11px;color:var(--text3);}

/* â•â•â•â•â•â•â•â•â•â• FORMS â•â•â•â•â•â•â•â•â•â• */
.form-grid{display:flex;flex-direction:column;gap:16px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.field-label{
  display:block;font-size:10px;font-weight:700;
  letter-spacing:1.2px;text-transform:uppercase;
  color:var(--text3);margin-bottom:7px;
}
input,select{
  width:100%;background:rgba(255,255,255,.05);
  border:1px solid var(--border);border-radius:var(--r-sm);
  padding:11px 14px;color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:13.5px;outline:none;
  transition:all var(--t);
  -webkit-text-fill-color:var(--text);
}
input:focus,select:focus{
  border-color:rgba(124,58,237,.5);
  background:rgba(124,58,237,.06);
  box-shadow:0 0 0 3px rgba(124,58,237,.12);
}
input::placeholder{color:var(--text3);}
select option{background:var(--bg2);color:var(--text);}

/* â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â• */
.modal-overlay{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.7);backdrop-filter:blur(8px);
  align-items:center;justify-content:center;padding:16px;
}
.modal-overlay.open{display:flex;}
.modal{
  background:linear-gradient(145deg,rgba(22,22,42,.98),rgba(14,14,26,.99));
  border:1px solid var(--border2);border-radius:var(--r-2xl);
  width:520px;max-width:100%;max-height:92vh;overflow-y:auto;
  box-shadow:0 24px 80px rgba(0,0,0,.7),0 0 0 1px rgba(124,58,237,.1);
  animation:modalIn .22s cubic-bezier(.34,1.56,.64,1);
}
@keyframes modalIn{from{transform:scale(.92) translateY(20px);opacity:0;}}
.modal-head{
  padding:24px 28px 18px;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:flex-start;
  position:sticky;top:0;
  background:linear-gradient(145deg,rgba(22,22,42,.98),rgba(14,14,26,.99));
  z-index:1;
}
.modal-eyebrow{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--v3);margin-bottom:4px;}
.modal-title{font-family:'Outfit',sans-serif;font-size:20px;font-weight:800;letter-spacing:-.3px;}
.modal-close{
  width:32px;height:32px;border-radius:50%;
  background:rgba(255,255,255,.07);border:1px solid var(--border);
  cursor:pointer;font-size:20px;color:var(--text3);
  display:flex;align-items:center;justify-content:center;
  transition:all var(--t);flex-shrink:0;
}
.modal-close:hover{background:rgba(255,255,255,.12);color:var(--text);}
.modal-body{padding:24px 28px;}
.modal-foot{padding:16px 28px 24px;display:flex;justify-content:flex-end;gap:10px;border-top:1px solid var(--border);}

/* â•â•â•â•â•â•â•â•â•â• CUOTA PREVIEW â•â•â•â•â•â•â•â•â•â• */
.cuota-preview{
  background:rgba(16,185,129,.07);
  border:1px solid rgba(16,185,129,.2);
  border-left:3px solid var(--em);
  border-radius:var(--r-sm);padding:14px 16px;
}
.cuota-preview-title{font-size:10px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--em2);margin-bottom:10px;}
.cuota-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(16,185,129,.08);font-size:12.5px;}
.cuota-row:last-child{border-bottom:none;}
.cuota-row-label{color:var(--text3);}
.cuota-row-val{font-weight:700;color:var(--em2);}

/* â•â•â•â•â•â•â•â•â•â• COLOR PICKER â•â•â•â•â•â•â•â•â•â• */
.color-pick-grid{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;}
.cp-dot{width:32px;height:32px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all var(--t);}
.cp-dot:hover{transform:scale(1.18);}
.cp-dot.on{border-color:white;box-shadow:0 0 0 2px rgba(255,255,255,.2),0 0 14px var(--glow);}

/* â•â•â•â•â•â•â•â•â•â• FILTER TABS â•â•â•â•â•â•â•â•â•â• */
.filter-tabs{display:flex;gap:3px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r-sm);padding:3px;width:fit-content;}
.filter-tab{padding:7px 14px;border-radius:var(--r-xs);cursor:pointer;font-size:12px;font-weight:600;color:var(--text3);transition:all var(--t);border:none;background:none;font-family:'DM Sans',sans-serif;white-space:nowrap;}
.filter-tab.active{background:rgba(124,58,237,.2);color:var(--v3);box-shadow:inset 0 1px 0 rgba(255,255,255,.1);}
.filter-tab:hover:not(.active){color:var(--text2);}

/* â•â•â•â•â•â•â•â•â•â• PAGINACIÃ“N â•â•â•â•â•â•â•â•â•â• */
.paginacion{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 4px 4px;gap:12px;flex-wrap:wrap;
}
.pag-info{font-size:12px;color:var(--text3);font-weight:500;white-space:nowrap;}
.pag-btns{display:flex;gap:4px;align-items:center;flex-wrap:wrap;}
.pag-btn{
  min-width:34px;height:34px;padding:0 8px;
  border-radius:var(--r-xs);border:1px solid var(--border2);
  background:var(--surface);color:var(--text2);
  font-size:13px;font-weight:600;cursor:pointer;
  font-family:'DM Sans',sans-serif;
  transition:all var(--t);display:flex;align-items:center;justify-content:center;
}
.pag-btn:hover:not(:disabled){background:rgba(124,58,237,.15);color:var(--v3);border-color:rgba(124,58,237,.3);}
.pag-btn.active{background:rgba(124,58,237,.25);color:var(--v3);border-color:rgba(124,58,237,.4);font-weight:700;}
.pag-btn.disabled,.pag-btn:disabled{opacity:.3;cursor:not-allowed;}
.pag-ellipsis{min-width:34px;height:34px;display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:13px;}

@media(max-width:480px){
  .paginacion{justify-content:center;}
  .pag-info{width:100%;text-align:center;}
  .pag-btn{min-width:30px;height:30px;font-size:12px;}
}

/* â•â•â•â•â•â•â•â•â•â• GASTOS TOOLBAR â•â•â•â•â•â•â•â•â•â• */
.gastos-toolbar{display:flex;flex-direction:column;gap:10px;margin-bottom:20px;}
.gt-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.gt-row-controls{justify-content:flex-start;}
.gt-control-group{display:flex;align-items:center;gap:8px;}
.gt-label{font-size:10px;color:var(--text3);font-weight:700;letter-spacing:1px;text-transform:uppercase;white-space:nowrap;flex-shrink:0;}
.gt-select{
  background:var(--surface);border:1px solid var(--border2);
  border-radius:var(--r-xs);padding:7px 10px;
  font-size:12px;color:var(--text);font-family:'DM Sans',sans-serif;
  outline:none;cursor:pointer;max-width:130px;
}
.gt-select:focus{border-color:rgba(124,58,237,.5);}

@media(max-width:540px){
  .filter-tab{padding:6px 10px;font-size:11px;}
  .gt-control-group{flex-wrap:wrap;}
  .gt-select{max-width:100px;}
}

/* â•â•â•â•â•â•â•â•â•â• EMPTY / HINT â•â•â•â•â•â•â•â•â•â• */
.empty-state{text-align:center;padding:80px 24px;color:var(--text3);}
.empty-icon{font-size:52px;margin-bottom:16px;opacity:.6;}
.empty-title{font-family:'Outfit',sans-serif;font-size:18px;font-weight:800;color:var(--text2);margin-bottom:6px;}
.empty-sub{font-size:13px;max-width:280px;margin:0 auto;}
.hint-box{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r-lg);padding:20px;
  text-align:center;color:var(--text3);font-size:13px;
}

/* â•â•â•â•â•â•â•â•â•â• TOAST & LOADER â•â•â•â•â•â•â•â•â•â• */
.loader{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

.toast{
  position:fixed;bottom:24px;right:24px;z-index:999;
  border-radius:var(--r-sm);padding:13px 18px;font-size:13px;font-weight:500;
  display:none;align-items:center;gap:10px;
  box-shadow:0 16px 40px rgba(0,0,0,.5);
  animation:fadeUp .2s ease;max-width:300px;
  backdrop-filter:blur(12px);
}
.toast.show{display:flex;}
.toast.success{background:rgba(16,185,129,.15);color:var(--em2);border:1px solid rgba(16,185,129,.3);}
.toast.error{background:rgba(244,63,94,.15);color:#fca5a5;border:1px solid rgba(244,63,94,.3);}

/* â•â•â•â•â•â•â•â•â•â• AUTH SCREEN â•â•â•â•â•â•â•â•â•â• */
#auth-screen{
  position:fixed;inset:0;z-index:600;
  background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  padding:24px;
}
.auth-orb{position:absolute;border-radius:50%;filter:blur(80px);pointer-events:none;}
.auth-orb-1{width:500px;height:500px;background:radial-gradient(circle,#7c3aed,transparent 70%);top:-150px;left:-150px;opacity:.2;}
.auth-orb-2{width:400px;height:400px;background:radial-gradient(circle,#06b6d4,transparent 70%);bottom:-100px;right:-100px;opacity:.15;}
.auth-wrap{
  width:100%;max-width:380px;
  display:flex;flex-direction:column;align-items:center;gap:20px;
  position:relative;z-index:1;
}
.auth-logo{
  width:72px;height:72px;border-radius:20px;
  background:var(--grad-h);
  display:flex;align-items:center;justify-content:center;
  font-size:36px;
  box-shadow:0 0 50px rgba(124,58,237,.45);
  animation:pulse 2.5s ease infinite;
}
.auth-title{
  font-family:'Outfit',sans-serif;font-size:30px;font-weight:800;
  letter-spacing:-.5px;margin-top:-4px;
}
.auth-title em{font-style:normal;background:var(--grad-h);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.auth-sub{font-size:13px;color:var(--text3);text-align:center;margin-top:-10px;}
.auth-card{
  width:100%;
  background:rgba(22,22,42,.9);
  border:1px solid var(--border2);
  border-radius:var(--r-xl);
  padding:24px;
  display:flex;flex-direction:column;gap:12px;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
  backdrop-filter:blur(20px);
}
.auth-divider{
  display:flex;align-items:center;gap:12px;width:100%;
  color:var(--text3);font-size:12px;
}
.auth-divider::before,.auth-divider::after{
  content:'';flex:1;height:1px;background:var(--border);
}
.auth-fp-btn{
  width:100%;padding:16px;border-radius:var(--r-lg);
  background:rgba(255,255,255,.04);border:1px solid var(--border2);
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;
  color:var(--text2);font-size:14px;font-weight:600;
  font-family:'DM Sans',sans-serif;
  transition:all var(--t);
}
.auth-fp-btn:hover{background:rgba(124,58,237,.12);border-color:rgba(124,58,237,.3);color:var(--v3);}
.auth-fp-icon{font-size:26px;line-height:1;}

/* â•â•â•â•â•â•â•â•â•â• LOADING â•â•â•â•â•â•â•â•â•â• */
.loading-screen{
  position:fixed;inset:0;z-index:500;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;
  background:var(--bg);
}
.loading-logo{
  width:64px;height:64px;border-radius:20px;
  background:var(--grad-h);
  display:flex;align-items:center;justify-content:center;
  font-size:32px;
  box-shadow:var(--glow-v);
  animation:pulse 2s ease infinite;
}
@keyframes pulse{0%,100%{box-shadow:0 0 40px rgba(124,58,237,.35);}50%{box-shadow:0 0 70px rgba(124,58,237,.6);}}
.loading-name{font-family:'Outfit',sans-serif;font-size:24px;font-weight:800;letter-spacing:-.5px;}
.loading-name em{font-style:normal;background:var(--grad-h);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.loading-bar-wrap{width:180px;height:3px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden;}
.loading-bar{height:100%;background:var(--grad-h);border-radius:2px;animation:loadBar 1.5s cubic-bezier(.4,0,.2,1);}
@keyframes loadBar{from{width:0;}to{width:100%;}}
.loading-sub{font-size:12px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;}

/* â•â•â•â•â•â•â•â•â•â• CARD NAME HIERARCHY â•â•â•â•â•â•â•â•â•â• */
.cc-nombre{font-family:'Outfit',sans-serif;font-weight:800;font-size:18px;opacity:.95;letter-spacing:.2px;line-height:1.1;}
.cc-bank{font-family:'Outfit',sans-serif;font-weight:500;font-size:12px;opacity:.55;margin-top:4px;letter-spacing:.3px;}

/* â•â•â•â•â•â•â•â•â•â• MES GRUPOS â•â•â•â•â•â•â•â•â•â• */
.mes-grupo{margin-bottom:12px;}
.mes-grupo-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px;cursor:pointer;
  background:var(--surface2);
  border:1px solid var(--border2);
  border-radius:var(--r-lg) var(--r-lg) var(--r-lg) var(--r-lg);
  transition:all var(--t);user-select:none;
}
.mes-grupo.open .mes-grupo-head{border-radius:var(--r-lg) var(--r-lg) 0 0;}
.mes-grupo-head:hover{background:rgba(124,58,237,.08);border-color:rgba(124,58,237,.25);}
.mes-grupo-chevron{font-size:14px;color:var(--v3);width:16px;transition:transform var(--t);}
.mes-grupo-label{font-family:'Outfit',sans-serif;font-weight:700;font-size:15px;color:var(--text);}
.mes-grupo-count{font-size:11px;color:var(--text3);background:rgba(255,255,255,.06);padding:3px 9px;border-radius:20px;}
.mes-grupo-total{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;color:var(--v3);}
.mes-grupo-body{display:block;}

/* â•â•â•â•â•â•â•â•â•â• RESPONSIVE TABLE COLS â•â•â•â•â•â•â•â•â•â• */
/* col-tarjeta = Banco + Marca */
@media(max-width:900px){
  .col-tarjeta{display:none;}
}
/* col-fecha = Fecha compra */
@media(max-width:640px){
  .col-fecha{display:none;}
}
/* col-cuotas = columna Cuotas */
@media(max-width:480px){
  .col-cuotas{display:none;}
}
/* Forzar que la tabla no desborde en mobile */
.data-table{table-layout:fixed;}
/* Columnas responsivas - manejadas por clases */

/* â•â•â•â•â•â•â•â•â•â• RESUMEN TOP ROW â•â•â•â•â•â•â•â•â•â• */
.resumen-top-row{
  display:flex;align-items:stretch;gap:14px;
  margin-bottom:24px;flex-wrap:wrap;
}
.resumen-top-row .period-nav{
  margin-bottom:0;flex-shrink:0;min-width:0;
}

/* Total aside card */
.total-aside-card{
  flex:1;min-width:220px;
  background:linear-gradient(145deg,rgba(124,58,237,.18),rgba(99,102,241,.1));
  border:1px solid rgba(124,58,237,.35);
  border-radius:var(--r-xl);
  padding:18px 28px;
  display:flex;flex-direction:column;justify-content:center;
  position:relative;overflow:hidden;
  box-shadow:0 4px 24px rgba(124,58,237,.15);
}
.total-aside-card::before{
  content:'';position:absolute;top:-40px;right:-40px;
  width:160px;height:160px;border-radius:50%;
  background:radial-gradient(circle,rgba(124,58,237,.25),transparent 70%);
  pointer-events:none;
}
.total-aside-card::after{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:var(--grad-h);
}
.total-aside-card.future{
  background:linear-gradient(145deg,rgba(16,185,129,.15),rgba(6,182,212,.08));
  border-color:rgba(16,185,129,.3);
  box-shadow:0 4px 24px rgba(16,185,129,.12);
}
.total-aside-card.future::after{
  background:linear-gradient(90deg,var(--em),var(--c2));
}
.tac-label{
  font-size:10px;font-weight:700;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--v3);margin-bottom:8px;
}
.total-aside-card.future .tac-label{color:var(--em2);}
.tac-amount{
  font-family:'DM Mono',monospace;font-size:36px;font-weight:500;
  letter-spacing:-1px;line-height:1;color:var(--text);
}
.tac-amount.future{
  background:linear-gradient(90deg,var(--em),var(--c2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.tac-badge{font-size:12px;color:var(--text3);margin-top:8px;}

/* Stat card inner layout */
.sc-card-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
.sc-dot-wrap{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sc-names{display:flex;flex-direction:column;gap:2px;min-width:0;flex:1;}
.sc-nombre{
  font-family:'Outfit',sans-serif;font-size:16px;font-weight:800;
  color:var(--text);letter-spacing:-.2px;line-height:1.1;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.sc-banco{font-size:11px;color:var(--text3);font-weight:500;letter-spacing:.2px;}
.sc-footer{display:flex;align-items:center;justify-content:space-between;margin-top:10px;}
.sc-pct{font-size:11px;color:var(--text3);}

/* Remove old .sc-label margin-bottom since we're using sc-card-header now */
.stat-card .sc-label{margin-bottom:0;}

/* â•â•â•â•â•â•â•â•â•â• MOBILE NAV OVERRIDE (keep correct hidden cols) â•â•â•â•â•â•â•â•â•â• */
.mobile-nav{
  display:none;position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:rgba(14,14,26,.92);backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  padding:8px 16px calc(8px + env(safe-area-inset-bottom));
  flex-direction:row;justify-content:space-around;align-items:center;gap:4px;
}
.mob-nav-btn{
  display:flex;flex-direction:column;align-items:center;gap:4px;
  padding:8px 16px;border-radius:var(--r-sm);cursor:pointer;
  color:var(--text3);font-size:10px;font-weight:600;letter-spacing:.5px;
  transition:all var(--t);border:none;background:none;
  font-family:'DM Sans',sans-serif;flex:1;
}
.mob-nav-btn:hover,.mob-nav-btn.active{color:var(--v3);}
.mob-nav-btn.active{background:rgba(124,58,237,.12);}
.mob-nav-icon{font-size:20px;line-height:1;}
.mobile-header{
  display:none;
  padding:16px 20px 12px;
  background:rgba(9,9,15,.8);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:50;
  align-items:center;justify-content:space-between;
}
.mob-brand{font-family:'Outfit',sans-serif;font-size:18px;font-weight:800;}
.mob-brand em{font-style:normal;background:var(--grad-h);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}

/* â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â• */
@media(max-width:768px){
  .sidebar{display:none;}
  .main{margin-left:0;}
  .mobile-nav{display:flex;}
  .mobile-header{display:flex;}
  .topbar{display:none;}
  .content{padding:14px 14px 96px;}
  .form-row{grid-template-columns:1fr;}
  .stats-grid{grid-template-columns:1fr 1fr;}
  .period-mid{min-width:0;flex:1;padding:10px 12px;}
  .period-month{font-size:17px;}
  .period-nav{width:100%;max-width:100%;margin-bottom:16px;}
  .cc-grid{grid-template-columns:1fr;}
  .detail-head{flex-direction:column;align-items:flex-start;gap:10px;}
  .detail-amount{text-align:left;}
  /* Quitar ocultamiento genÃ©rico por nth-child â€” lo manejamos con clases */
  .modal{border-radius:var(--r-xl) var(--r-xl) 0 0;max-height:95vh;}
  .modal-overlay{align-items:flex-end;padding:0;}
  .resumen-top-row{flex-direction:column;}
  .total-aside-card{padding:14px 18px;}
  .tac-amount{font-size:26px;}
  .mes-grupo-head{padding:12px 14px;}
  .mes-grupo-label{font-size:13px;}
  /* Mobile header action button */
  #mob-topbar-action .btn{padding:8px 14px;font-size:12px;}
}

@media(max-width:480px){
  .content{padding:12px 12px 88px;}
  .stats-grid{grid-template-columns:1fr;}
  .btn{padding:8px 14px;font-size:12px;}
  .filter-tab{padding:6px 9px;font-size:11px;}
  .sc-amount{font-size:22px;}
  .tac-amount{font-size:22px;}
  .period-month{font-size:15px;}
  .period-arrow{padding:0 12px;font-size:18px;}
}
</style>

</head>
<body>

<!-- ORBS -->
<div class="orb orb-1"></div>
<div class="orb orb-2"></div>
<div class="orb orb-3"></div>

<!-- â•â• AUTH SCREEN â•â• -->
<div id="auth-screen" style="display:none;">
  <div class="auth-orb auth-orb-1"></div>
  <div class="auth-orb auth-orb-2"></div>
  <div class="auth-wrap">
    <div class="auth-logo">ğŸ’³</div>
    <div class="auth-title">Tarjet<em>App</em></div>
    <div class="auth-sub" id="auth-sub">IngresÃ¡ tu contraseÃ±a para continuar</div>

    <div class="auth-card" id="auth-card-password">
      <label class="field-label" style="text-align:left;">ContraseÃ±a</label>
      <div style="position:relative;">
        <input id="auth-input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          style="padding-right:44px;"
          onkeydown="if(event.key==='Enter')tryLogin()">
        <button onclick="toggleAuthVis()" id="auth-vis-btn"
          style="position:absolute;right:12px;top:50%;transform:translateY(-50%);
          background:none;border:none;cursor:pointer;color:var(--text3);font-size:18px;line-height:1;">ğŸ‘</button>
      </div>
      <div id="auth-error" style="font-size:12px;color:#f87171;margin-top:8px;min-height:18px;text-align:center;"></div>
      <button class="btn btn-primary" style="width:100%;margin-top:4px;justify-content:center;" onclick="tryLogin()">
        Ingresar
      </button>
    </div>

    <div id="auth-fp-wrap" style="display:none;margin-top:0;">
      <div class="auth-divider"><span>o</span></div>
      <button class="auth-fp-btn" id="auth-fp-btn" onclick="tryFingerprint()">
        <span class="auth-fp-icon">ğŸ”</span>
        <span id="auth-fp-label">Usar huella dactilar</span>
      </button>
    </div>

    <div id="auth-reg-fp-wrap" style="display:none;margin-top:16px;text-align:center;">
      <button class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;" onclick="registerFingerprint()">
        ï¼‹ Registrar huella dactilar
      </button>
      <div style="font-size:11px;color:var(--text3);margin-top:8px;">Solo necesitÃ¡s hacerlo una vez en este dispositivo</div>
    </div>
  </div>
</div>

<!-- LOADING -->
<div class="loading-screen" id="loading-screen" style="display:none;">
  <div class="loading-logo">ğŸ’³</div>
  <div class="loading-name">Tarjet<em>App</em></div>
  <div class="loading-bar-wrap"><div class="loading-bar"></div></div>
  <div class="loading-sub">Cargando datosâ€¦</div>
</div>

<!-- MOBILE HEADER -->
<div class="mobile-header" id="mobile-header">
  <div class="mob-brand">Tarjet<em>App</em></div>
  <div id="mob-topbar-action"></div>
</div>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-inner">
      <div class="brand">
        <div class="brand-logo">ğŸ’³</div>
        <div>
          <div class="brand-name">Tarjet<em>App</em></div>
          <div class="brand-ver">v2.0 Â· Fintech</div>
        </div>
      </div>

      <div class="nav-section-label">Principal</div>
      <button class="nav-btn active" id="nb-resumen" onclick="showPage('resumen',this)">
        <span class="nav-icon">ğŸ“Š</span>
        <span class="nav-label">Resumen</span>
      </button>
      <button class="nav-btn" id="nb-gastos" onclick="showPage('gastos',this)">
        <span class="nav-icon">ğŸ’¸</span>
        <span class="nav-label">Gastos</span>
      </button>

      <div class="nav-section-label" style="margin-top:16px;">ConfiguraciÃ³n</div>
      <button class="nav-btn" id="nb-tarjetas" onclick="showPage('tarjetas',this)">
        <span class="nav-icon">ğŸ—‚ï¸</span>
        <span class="nav-label">Tarjetas</span>
      </button>

      <div class="sidebar-bottom">
        <div class="sync-chip">
          <div class="sync-led" id="sync-led"></div>
          <div class="sync-txt" id="sync-txt">Conectandoâ€¦</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <header class="topbar">
      <div class="topbar-left">
        <div class="tb-section" id="tb-section">RESUMEN</div>
        <div class="tb-title" id="tb-title"><span>PerÃ­odos de facturaciÃ³n</span></div>
      </div>
      <div class="topbar-actions" id="topbar-actions"></div>
    </header>

    <div class="content" id="main-content">

      <!-- â•â• RESUMEN â•â• -->
      <div class="page active" id="page-resumen">
        <!-- Fila superior: navegador de perÃ­odo + total del perÃ­odo -->
        <div class="resumen-top-row">
          <div class="period-nav">
            <button class="period-arrow" onclick="changePeriod(-1)">â€¹</button>
            <div class="period-mid">
              <div class="period-month" id="period-month">â€”</div>
              <div class="period-tag" id="period-tag">â€”</div>
            </div>
            <button class="period-arrow" onclick="changePeriod(1)">â€º</button>
          </div>
          <div id="total-card-wrap"></div>
        </div>
        <!-- Grid de tarjetas -->
        <div class="stats-grid" id="stats-grid"></div>
        <div id="detail-area"></div>
      </div>

      <!-- â•â• GASTOS â•â• -->
      <div class="page" id="page-gastos">
        <div class="gastos-toolbar">
          <!-- Fila 1: filtros estado -->
          <div class="gt-row">
            <div class="filter-tabs">
              <button class="filter-tab active" onclick="filterGastos('todos',this)">Todos</button>
              <button class="filter-tab" onclick="filterGastos('pendientes',this)">Pendientes</button>
              <button class="filter-tab" onclick="filterGastos('pasados',this)">Pasados</button>
            </div>
          </div>
          <!-- Fila 2: filtros banco + marca + agrupar -->
          <div class="gt-row gt-row-controls">
            <div class="gt-control-group">
              <span class="gt-label">Banco</span>
              <select id="banco-filter" class="gt-select" onchange="renderGastos()">
                <option value="">Todos</option>
              </select>
            </div>
            <div class="gt-control-group">
              <span class="gt-label">Marca</span>
              <select id="marca-filter" class="gt-select" onchange="renderGastos()">
                <option value="">Todas</option>
              </select>
            </div>
            <div class="gt-control-group">
              <span class="gt-label">Agrupar</span>
              <div class="filter-tabs">
                <button class="filter-tab active" id="group-tab-none" onclick="setGrouping('none',this)">Sin agrupar</button>
                <button class="filter-tab" id="group-tab-month" onclick="setGrouping('month',this)">Por mes</button>
              </div>
            </div>
          </div>
          <!-- Fila 3: mes + aÃ±o -->
          <div class="gt-row gt-row-controls">
            <div class="gt-control-group">
              <span class="gt-label">Mes</span>
              <select id="mes-filter" class="gt-select" onchange="renderGastos()">
                <option value="">Todos</option>
              </select>
            </div>
            <div class="gt-control-group">
              <span class="gt-label">AÃ±o</span>
              <select id="anio-filter" class="gt-select" onchange="renderGastos()">
                <option value="">Todos</option>
              </select>
            </div>
          </div>
        </div>
        <div id="gastos-container">
          <div class="detail-glass">
            <div style="overflow-x:auto;">
              <table class="data-table">
                <thead><tr>
                  <th class="col-desc">DescripciÃ³n</th>
                  <th class="col-cat">CategorÃ­a</th>
                  <th class="col-banco col-tarjeta">Banco</th>
                  <th class="col-marca col-tarjeta">Marca</th>
                  <th class="col-fecha">Fecha</th>
                  <th class="col-monto">Monto</th>
                  <th class="col-cuotas">Cuotas</th>
                  <th class="col-acc"></th>
                </tr></thead>
                <tbody id="gastos-tbody"></tbody>
              </table>
              <div id="gastos-empty" class="empty-state" style="display:none;">
                <div class="empty-icon">ğŸ›ï¸</div>
                <div class="empty-title">Sin gastos aÃºn</div>
                <div class="empty-sub">RegistrÃ¡ tu primera compra usando el botÃ³n de arriba</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â• TARJETAS â•â• -->
      <div class="page" id="page-tarjetas">
        <div class="cc-grid" id="cc-grid"></div>
        <div id="tarjetas-empty" class="empty-state" style="display:none;">
          <div class="empty-icon">ğŸ’³</div>
          <div class="empty-title">Sin tarjetas</div>
          <div class="empty-sub">AgregÃ¡ tu primera tarjeta para empezar</div>
        </div>
        <div class="cierres-panel" id="cierres-panel">
          <div class="cierres-head">
            <div>
              <div class="cierres-label">Fechas de cierre</div>
              <div class="cierres-bank" id="cierres-bank">â€”</div>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="closeCierres()">Cerrar âœ•</button>
          </div>
          <div class="cierres-grid" id="cierres-grid"></div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- MOBILE NAV -->
<div class="mobile-nav">
  <button class="mob-nav-btn active" id="mn-resumen" onclick="showPage('resumen',this,'mn-resumen')">
    <span class="mob-nav-icon">ğŸ“Š</span>Resumen
  </button>
  <button class="mob-nav-btn" id="mn-gastos" onclick="showPage('gastos',this,'mn-gastos')">
    <span class="mob-nav-icon">ğŸ’¸</span>Gastos
  </button>
  <button class="mob-nav-btn" id="mn-tarjetas" onclick="showPage('tarjetas',this,'mn-tarjetas')">
    <span class="mob-nav-icon">ğŸ—‚ï¸</span>Tarjetas
  </button>
</div>

<!-- MODAL TARJETA -->
<div class="modal-overlay" id="modal-tarjeta">
  <div class="modal">
    <div class="modal-head">
      <div>
        <div class="modal-eyebrow" id="mt-eyebrow">Nueva tarjeta</div>
        <div class="modal-title" id="mt-title">Agregar tarjeta</div>
      </div>
      <button class="modal-close" onclick="closeModal('modal-tarjeta')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div>
          <label class="field-label">Banco / Emisor</label>
          <input id="tc-banco" type="text" placeholder="Ej: Galicia, BBVA, Santanderâ€¦">
        </div>
        <div>
          <label class="field-label">Nombre de la tarjeta</label>
          <input id="tc-nombre" type="text" placeholder="Ej: Visa Gold, Mastercard Platinumâ€¦">
        </div>
        <div>
          <label class="field-label">Ãšltimos 4 dÃ­gitos (opcional)</label>
          <input id="tc-digitos" type="text" maxlength="4" placeholder="1234">
        </div>
        <div>
          <label class="field-label">Color de la tarjeta</label>
          <div class="color-pick-grid" id="color-picker">
            <div class="cp-dot on" style="background:#7c3aed;--glow:rgba(124,58,237,.6)" data-color="#7c3aed" onclick="pickColor(this)"></div>
            <div class="cp-dot" style="background:#0ea5e9;--glow:rgba(14,165,233,.6)" data-color="#0ea5e9" onclick="pickColor(this)"></div>
            <div class="cp-dot" style="background:#10b981;--glow:rgba(16,185,129,.6)" data-color="#10b981" onclick="pickColor(this)"></div>
            <div class="cp-dot" style="background:#f59e0b;--glow:rgba(245,158,11,.6)" data-color="#f59e0b" onclick="pickColor(this)"></div>
            <div class="cp-dot" style="background:#f43f5e;--glow:rgba(244,63,94,.6)" data-color="#f43f5e" onclick="pickColor(this)"></div>
            <div class="cp-dot" style="background:#ec4899;--glow:rgba(236,72,153,.6)" data-color="#ec4899" onclick="pickColor(this)"></div>
            <div class="cp-dot" style="background:#06b6d4;--glow:rgba(6,182,212,.6)" data-color="#06b6d4" onclick="pickColor(this)"></div>
            <div class="cp-dot" style="background:#64748b;--glow:rgba(100,116,139,.6)" data-color="#64748b" onclick="pickColor(this)"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('modal-tarjeta')">Cancelar</button>
      <button class="btn btn-primary" id="btn-save-tarjeta" onclick="saveTarjeta()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL GASTO -->
<div class="modal-overlay" id="modal-gasto">
  <div class="modal">
    <div class="modal-head">
      <div>
        <div class="modal-eyebrow" id="mg-eyebrow">Nuevo gasto</div>
        <div class="modal-title" id="mg-title">Registrar compra</div>
      </div>
      <button class="modal-close" onclick="closeModal('modal-gasto')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div>
          <label class="field-label">DescripciÃ³n</label>
          <input id="g-desc" type="text" placeholder="Ej: Supermercado, Netflixâ€¦">
        </div>
        <div class="form-row">
          <div>
            <label class="field-label">Tarjeta</label>
            <select id="g-tarjeta" onchange="previewCuotas()"></select>
          </div>
          <div>
            <label class="field-label">Fecha de compra</label>
            <input id="g-fecha" type="date" onchange="previewCuotas()">
          </div>
        </div>
        <div class="form-row">
          <div>
            <label class="field-label">Monto total ($)</label>
            <input id="g-monto" type="number" placeholder="0.00" min="0" step="0.01" oninput="previewCuotas()">
          </div>
          <div>
            <label class="field-label">Cuotas</label>
            <input id="g-cuotas" type="number" value="1" min="1" max="60" oninput="previewCuotas()">
          </div>
        </div>
        <div id="cuota-preview-wrap" style="display:none;">
          <div class="cuota-preview">
            <div class="cuota-preview-title">DistribuciÃ³n de cuotas</div>
            <div id="cuota-preview-rows"></div>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label class="field-label">CategorÃ­a</label>
            <select id="g-categoria">
              <option value="">Sin categorÃ­a</option>
              <option>ğŸ›’ Supermercado</option><option>ğŸ½ï¸ Restaurantes</option>
              <option>â›½ Combustible</option><option>ğŸ¥ Salud</option>
              <option>âœˆï¸ Viajes</option><option>ğŸ¬ Entretenimiento</option>
              <option>ğŸ‘— Ropa</option><option>ğŸ  Hogar</option>
              <option>ğŸ“± TecnologÃ­a</option><option>ğŸ’¼ Trabajo</option>
              <option>ğŸ“ EducaciÃ³n</option><option>Otro</option>
            </select>
          </div>
          <div>
            <label class="field-label">Nota (opcional)</label>
            <input id="g-nota" type="text" placeholder="Detalle adicionalâ€¦">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('modal-gasto')">Cancelar</button>
      <button class="btn btn-primary" id="btn-save-gasto" onclick="saveGasto()">Registrar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â• SUPABASE â•â•â•â•â•â•â•â•â•â•â• */
const SURL='https://ndiunufkwvgyrbtqctwp.supabase.co';
const SKEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXVudWZrd3ZneXJidHFjdHdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDE3NDksImV4cCI6MjA4NzE3Nzc0OX0.jwry-uF9hstCHLrQyq4OfeGfarsxBaxich6enVOLR2U';
const sb=supabase.createClient(SURL,SKEY);

/* â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â• */
let tarjetas=[],cierres=[],gastos=[];
let selectedColor='#7c3aed';
let editingTarjetaId=null,editingGastoId=null;
let gastoFilter='todos';
let allPeriods=[],currentPeriodIdx=0;
let selectedTarjetaId=null;
let currentPage='resumen';

/* â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â• */
async function init(){
  if(isSessionValid()){
    await loadAndRender();
  } else {
    showAuth();
  }
}

async function loadAndRender(){
  // Asegurar que el loading screen estÃ© visible
  const ls=document.getElementById('loading-screen');
  ls.style.display='flex';ls.style.opacity='1';
  try{
    const[t,c,g]=await Promise.all([
      sb.from('tarjetas').select('*').order('created_at'),
      sb.from('cierres').select('*'),
      sb.from('gastos').select('*').order('created_at',{ascending:false}),
    ]);
    if(t.error||c.error||g.error)throw new Error();
    tarjetas=t.data;cierres=c.data;gastos=g.data;
    setSync(true);
  }catch{setSync(false);showToast('Error al conectar','error');}
  setTimeout(()=>{
    ls.style.transition='opacity .4s';ls.style.opacity='0';
    setTimeout(()=>ls.style.display='none',400);
  },1000);
  buildAllPeriods();setCurrentPeriod();renderResumen();
}

function setSync(ok){
  const led=document.getElementById('sync-led');
  const txt=document.getElementById('sync-txt');
  led.className='sync-led '+(ok?'ok':'err');
  txt.textContent=ok?'Sincronizado':'Sin conexiÃ³n';
}

/* â•â•â•â•â•â•â•â•â•â•â• NAVIGATION â•â•â•â•â•â•â•â•â•â•â• */
const PAGE_CFG={
  resumen:{section:'RESUMEN',title:'PerÃ­odos de facturaciÃ³n',action:null},
  gastos:{section:'GASTOS',title:'Todas las compras',action:()=>'<button class="btn btn-primary" onclick="openModalGasto()">ï¼‹ Nuevo gasto</button>'},
  tarjetas:{section:'TARJETAS',title:'Mis tarjetas',action:()=>'<button class="btn btn-primary" onclick="openModalTarjeta()">ï¼‹ Nueva tarjeta</button>'},
};

function showPage(name,el,mobId){
  currentPage=name;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');

  // Desktop nav
  document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active'));
  const desktopBtn=document.getElementById('nb-'+name);
  if(desktopBtn)desktopBtn.classList.add('active');

  // Mobile nav
  document.querySelectorAll('.mob-nav-btn').forEach(n=>n.classList.remove('active'));
  const mobBtn=document.getElementById('mn-'+name);
  if(mobBtn)mobBtn.classList.add('active');

  const cfg=PAGE_CFG[name];
  document.getElementById('tb-section').textContent=cfg.section;
  document.getElementById('tb-title').innerHTML=`<span>${cfg.title}</span>`;
  const actHTML=cfg.action?cfg.action():'';
  document.getElementById('topbar-actions').innerHTML=actHTML;
  document.getElementById('mob-topbar-action').innerHTML=actHTML;
  window.scrollTo({top:0});

  if(name==='resumen')renderResumen();
  if(name==='gastos')renderGastos();
  if(name==='tarjetas')renderTarjetas();
}

/* â•â•â•â•â•â•â•â•â•â•â• PERIOD LOGIC â•â•â•â•â•â•â•â•â•â•â• */
function getMonthKey(y,m){return`${y}-${String(m+1).padStart(2,'0')}`;}
function nextMk(mk){const[y,m]=mk.split('-').map(Number);const d=new Date(y,m,1);return getMonthKey(d.getFullYear(),d.getMonth());}
function getCierreDia(tid,mk){const c=cierres.find(c=>c.tarjeta_id===tid&&c.mes_key===mk);return c?c.dia:null;}

function getCierreForFecha(tid,fechaStr){
  const fc=new Date(fechaStr+'T12:00:00');
  for(let i=0;i<36;i++){
    const d=new Date(fc.getFullYear(),fc.getMonth()+i,1);
    const mk=getMonthKey(d.getFullYear(),d.getMonth());
    const dia=getCierreDia(tid,mk);
    if(!dia)continue;
    if(new Date(d.getFullYear(),d.getMonth(),dia)>=fc)return mk;
  }
  return getMonthKey(fc.getFullYear(),fc.getMonth());
}

function getCuotasPorPeriodo(g){
  const r={};
  const mk0=getCierreForFecha(g.tarjeta_id,g.fecha);
  if(!mk0)return r;
  const cm=g.monto/g.cuotas;let mk=mk0;
  for(let i=0;i<g.cuotas;i++){r[mk]=(r[mk]||0)+cm;mk=nextMk(mk);}
  return r;
}

function getPeriodRange(tid,mk){
  const[y,m]=mk.split('-').map(Number);
  const dA=getCierreDia(tid,mk);
  const d=new Date(y,m-1,1);
  const mkP=getMonthKey(d.getFullYear(),d.getMonth()-1);
  const dP=getCierreDia(tid,mkP);
  if(dA&&dP)return{desde:new Date(d.getFullYear(),d.getMonth()-1,dP+1),hasta:new Date(d.getFullYear(),d.getMonth(),dA),exacto:true};
  return{desde:new Date(y,m-1,1),hasta:new Date(y,m,0),exacto:false};
}

function buildAllPeriods(){
  const now=new Date();
  const mkNow=getMonthKey(now.getFullYear(),now.getMonth());
  const mk2back=getMonthKey(now.getFullYear(),now.getMonth()-2);
  const res=new Set();
  cierres.forEach(c=>{if(c.mes_key>=mk2back&&c.mes_key<=mkNow)res.add(c.mes_key);});
  gastos.forEach(g=>{
    const dist=getCuotasPorPeriodo(g);
    Object.keys(dist).forEach(mk=>{if(mk>mkNow)res.add(mk);});
  });
  allPeriods=[...res].sort();
}

function setCurrentPeriod(){
  if(!allPeriods.length)return;
  const now=new Date();
  const mkN=getMonthKey(now.getFullYear(),now.getMonth());
  const idx=allPeriods.indexOf(mkN);
  currentPeriodIdx=idx>=0?idx:allPeriods.length-1;
}

function changePeriod(dir){
  currentPeriodIdx=Math.max(0,Math.min(allPeriods.length-1,currentPeriodIdx+dir));
  selectedTarjetaId=null;
  renderResumen();
}

function mkToLabel(mk){const[y,m]=mk.split('-').map(Number);return['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][m-1]+' '+y;}
function mkToShort(mk){const[y,m]=mk.split('-').map(Number);return['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][m-1]+' '+y;}

/* â•â•â•â•â•â•â•â•â•â•â• RESUMEN â•â•â•â•â•â•â•â•â•â•â• */
function renderResumen(){
  buildAllPeriods();
  const statsEl=document.getElementById('stats-grid');
  const detailEl=document.getElementById('detail-area');

  if(!tarjetas.length){
    document.getElementById('period-month').textContent='â€”';
    document.getElementById('period-tag').textContent='â€”';
    document.getElementById('total-card-wrap').innerHTML='';
    statsEl.innerHTML='';
    detailEl.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><div class="empty-title">Sin tarjetas</div><div class="empty-sub">AndÃ¡ a Tarjetas y configurÃ¡ las tuyas</div></div>';
    return;
  }
  if(!allPeriods.length){
    document.getElementById('period-month').textContent='â€”';
    document.getElementById('period-tag').textContent='Sin perÃ­odos';
    document.getElementById('total-card-wrap').innerHTML='';
    statsEl.innerHTML='';
    detailEl.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“…</div><div class="empty-title">Sin perÃ­odos</div><div class="empty-sub">ConfigurÃ¡ fechas de cierre o cargÃ¡ gastos</div></div>';
    return;
  }

  if(currentPeriodIdx>=allPeriods.length)currentPeriodIdx=allPeriods.length-1;
  const mk=allPeriods[currentPeriodIdx];
  const[y,m]=mk.split('-').map(Number);
  const esFuturo=new Date(y,m-1,28)>new Date();

  document.getElementById('period-month').textContent=mkToLabel(mk);
  const tag=document.getElementById('period-tag');
  tag.textContent=esFuturo?'â†— PerÃ­odo futuro Â· estimado':'âœ“ En curso o cerrado';
  tag.className='period-tag'+(esFuturo?' future':'');

  let totalGeneral=0;
  const perTarjeta=tarjetas.map(t=>{
    let total=0;const gEP=[];
    gastos.forEach(g=>{
      if(g.tarjeta_id!==t.id)return;
      const dist=getCuotasPorPeriodo(g);
      if(dist[mk]){total+=dist[mk];gEP.push({g,monto:dist[mk]});}
    });
    totalGeneral+=total;
    return{t,total,gEP,range:getPeriodRange(t.id,mk)};
  });

  // Total card â€” separado, va al lado del period nav
  const totalWrap=document.getElementById('total-card-wrap');
  totalWrap.innerHTML=`<div class="total-aside-card${esFuturo?' future':''}">
    <div class="tac-label">Total del perÃ­odo</div>
    <div class="tac-amount${esFuturo?' future':''}">$${fmt(totalGeneral)}</div>
    <div class="tac-badge">${esFuturo?'ğŸ“… Estimado':'âœ… Facturado'}</div>
  </div>`;

  // Cards por tarjeta
  let sHTML='';
  perTarjeta.forEach(({t,total})=>{
    const pct=totalGeneral?Math.round(total/totalGeneral*100):0;
    const isSel=selectedTarjetaId===t.id;
    sHTML+=`<div class="stat-card clickable${isSel?' selected':''}" onclick="selectCard('${t.id}')">
      <div class="sc-card-header">
        <div class="sc-dot-wrap" style="background:${t.color}25;box-shadow:inset 0 0 0 1px ${t.color}50;">
          <div style="width:12px;height:12px;border-radius:50%;background:${t.color};box-shadow:0 0 10px ${t.color}90;"></div>
        </div>
        <div class="sc-names">
          <div class="sc-nombre">${t.nombre}</div>
          <div class="sc-banco">${t.banco}</div>
        </div>
      </div>
      <div class="sc-amount${esFuturo?' future':''}">$${fmt(total)}</div>
      <div class="sc-bar"><div class="sc-bar-fill" style="width:${pct}%;background:${t.color}"></div></div>
      <div class="sc-footer">
        <span class="sc-pct">${pct}% del total</span>
        <span class="sc-hint">${isSel?'â–² Ocultar':'â–¼ Detalle'}</span>
      </div>
    </div>`;
  });
  statsEl.innerHTML=sHTML;

  // Detail
  if(!selectedTarjetaId){
    detailEl.innerHTML='<div class="hint-box">ğŸ‘† TocÃ¡ una tarjeta para ver el detalle de sus gastos en este perÃ­odo</div>';
    return;
  }
  const item=perTarjeta.find(x=>x.t.id===selectedTarjetaId);
  if(!item){detailEl.innerHTML='';return;}
  const{t,total,gEP,range}=item;
  const rangoStr=range.exacto
    ?`${fDate(range.desde)} â†’ ${fDate(range.hasta)}`
    :`${fDate(range.desde)} â†’ ${fDate(range.hasta)} <span style="opacity:.5;font-size:11px;">(mes completo)</span>`;

  const rows=gEP.map(({g,monto})=>{
    const cn=Object.keys(getCuotasPorPeriodo(g)).sort().indexOf(mk)+1;
    const isSingle=g.cuotas===1;
    return`<tr>
      <td>
        <div style="font-weight:600;">${g.categoria?g.categoria+' ':''}${g.descripcion}</div>
        ${g.nota?`<div style="font-size:11px;color:var(--text3);margin-top:2px;">${g.nota}</div>`:''}
      </td>
      <td style="color:var(--text3);">${fDate(new Date(g.fecha+'T12:00:00'))}</td>
      <td><span class="pill ${isSingle?'pill-em':'pill-v'}">${isSingle?'1 pago':`${cn}/${g.cuotas}`}</span></td>
      <td style="text-align:right;font-weight:700;font-variant-numeric:tabular-nums;">$${fmt(monto)}</td>
    </tr>`;
  }).join('');

  detailEl.innerHTML=`<div class="detail-glass" style="border-top:2px solid ${t.color};">
    <div class="detail-head">
      <div class="detail-head-left">
        <div class="detail-stripe" style="background:${t.color};box-shadow:0 0 12px ${t.color}80;"></div>
        <div>
          <div class="detail-bank">${t.banco} <span style="font-weight:400;color:var(--text3);font-size:14px;">â€” ${t.nombre}${t.digitos?' Â·Â·Â·Â· '+t.digitos:''}</span></div>
          <div class="detail-meta">PerÃ­odo: ${rangoStr}</div>
        </div>
      </div>
      <div>
        <div class="detail-amount${esFuturo?' future':''}">$${fmt(total)}</div>
        <div class="detail-tag">${esFuturo?'estimado':'facturado'}</div>
      </div>
    </div>
    ${gEP.length?`<table class="data-table">
      <thead><tr><th>Concepto</th><th>Fecha compra</th><th>Cuotas</th><th style="text-align:right;">Monto</th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr>
        <td colspan="3" style="font-size:10px;letter-spacing:1px;text-transform:uppercase;">Total tarjeta</td>
        <td style="text-align:right;">$${fmt(total)}</td>
      </tr></tfoot>
    </table>`:`<div style="padding:24px;color:var(--text3);font-size:13px;text-align:center;">Sin gastos registrados en este perÃ­odo</div>`}
  </div>`;
}

function selectCard(tid){
  selectedTarjetaId=selectedTarjetaId===tid?null:tid;
  renderResumen();
}

/* â•â•â•â•â•â•â•â•â•â•â• GASTOS â•â•â•â•â•â•â•â•â•â•â• */
let gastoGrouping='none';
let gastoPagina=1;
const GASTOS_POR_PAG=20;

function buildFiltrosGastos(){
  // Banco
  const selBanco=document.getElementById('banco-filter');
  const selMarca=document.getElementById('marca-filter');
  const selMes=document.getElementById('mes-filter');
  const selAnio=document.getElementById('anio-filter');
  if(!selBanco||!selMarca||!selMes||!selAnio)return;

  const curBanco=selBanco.value, curMarca=selMarca.value;
  const curMes=selMes.value, curAnio=selAnio.value;

  const bancos=new Set(), marcas=new Set(), meses=new Set(), anios=new Set();
  gastos.forEach(g=>{
    const t=tarjetas.find(t=>t.id===g.tarjeta_id);
    if(t){bancos.add(t.banco);marcas.add(t.nombre);}
    if(g.fecha){
      const[y,m]=g.fecha.slice(0,7).split('-').map(Number);
      meses.add(String(m).padStart(2,'0'));
      anios.add(String(y));
    }
  });

  selBanco.innerHTML='<option value="">Todos los bancos</option>'+
    [...bancos].sort().map(b=>`<option value="${b}"${b===curBanco?' selected':''}>${b}</option>`).join('');

  selMarca.innerHTML='<option value="">Todas las marcas</option>'+
    [...marcas].sort().map(m=>`<option value="${m}"${m===curMarca?' selected':''}>${m}</option>`).join('');

  const MESES_LABEL=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  selMes.innerHTML='<option value="">Todos</option>'+
    [...meses].sort().map(m=>`<option value="${m}"${m===curMes?' selected':''}>${MESES_LABEL[parseInt(m)-1]}</option>`).join('');

  selAnio.innerHTML='<option value="">Todos</option>'+
    [...anios].sort().reverse().map(y=>`<option value="${y}"${y===curAnio?' selected':''}>${y}</option>`).join('');
}

function setGrouping(mode,el){
  gastoGrouping=mode;
  gastoPagina=1;
  document.querySelectorAll('#group-tab-none,#group-tab-month').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  renderGastos();
}

function irPagina(p){
  gastoPagina=p;
  renderGastos();
  document.getElementById('gastos-container').scrollIntoView({behavior:'smooth',block:'start'});
}

function renderPaginacion(total, paginaActual, container){
  const totalPags=Math.ceil(total/GASTOS_POR_PAG);
  if(totalPags<=1)return'';
  const desde=(paginaActual-1)*GASTOS_POR_PAG+1;
  const hasta=Math.min(paginaActual*GASTOS_POR_PAG,total);

  let btns='';
  // Prev
  btns+=`<button class="pag-btn${paginaActual===1?' disabled':''}" onclick="irPagina(${paginaActual-1})" ${paginaActual===1?'disabled':''}>â€¹</button>`;

  // Page numbers - smart window
  let pages=[];
  if(totalPags<=7){
    for(let i=1;i<=totalPags;i++)pages.push(i);
  }else{
    pages=[1];
    let lo=Math.max(2,paginaActual-2), hi=Math.min(totalPags-1,paginaActual+2);
    if(lo>2)pages.push('â€¦');
    for(let i=lo;i<=hi;i++)pages.push(i);
    if(hi<totalPags-1)pages.push('â€¦');
    pages.push(totalPags);
  }

  pages.forEach(p=>{
    if(p==='â€¦') btns+=`<span class="pag-ellipsis">â€¦</span>`;
    else btns+=`<button class="pag-btn${p===paginaActual?' active':''}" onclick="irPagina(${p})">${p}</button>`;
  });

  // Next
  btns+=`<button class="pag-btn${paginaActual===totalPags?' disabled':''}" onclick="irPagina(${paginaActual+1})" ${paginaActual===totalPags?'disabled':''}>â€º</button>`;

  return`<div class="paginacion">
    <span class="pag-info">${desde}â€“${hasta} de ${total}</span>
    <div class="pag-btns">${btns}</div>
  </div>`;
}

function renderGastos(){
  buildFiltrosGastos();
  const container=document.getElementById('gastos-container');
  const now=new Date();

  const bancofiltro=(document.getElementById('banco-filter')||{}).value||'';
  const marcafiltro=(document.getElementById('marca-filter')||{}).value||'';
  const mesfiltro=(document.getElementById('mes-filter')||{}).value||'';
  const aniofiltro=(document.getElementById('anio-filter')||{}).value||'';

  // Ordenar por fecha desc
  let lista=[...gastos].sort((a,b)=>{
    const df=new Date(b.fecha+'T12:00:00')-new Date(a.fecha+'T12:00:00');
    if(df!==0)return df;
    return new Date(b.created_at||0)-new Date(a.created_at||0);
  });

  // Filtro estado
  if(gastoFilter==='pendientes')lista=lista.filter(g=>{const mks=Object.keys(getCuotasPorPeriodo(g)).sort();if(!mks.length)return true;const[y,m]=mks[mks.length-1].split('-').map(Number);return new Date(y,m-1,28)>=now;});
  else if(gastoFilter==='pasados')lista=lista.filter(g=>{const mks=Object.keys(getCuotasPorPeriodo(g)).sort();if(!mks.length)return false;const[y,m]=mks[mks.length-1].split('-').map(Number);return new Date(y,m-1,28)<now;});

  // Filtro banco / marca
  if(bancofiltro||marcafiltro){
    lista=lista.filter(g=>{
      const t=tarjetas.find(t=>t.id===g.tarjeta_id);
      if(!t)return false;
      if(bancofiltro&&t.banco!==bancofiltro)return false;
      if(marcafiltro&&t.nombre!==marcafiltro)return false;
      return true;
    });
  }

  // Filtro mes / aÃ±o
  if(mesfiltro)lista=lista.filter(g=>g.fecha&&g.fecha.slice(5,7)===mesfiltro);
  if(aniofiltro)lista=lista.filter(g=>g.fecha&&g.fecha.slice(0,4)===aniofiltro);

  if(!lista.length){
    gastoPagina=1;
    container.innerHTML=`<div class="detail-glass"><div class="empty-state"><div class="empty-icon">ğŸ›ï¸</div><div class="empty-title">Sin gastos</div><div class="empty-sub">No hay gastos con los filtros seleccionados</div></div></div>`;
    return;
  }

  const rowHTML=(g)=>{
    const t=tarjetas.find(t=>t.id===g.tarjeta_id);
    const cat=g.categoria||'';
    const desc=g.descripcion||'';
    return`<tr>
      <td class="col-desc">
        <div style="font-weight:600;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${desc}</div>
        ${g.nota?`<div style="font-size:11px;color:var(--text3);margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${g.nota}</div>`:''}
      </td>
      <td class="col-cat">${cat?`<span class="pill pill-gray" style="font-size:10px;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:inline-block;">${cat}</span>`:'<span style="color:var(--text3);font-size:12px;">â€”</span>'}</td>
      <td class="col-banco col-tarjeta">${t?`<span class="pill" style="background:${t.color}22;color:${t.color};border:1px solid ${t.color}44;font-size:11px;">${t.banco}</span>`:'â€”'}</td>
      <td class="col-marca col-tarjeta"><span style="font-weight:700;font-size:13px;color:var(--text2);">${t?t.nombre:'â€”'}</span></td>
      <td class="col-fecha" style="color:var(--text3);white-space:nowrap;">${fDate(new Date(g.fecha+'T12:00:00'))}</td>
      <td class="col-monto" style="font-family:'DM Mono',monospace;font-weight:500;font-size:13px;">$${fmt(g.monto)}</td>
      <td class="col-cuotas"><span class="pill pill-gray" style="font-size:10px;white-space:nowrap;">${g.cuotas>1?`${g.cuotas}Ã— $${fmt(g.monto/g.cuotas)}`:'1 pago'}</span></td>
      <td class="col-acc">
        <div style="display:flex;gap:3px;justify-content:flex-end;flex-wrap:nowrap;">
          <button class="btn btn-ghost btn-xs" onclick="openModalEditGasto('${g.id}')" title="Editar" style="padding:5px 8px;">âœ</button>
          <button class="btn btn-danger btn-xs" onclick="deleteGasto('${g.id}')" title="Eliminar" style="padding:5px 8px;">âœ•</button>
        </div>
      </td>
    </tr>`;
  };

  const theadHTML=`<thead><tr>
    <th class="col-desc">DescripciÃ³n</th>
    <th class="col-cat">CategorÃ­a</th>
    <th class="col-banco col-tarjeta">Banco</th>
    <th class="col-marca col-tarjeta">Marca</th>
    <th class="col-fecha">Fecha</th>
    <th class="col-monto">Monto</th>
    <th class="col-cuotas">Cuotas</th>
    <th class="col-acc"></th>
  </tr></thead>`;

  if(gastoGrouping==='month'){
    // En modo agrupado: paginaciÃ³n no aplica, se muestran todos agrupados
    const grupos={};
    lista.forEach(g=>{
      const mk=g.fecha?g.fecha.slice(0,7):'sin-fecha';
      if(!grupos[mk])grupos[mk]=[];
      grupos[mk].push(g);
    });
    const mksOrdenados=Object.keys(grupos).sort().reverse();
    const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    container.innerHTML=mksOrdenados.map(mk=>{
      const items=grupos[mk];
      const[y,m]=mk.split('-').map(Number);
      const label=isNaN(m)?'Sin fecha':MESES[m-1]+' '+y;
      const totalMes=items.reduce((s,g)=>s+g.monto,0);
      return`<div class="mes-grupo" id="grp-${mk}">
        <div class="mes-grupo-head" onclick="toggleGrupo('${mk}')">
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="mes-grupo-chevron" id="chev-${mk}">â–¾</div>
            <span class="mes-grupo-label">${label}</span>
            <span class="mes-grupo-count">${items.length} gasto${items.length!==1?'s':''}</span>
          </div>
          <span class="mes-grupo-total">$${fmt(totalMes)}</span>
        </div>
        <div class="mes-grupo-body" id="grpbody-${mk}">
          <div class="detail-glass" style="border-radius:0 0 var(--r-lg) var(--r-lg);border-top:none;">
            <div style="overflow-x:auto;">
              <table class="data-table">${theadHTML}<tbody>${items.map(rowHTML).join('')}</tbody></table>
            </div>
          </div>
        </div>
      </div>`;
    }).join('');
  } else {
    // PaginaciÃ³n
    const totalItems=lista.length;
    const totalPags=Math.ceil(totalItems/GASTOS_POR_PAG);
    if(gastoPagina>totalPags)gastoPagina=1;
    const slice=lista.slice((gastoPagina-1)*GASTOS_POR_PAG, gastoPagina*GASTOS_POR_PAG);
    const paginaHTML=renderPaginacion(totalItems,gastoPagina,container);
    container.innerHTML=`<div class="detail-glass"><div style="overflow-x:auto;">
      <table class="data-table">${theadHTML}<tbody>${slice.map(rowHTML).join('')}</tbody></table>
    </div></div>
    ${paginaHTML}`;
  }
}

function toggleGrupo(mk){
  const body=document.getElementById('grpbody-'+mk);
  const chev=document.getElementById('chev-'+mk);
  if(!body)return;
  const isOpen=body.style.display!=='none';
  body.style.display=isOpen?'none':'block';
  chev.textContent=isOpen?'â–¸':'â–¾';
}

function filterGastos(f,el){
  gastoFilter=f;
  gastoPagina=1;
  document.querySelectorAll('.filter-tab:not(#group-tab-none):not(#group-tab-month)').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  renderGastos();
}

function openModalGasto(){
  if(!tarjetas.length){showToast('Primero agregÃ¡ una tarjeta','error');return;}
  editingGastoId=null;
  document.getElementById('mg-eyebrow').textContent='Nuevo gasto';
  document.getElementById('mg-title').textContent='Registrar compra';
  document.getElementById('btn-save-gasto').textContent='Registrar';
  document.getElementById('g-tarjeta').innerHTML='<option value="" disabled selected>â€” SeleccionÃ¡ una tarjeta â€”</option>'+tarjetas.map(t=>`<option value="${t.id}">${t.banco} â€“ ${t.nombre}</option>`).join('');
  document.getElementById('g-fecha').value=new Date().toISOString().split('T')[0];
  ['g-monto','g-desc','g-nota'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('g-cuotas').value=1;
  document.getElementById('g-categoria').value='';
  document.getElementById('cuota-preview-wrap').style.display='none';
  openModal('modal-gasto');
}

function openModalEditGasto(id){
  const g=gastos.find(g=>g.id===id);if(!g)return;
  editingGastoId=id;
  document.getElementById('mg-eyebrow').textContent='Editar gasto';
  document.getElementById('mg-title').textContent='Modificar compra';
  document.getElementById('btn-save-gasto').textContent='Guardar cambios';
  document.getElementById('g-tarjeta').innerHTML=tarjetas.map(t=>`<option value="${t.id}"${t.id===g.tarjeta_id?' selected':''}>${t.banco} â€“ ${t.nombre}</option>`).join('');
  document.getElementById('g-desc').value=g.descripcion;
  document.getElementById('g-fecha').value=g.fecha;
  document.getElementById('g-monto').value=g.monto;
  document.getElementById('g-cuotas').value=g.cuotas;
  document.getElementById('g-categoria').value=g.categoria||'';
  document.getElementById('g-nota').value=g.nota||'';
  previewCuotas();
  openModal('modal-gasto');
}

function previewCuotas(){
  const cuotas=parseInt(document.getElementById('g-cuotas').value)||1;
  const monto=parseFloat(document.getElementById('g-monto').value)||0;
  const tid=document.getElementById('g-tarjeta').value;
  const fecha=document.getElementById('g-fecha').value;
  const wrap=document.getElementById('cuota-preview-wrap');
  if(cuotas<=1||!monto||!fecha||!tid){wrap.style.display='none';return;}
  const dist=getCuotasPorPeriodo({tarjeta_id:tid,fecha,monto,cuotas});
  const mks=Object.keys(dist).sort();
  if(!mks.length){wrap.style.display='none';return;}
  document.getElementById('cuota-preview-rows').innerHTML=mks.map((mk,i)=>
    `<div class="cuota-row">
      <span class="cuota-row-label">Cuota ${i+1}/${cuotas} Â· ${mkToShort(mk)}</span>
      <span class="cuota-row-val">$${fmt(monto/cuotas)}</span>
    </div>`
  ).join('');
  wrap.style.display='block';
}

async function saveGasto(){
  const descripcion=document.getElementById('g-desc').value.trim();
  const tarjeta_id=document.getElementById('g-tarjeta').value;
  const fecha=document.getElementById('g-fecha').value;
  const monto=parseFloat(document.getElementById('g-monto').value);
  const cuotas=parseInt(document.getElementById('g-cuotas').value)||1;
  const categoria=document.getElementById('g-categoria').value;
  const nota=document.getElementById('g-nota').value.trim();
  if(!descripcion){showToast('IngresÃ¡ una descripciÃ³n','error');return;}
  if(!fecha){showToast('IngresÃ¡ la fecha','error');return;}
  if(!monto||monto<=0){showToast('IngresÃ¡ un monto vÃ¡lido','error');return;}
  const btn=document.getElementById('btn-save-gasto');
  const isEditing=!!editingGastoId;
  btn.disabled=true;btn.innerHTML='<div class="loader"></div>';
  if(isEditing){
    const{data,error}=await sb.from('gastos').update({descripcion,tarjeta_id,fecha,monto,cuotas,categoria,nota}).eq('id',editingGastoId).select();
    if(error){showToast('Error al actualizar','error');}
    else{const idx=gastos.findIndex(g=>g.id===editingGastoId);if(idx>=0)gastos[idx]=data[0];closeModal('modal-gasto');renderGastos();buildAllPeriods();showToast('Gasto actualizado âœ“');}
  }else{
    const{data,error}=await sb.from('gastos').insert([{descripcion,tarjeta_id,fecha,monto,cuotas,categoria,nota}]).select();
    if(error){showToast('Error al guardar','error');}
    else{gastos.unshift(data[0]);closeModal('modal-gasto');renderGastos();buildAllPeriods();showToast('Gasto registrado âœ“');}
  }
  btn.disabled=false;btn.textContent=isEditing?'Guardar cambios':'Registrar';
}

async function deleteGasto(id){
  if(!confirm('Â¿Eliminar este gasto?'))return;
  const{error}=await sb.from('gastos').delete().eq('id',id);
  if(error){showToast('Error al eliminar','error');return;}
  gastos=gastos.filter(g=>g.id!==id);
  renderGastos();buildAllPeriods();showToast('Gasto eliminado');
}

/* â•â•â•â•â•â•â•â•â•â•â• TARJETAS â•â•â•â•â•â•â•â•â•â•â• */
function renderTarjetas(){
  const grid=document.getElementById('cc-grid');
  const empty=document.getElementById('tarjetas-empty');
  if(!tarjetas.length){grid.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  grid.innerHTML=tarjetas.map(t=>{
    const bg=`linear-gradient(145deg,${t.color},${darken(t.color,35)})`;
    return`<div class="cc-card" style="background:${bg};" onclick="openCierres('${t.id}')">
      <div class="cc-top">
        <div>
          <div class="cc-nombre">${t.nombre}</div>
          <div class="cc-bank">${t.banco}</div>
        </div>
        <div class="cc-nfc" style="font-size:26px;opacity:.4;">â—‰</div>
      </div>
      <div class="cc-mid"><div class="cc-chip-icon">â–£</div></div>
      <div class="cc-bottom">
        <div class="cc-actions" onclick="event.stopPropagation()">
          <button class="cc-action-btn" onclick="openCierres('${t.id}')">ğŸ“… Cierres</button>
          <button class="cc-action-btn" onclick="editTarjeta('${t.id}')">âœ Editar</button>
          <button class="cc-action-btn" onclick="deleteTarjeta('${t.id}')">âœ•</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function darken(hex,amount=35){
  try{
    const r=Math.max(0,parseInt(hex.slice(1,3),16)-amount);
    const g=Math.max(0,parseInt(hex.slice(3,5),16)-amount);
    const b=Math.max(0,parseInt(hex.slice(5,7),16)-amount);
    return`rgb(${r},${g},${b})`;
  }catch{return hex;}
}

function openModalTarjeta(){
  editingTarjetaId=null;
  document.getElementById('mt-eyebrow').textContent='Nueva tarjeta';
  document.getElementById('mt-title').textContent='Agregar tarjeta';
  ['tc-banco','tc-nombre','tc-digitos'].forEach(id=>document.getElementById(id).value='');
  selectedColor='#7c3aed';
  document.querySelectorAll('.cp-dot').forEach(d=>d.classList.toggle('on',d.dataset.color===selectedColor));
  openModal('modal-tarjeta');
}

function editTarjeta(id){
  const t=tarjetas.find(t=>t.id===id);if(!t)return;
  editingTarjetaId=id;
  document.getElementById('mt-eyebrow').textContent='Editar tarjeta';
  document.getElementById('mt-title').textContent='Modificar tarjeta';
  document.getElementById('tc-banco').value=t.banco;
  document.getElementById('tc-nombre').value=t.nombre;
  document.getElementById('tc-digitos').value=t.digitos||'';
  selectedColor=t.color;
  document.querySelectorAll('.cp-dot').forEach(d=>d.classList.toggle('on',d.dataset.color===t.color));
  openModal('modal-tarjeta');
}

async function saveTarjeta(){
  const banco=document.getElementById('tc-banco').value.trim();
  const nombre=document.getElementById('tc-nombre').value.trim();
  const digitos=document.getElementById('tc-digitos').value.trim();
  if(!banco){showToast('IngresÃ¡ el nombre del banco','error');return;}
  if(!nombre){showToast('IngresÃ¡ el nombre de la tarjeta','error');return;}
  const btn=document.getElementById('btn-save-tarjeta');
  btn.disabled=true;btn.innerHTML='<div class="loader"></div>';
  if(editingTarjetaId){
    const{error}=await sb.from('tarjetas').update({banco,nombre,digitos,color:selectedColor}).eq('id',editingTarjetaId);
    if(error){showToast('Error al actualizar','error');}
    else{Object.assign(tarjetas.find(t=>t.id===editingTarjetaId),{banco,nombre,digitos,color:selectedColor});closeModal('modal-tarjeta');renderTarjetas();showToast('Tarjeta actualizada âœ“');}
  }else{
    const{data,error}=await sb.from('tarjetas').insert([{banco,nombre,digitos,color:selectedColor}]).select();
    if(error){showToast('Error al guardar','error');}
    else{tarjetas.push(data[0]);closeModal('modal-tarjeta');renderTarjetas();showToast('Tarjeta creada âœ“');}
  }
  btn.disabled=false;btn.textContent='Guardar';
}

async function deleteTarjeta(id){
  if(!confirm('Â¿Eliminar esta tarjeta y todos sus datos?'))return;
  const{error}=await sb.from('tarjetas').delete().eq('id',id);
  if(error){showToast('Error al eliminar','error');return;}
  tarjetas=tarjetas.filter(t=>t.id!==id);
  cierres=cierres.filter(c=>c.tarjeta_id!==id);
  gastos=gastos.filter(g=>g.tarjeta_id!==id);
  renderTarjetas();
  document.getElementById('cierres-panel').classList.remove('open');
  showToast('Tarjeta eliminada');
}

function pickColor(el){
  selectedColor=el.dataset.color;
  document.querySelectorAll('.cp-dot').forEach(d=>d.classList.remove('on'));
  el.classList.add('on');
}

/* â•â•â•â•â•â•â•â•â•â•â• CIERRES â•â•â•â•â•â•â•â•â•â•â• */
function openCierres(tid){
  const t=tarjetas.find(t=>t.id===tid);
  document.getElementById('cierres-bank').textContent=`${t.banco} â€” ${t.nombre}`;
  const panel=document.getElementById('cierres-panel');
  panel.classList.add('open');panel.dataset.tid=tid;
  renderCierresGrid(tid);
  setTimeout(()=>panel.scrollIntoView({behavior:'smooth',block:'nearest'}),50);
}

function renderCierresGrid(tid){
  const now=new Date();
  const MESES=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  let html='';
  for(let o=-3;o<=9;o++){
    const d=new Date(now.getFullYear(),now.getMonth()+o,1);
    const mk=getMonthKey(d.getFullYear(),d.getMonth());
    const cierre=cierres.find(c=>c.tarjeta_id===tid&&c.mes_key===mk);
    const dia=cierre?cierre.dia:'';
    html+=`<div class="cierre-cell">
      <div class="cierre-month">${MESES[d.getMonth()]} ${d.getFullYear()}</div>
      <div class="cierre-input-row">
        <input type="number" min="1" max="31" placeholder="â€”"
          style="width:62px;padding:7px 10px;font-size:14px;font-weight:700;" value="${dia}"
          onchange="saveCierre('${tid}','${mk}',this.value,'${cierre?cierre.id:''}')">
        <span class="cierre-val" id="cv-${mk}">${dia?'dÃ­a '+dia:''}</span>
      </div>
    </div>`;
  }
  document.getElementById('cierres-grid').innerHTML=html;
}

async function saveCierre(tid,mk,valor,existingId){
  const dia=parseInt(valor);
  if(dia>=1&&dia<=31){
    if(existingId){
      const{error}=await sb.from('cierres').update({dia}).eq('id',existingId);
      if(!error){const c=cierres.find(c=>c.id===existingId);if(c)c.dia=dia;const lbl=document.getElementById('cv-'+mk);if(lbl)lbl.textContent='dÃ­a '+dia;}
    }else{
      const{data,error}=await sb.from('cierres').insert([{tarjeta_id:tid,mes_key:mk,dia}]).select();
      if(!error){cierres.push(data[0]);renderCierresGrid(tid);}
    }
    buildAllPeriods();showToast('Cierre guardado âœ“');
  }else if(!valor&&existingId){
    await sb.from('cierres').delete().eq('id',existingId);
    cierres=cierres.filter(c=>c.id!==existingId);
    renderCierresGrid(tid);buildAllPeriods();
  }
}

function closeCierres(){document.getElementById('cierres-panel').classList.remove('open');}

/* â•â•â•â•â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•â•â•â•â• */
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}

function fmt(n){
  if(!n)return'0';
  const r=Math.round(n*100)/100;
  return r%1===0?r.toLocaleString('es-AR'):r.toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2});
}

function fDate(d){
  if(!d||isNaN(d))return'â€”';
  return`${d.getDate()} ${['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][d.getMonth()]} ${d.getFullYear()}`;
}

function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className=`toast show ${type}`;
  clearTimeout(t._tmr);
  t._tmr=setTimeout(()=>t.className='toast',3200);
}

document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

/* â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â• */
// âš ï¸ CambiÃ¡ este hash por el de tu contraseÃ±a.
// Para generarlo: abrÃ­ la consola del navegador y ejecutÃ¡:
// crypto.subtle.digest('SHA-256', new TextEncoder().encode('tuContraseÃ±a'))
//   .then(b => console.log([...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,'0')).join('')))
// ContraseÃ±a actual: tarjetapp2024
const PASS_HASH = 'aea46a31458a27292c8a3107590aca20076c35b24f140b23cd80272e7776bd12';

const SESSION_KEY  = 'ta_auth_ts';
const SESSION_HOURS = 12; // horas antes de pedir contraseÃ±a de nuevo
const FP_CRED_KEY  = 'ta_fp_cred';
const RP_ID        = location.hostname || 'localhost';
const RP_NAME      = 'TarjetApp';

async function hashPassword(pwd){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pwd));
  return [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,'0')).join('');
}

function isSessionValid(){
  const ts = localStorage.getItem(SESSION_KEY);
  if(!ts) return false;
  return (Date.now() - parseInt(ts)) < SESSION_HOURS * 3600 * 1000;
}

function setSession(){ localStorage.setItem(SESSION_KEY, Date.now()); }

function hasFingerprintCred(){
  return !!localStorage.getItem(FP_CRED_KEY);
}

function base64ToBuffer(b64){
  return Uint8Array.from(atob(b64.replace(/-/g,'+').replace(/_/g,'/')), c=>c.charCodeAt(0));
}
function bufferToBase64(buf){
  return btoa(String.fromCharCode(...new Uint8Array(buf)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}

async function registerFingerprint(){
  if(!window.PublicKeyCredential){ showToast('WebAuthn no soportado en este dispositivo','error'); return; }
  const btn=document.getElementById('auth-reg-fp-wrap').querySelector('button');
  btn.disabled=true; btn.textContent='Registrandoâ€¦';
  try{
    const challenge = crypto.getRandomValues(new Uint8Array(32));
    const userId    = crypto.getRandomValues(new Uint8Array(16));
    const cred = await navigator.credentials.create({ publicKey:{
      challenge,
      rp:{ id: RP_ID, name: RP_NAME },
      user:{ id: userId, name:'usuario', displayName:'TarjetApp User' },
      pubKeyCredParams:[{type:'public-key',alg:-7},{type:'public-key',alg:-257}],
      authenticatorSelection:{ authenticatorAttachment:'platform', userVerification:'required' },
      timeout: 60000,
    }});
    localStorage.setItem(FP_CRED_KEY, JSON.stringify({
      id: bufferToBase64(cred.rawId),
      type: cred.type,
    }));
    showToast('Huella registrada âœ“ Ya podÃ©s usarla para ingresar');
    document.getElementById('auth-fp-wrap').style.display='block';
    document.getElementById('auth-reg-fp-wrap').style.display='none';
  }catch(e){
    showToast('No se pudo registrar la huella','error');
    console.error(e);
  }
  btn.disabled=false; btn.textContent='ï¼‹ Registrar huella dactilar';
}

async function tryFingerprint(){
  if(!window.PublicKeyCredential){ showToast('WebAuthn no soportado','error'); return; }
  const stored = localStorage.getItem(FP_CRED_KEY);
  if(!stored){ showToast('No hay huella registrada','error'); return; }
  const { id } = JSON.parse(stored);
  const btn = document.getElementById('auth-fp-btn');
  btn.disabled=true;
  document.getElementById('auth-fp-label').textContent='Verificandoâ€¦';
  try{
    const challenge = crypto.getRandomValues(new Uint8Array(32));
    await navigator.credentials.get({ publicKey:{
      challenge,
      rpId: RP_ID,
      allowCredentials:[{ id: base64ToBuffer(id), type:'public-key' }],
      userVerification:'required',
      timeout: 60000,
    }});
    setSession();
    hideAuth();
  }catch(e){
    if(e.name !== 'NotAllowedError'){
      showToast('Error de autenticaciÃ³n','error');
      console.error(e);
    }
  }
  btn.disabled=false;
  document.getElementById('auth-fp-label').textContent='Usar huella dactilar';
}

async function tryLogin(){
  const val = document.getElementById('auth-input').value;
  const errEl = document.getElementById('auth-error');
  errEl.textContent='';
  if(!val){ errEl.textContent='IngresÃ¡ tu contraseÃ±a'; return; }
  const hash = await hashPassword(val);
  if(hash !== PASS_HASH){
    errEl.textContent='ContraseÃ±a incorrecta';
    document.getElementById('auth-input').value='';
    document.getElementById('auth-input').focus();
    // Shake animation
    const card = document.getElementById('auth-card-password');
    card.style.animation='shake .4s ease';
    setTimeout(()=>card.style.animation='',400);
    return;
  }
  setSession();
  // Si nunca registrÃ³ huella, ofrecer registro ahora
  if(window.PublicKeyCredential && !hasFingerprintCred()){
    const offer = confirm('Â¿QuerÃ©s registrar tu huella dactilar para la prÃ³xima vez?');
    if(offer) await registerFingerprint();
  }
  hideAuth();
}

function toggleAuthVis(){
  const inp = document.getElementById('auth-input');
  inp.type = inp.type==='password' ? 'text' : 'password';
}

function showAuth(){
  const screen = document.getElementById('auth-screen');
  screen.style.display='flex';
  setTimeout(()=>document.getElementById('auth-input').focus(), 100);

  // Mostrar opciÃ³n de huella si hay credencial registrada
  if(window.PublicKeyCredential && hasFingerprintCred()){
    document.getElementById('auth-fp-wrap').style.display='block';
    document.getElementById('auth-reg-fp-wrap').style.display='none';
  } else if(window.PublicKeyCredential){
    document.getElementById('auth-fp-wrap').style.display='none';
    document.getElementById('auth-reg-fp-wrap').style.display='block';
  }
}

function hideAuth(){
  const screen = document.getElementById('auth-screen');
  screen.style.transition='opacity .3s';
  screen.style.opacity='0';
  setTimeout(()=>{ screen.style.display='none'; screen.style.opacity='1'; loadAndRender(); }, 300);
}

// Shake keyframe (aÃ±adir al CSS dinÃ¡micamente)
const shakeStyle=document.createElement('style');
shakeStyle.textContent=`@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}`;
document.head.appendChild(shakeStyle);

init();
</script>
</body>
</html>
