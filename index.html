<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TarjetApp ¬∑ Fintech Experience</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #0F1115;
  --surface: #1A1D23;
  --surface-lp: rgba(255, 255, 255, 0.05);
  --accent: #22C55E;
  --accent-glow: rgba(34, 197, 94, 0.3);
  --text-main: #FFFFFF;
  --text-dim: #94A3B8;
  --border: rgba(255, 255, 255, 0.08);
  --r-xl: 24px;
  --r-lg: 16px;
  --r-md: 12px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: var(--text-main); line-height: 1.5; overflow-x: hidden; }

/* Sidebar Glassmorphism */
.sidebar {
  width: 260px; background: rgba(26, 29, 35, 0.9); backdrop-filter: blur(12px);
  border-right: 1px solid var(--border); height: 100vh; position: fixed;
  padding: 32px 20px; z-index: 100; display: flex; flex-direction: column;
}
.brand { display: flex; align-items: center; gap: 12px; margin-bottom: 48px; padding-left: 10px; }
.brand-icon { 
    width: 40px; height: 40px; background: var(--accent); border-radius: 12px; 
    display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px var(--accent-glow); 
}
.brand-name { font-weight: 800; font-size: 20px; letter-spacing: -0.5px; }

.nav-item {
  padding: 14px 16px; border-radius: var(--r-md); color: var(--text-dim);
  text-decoration: none; display: flex; align-items: center; gap: 12px;
  margin-bottom: 8px; transition: var(--transition); cursor: pointer;
  border: none; background: transparent; font-size: 15px; font-weight: 600; width: 100%; text-align: left;
}
.nav-item:hover { background: var(--surface-lp); color: var(--text-main); }
.nav-item.active { background: var(--accent); color: #000; }

.main-content { margin-left: 260px; padding: 40px; max-width: 1200px; min-height: 100vh; }

/* Bento Cards */
.stats-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
.bento-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-xl);
  padding: 24px; transition: var(--transition); position: relative; overflow: hidden;
}
.total-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-left: 4px solid var(--accent); }
.stat-label { color: var(--text-dim); font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
.stat-value { font-size: 32px; font-weight: 800; margin: 8px 0; font-variant-numeric: tabular-nums; }

/* Tablas Modernas */
.table-container { background: var(--surface); border-radius: var(--r-lg); border: 1px solid var(--border); overflow: hidden; }
.modern-table { width: 100%; border-collapse: collapse; }
.modern-table th { background: rgba(255,255,255,0.02); padding: 16px 24px; text-align: left; color: var(--text-dim); font-size: 11px; font-weight: 700; text-transform: uppercase; }
.modern-table td { padding: 18px 24px; border-top: 1px solid var(--border); font-size: 14px; }

/* Botones */
.btn-primary { 
    background: var(--accent); color: #000; padding: 12px 24px; border-radius: 12px; 
    font-weight: 700; border: none; cursor: pointer; transition: var(--transition); 
}
.btn-primary:hover { box-shadow: 0 0 20px var(--accent-glow); transform: translateY(-2px); }

/* Loader */
#loading-screen {
  position: fixed; inset: 0; background: #0F1115; z-index: 1000;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
}

/* Period Navigator */
.period-nav {
  display: flex; align-items: center; gap: 15px; margin-bottom: 30px;
  background: var(--surface); padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border); width: fit-content;
}
.nav-btn { background: none; border: none; color: white; cursor: pointer; font-size: 20px; padding: 5px 10px; border-radius: 50%; }
.nav-btn:hover { background: var(--surface-lp); }

@media (max-width: 768px) {
  .sidebar { width: 100%; height: 70px; bottom: 0; top: auto; flex-direction: row; justify-content: space-around; padding: 10px; border-right: none; border-top: 1px solid var(--border); }
  .brand, .nav-item span:not(.nav-icon) { display: none; }
  .main-content { margin-left: 0; padding: 20px; margin-bottom: 80px; }
  .stats-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div id="loading-screen">
  <div class="brand-icon" style="width:60px; height:60px; margin-bottom:20px;">
    <svg viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
  </div>
  <p style="font-weight:700; letter-spacing:2px; color: white;">CARGANDO FINANZAS...</p>
</div>

<aside class="sidebar">
  <div class="brand">
    <div class="brand-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2.5"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
    </div>
    <div class="brand-name">Tarjet<span>App</span></div>
  </div>
  <button class="nav-item active" onclick="showPage('resumen',this)"><span class="nav-icon">üìä</span> <span>Dashboard</span></button>
  <button class="nav-item" onclick="showPage('gastos',this)"><span class="nav-icon">üí∏</span> <span>Movimientos</span></button>
  <button class="nav-item" onclick="showPage('tarjetas',this)"><span class="nav-icon">üí≥</span> <span>Tarjetas</span></button>
</aside>

<main class="main-content">
  <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
    <div>
      <h1 id="topbar-title" style="font-size:28px; font-weight:800;">Dashboard</h1>
      <p id="topbar-sub" style="color:var(--text-dim); font-size: 14px;">Resumen de tus consumos.</p>
    </div>
    <div id="topbar-actions"></div>
  </header>

  <div id="page-resumen" class="page-content">
    <div class="period-nav">
       <button class="nav-btn" onclick="changePeriod(-1)">‚Üê</button>
       <span id="period-month" style="font-weight:700; min-width:140px; text-align:center;">Cargando...</span>
       <button class="nav-btn" onclick="changePeriod(1)">‚Üí</button>
    </div>
    <div class="stats-grid" id="stats-row"></div>
    <div id="detail-area"></div>
  </div>

  <div id="page-gastos" class="page-content" style="display:none;">
    <div class="table-container">
      <table class="modern-table">
        <thead><tr><th>Concepto</th><th>Tarjeta</th><th>Fecha</th><th style="text-align:right;">Monto</th><th></th></tr></thead>
        <tbody id="gastos-tbody"></tbody>
      </table>
    </div>
  </div>

  <div id="page-tarjetas" class="page-content" style="display:none;">
    <div id="cc-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;"></div>
  </div>
</main>

<script>
// --- TU L√ìGICA ORIGINAL DE SUPABASE ---
const SURL = 'https://ndiunufkwvgyrbtqctwp.supabase.co';
const SKEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXVudWZrd3ZneXJidHFjdHdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDE3NDksImV4cCI6MjA4NzE3Nzc0OX0.jwry-uF9hstCHLrQyq4OfeGfarsxBaxich6enVOLR2U';
const sb = supabase.createClient(SURL, SKEY);

let tarjetas = [], cierres = [], gastos = [];
let allPeriods = [], currentPeriodIdx = 0;
let selectedTarjetaId = null;

async function init() {
  try {
    const [t, c, g] = await Promise.all([
      sb.from('tarjetas').select('*').order('created_at'),
      sb.from('cierres').select('*'),
      sb.from('gastos').select('*').order('created_at', { ascending: false }),
    ]);
    tarjetas = t.data; cierres = c.data; gastos = g.data;
    buildAllPeriods(); setCurrentPeriod(); renderResumen();
    document.getElementById('loading-screen').style.display = 'none';
  } catch (e) { console.error(e); }
}

function buildAllPeriods() {
  const now = new Date();
  const mkNow = getMonthKey(now.getFullYear(), now.getMonth());
  const res = new Set();
  res.add(mkNow);
  gastos.forEach(g => {
    const mk0 = getCierreForFecha(g.tarjeta_id, g.fecha);
    let mk = mk0;
    for(let i=0; i<g.cuotas; i++){ res.add(mk); mk = nextMk(mk); }
  });
  allPeriods = [...res].sort();
}

function getMonthKey(y, m) { return `${y}-${String(m + 1).padStart(2, '0')}`; }
function nextMk(mk) { const [y, m] = mk.split('-').map(Number); const d = new Date(y, m, 1); return getMonthKey(d.getFullYear(), d.getMonth()); }
function getCierreDia(tid, mk) { const c = cierres.find(c => c.tarjeta_id === tid && c.mes_key === mk); return c ? c.dia : 20; }
function getCierreForFecha(tid, fechaStr) {
  const fc = new Date(fechaStr + 'T12:00:00');
  const mk = getMonthKey(fc.getFullYear(), fc.getMonth());
  const dia = getCierreDia(tid, mk);
  return (fc.getDate() > dia) ? nextMk(mk) : mk;
}

function setCurrentPeriod() {
  const mkN = getMonthKey(new Date().getFullYear(), new Date().getMonth());
  const idx = allPeriods.indexOf(mkN);
  currentPeriodIdx = idx >= 0 ? idx : allPeriods.length - 1;
}

function renderResumen() {
  const mk = allPeriods[currentPeriodIdx];
  document.getElementById('period-month').textContent = mk;
  
  let totalGeneral = 0;
  const resumenHTML = tarjetas.map(t => {
    let tTotal = 0;
    gastos.forEach(g => {
        if(g.tarjeta_id !== t.id) return;
        const mk0 = getCierreForFecha(g.tarjeta_id, g.fecha);
        let mki = mk0;
        for(let i=0; i<g.cuotas; i++) { if(mki === mk) tTotal += (g.monto/g.cuotas); mki = nextMk(mki); }
    });
    totalGeneral += tTotal;
    return `
      <div class="bento-card" onclick="selectedTarjetaId='${t.id}';renderResumen()">
        <div class="stat-label">${t.banco}</div>
        <div class="stat-value">$${tTotal.toLocaleString('es-AR')}</div>
      </div>`;
  }).join('');

  document.getElementById('stats-row').innerHTML = `
    <div class="bento-card total-card">
      <div class="stat-label">Total del Mes</div>
      <div class="stat-value">$${totalGeneral.toLocaleString('es-AR')}</div>
    </div>` + resumenHTML;
}

function showPage(page, btn) {
    document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
    document.getElementById('page-' + page).style.display = 'block';
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    btn.classList.add('active');
    if(page === 'gastos') renderGastos();
    if(page === 'tarjetas') renderTarjetas();
}

function changePeriod(dir) {
    currentPeriodIdx = Math.max(0, Math.min(allPeriods.length - 1, currentPeriodIdx + dir));
    renderResumen();
}

function renderGastos() {
    document.getElementById('gastos-tbody').innerHTML = gastos.map(g => `
        <tr>
            <td><b>${g.descripcion}</b></td>
            <td>${tarjetas.find(t=>t.id===g.tarjeta_id)?.banco || '‚Äî'}</td>
            <td>${g.fecha}</td>
            <td style="text-align:right;">$${g.monto.toLocaleString()}</td>
            <td><span style="font-size:11px; opacity:0.6">${g.cuotas} cuotas</span></td>
        </tr>`).join('');
}

function renderTarjetas() {
    document.getElementById('cc-grid').innerHTML = tarjetas.map(t => `
        <div class="bento-card" style="border-top: 4px solid ${t.color}">
            <div class="stat-label">${t.nombre}</div>
            <div class="stat-value" style="font-size:18px">${t.banco}</div>
            <div style="margin-top:10px; opacity:0.5">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${t.digitos}</div>
        </div>`).join('');
}

init();
</script>
</body>
</html>
