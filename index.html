<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TarjetApp ‚Äî Gesti√≥n de Gastos</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --bg: #0e0f11; --surface: #16181c; --surface2: #1e2128; --border: #2a2d35;
    --accent: #c8f135; --danger: #ff5252; --text: #f0f2f5; --muted: #7a7f8e;
    --radius: 14px; --transition: .22s cubic-bezier(.4,0,.2,1);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Mono', monospace; font-size: 14px; min-height: 100vh; }
  .app { display: flex; min-height: 100vh; }
  .sidebar { width: 220px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 28px 0; flex-shrink: 0; position: sticky; top: 0; height: 100vh; }
  .logo { padding: 0 24px 32px; font-family: 'Syne', sans-serif; font-weight: 800; font-size: 22px; letter-spacing: -0.5px; }
  .logo span { color: var(--accent); }
  .nav-item { display: flex; align-items: center; gap: 12px; padding: 13px 24px; cursor: pointer; color: var(--muted); font-size: 13px; border-left: 3px solid transparent; transition: all var(--transition); user-select: none; }
  .nav-item:hover { color: var(--text); background: var(--surface2); }
  .nav-item.active { color: var(--accent); border-left-color: var(--accent); background: rgba(200,241,53,.06); }
  .nav-icon { font-size: 17px; width: 22px; text-align: center; }
  .main { flex: 1; padding: 40px 48px; max-width: 1100px; }
  .page-header { margin-bottom: 36px; }
  .page-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 30px; letter-spacing: -1px; }
  .page-sub { color: var(--muted); margin-top: 6px; font-size: 13px; }
  .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 500; transition: all var(--transition); }
  .btn-primary { background: var(--accent); color: #111; }
  .btn-primary:hover { background: #d8ff4a; transform: translateY(-1px); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--border); }
  .btn-danger { background: rgba(255,82,82,.15); color: var(--danger); border: 1px solid rgba(255,82,82,.3); }
  .btn-danger:hover { background: rgba(255,82,82,.25); }
  .btn-sm { padding: 6px 14px; font-size: 12px; }
  .btn:disabled { opacity: .5; cursor: not-allowed; transform: none !important; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; }
  .form-grid { display: grid; gap: 16px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  label { display: block; color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .8px; margin-bottom: 6px; }
  input, select { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px; transition: border-color var(--transition); outline: none; }
  input:focus, select:focus { border-color: var(--accent); }
  select option { background: var(--surface2); }
  .credit-card-preview { border-radius: 16px; padding: 24px; min-height: 160px; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; cursor: pointer; transition: transform var(--transition), box-shadow var(--transition); }
  .credit-card-preview:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,.4); }
  .credit-card-preview::before { content: ''; position: absolute; width: 200px; height: 200px; border-radius: 50%; background: rgba(255,255,255,.07); top: -60px; right: -60px; }
  .cc-bank { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; color: rgba(0,0,0,.7); }
  .cc-name { font-size: 12px; color: rgba(0,0,0,.5); margin-top: 2px; }
  .cc-actions { display: flex; gap: 8px; margin-top: 8px; }
  .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap: 20px; margin-bottom: 32px; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .8px; padding: 0 16px 12px; font-weight: 500; }
  td { padding: 14px 16px; border-top: 1px solid var(--border); font-size: 13px; }
  tr:hover td { background: rgba(255,255,255,.02); }
  .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; color: #111; }
  .total-row td { font-weight: 600; color: var(--accent); border-top: 2px solid var(--border); }
  .period-selector { display: flex; align-items: center; gap: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 10px 16px; width: fit-content; margin-bottom: 28px; }
  .period-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 18px; transition: color var(--transition); padding: 0 4px; }
  .period-btn:hover { color: var(--accent); }
  .period-label { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; min-width: 220px; text-align: center; }
  .summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: 16px; margin-bottom: 28px; }
  .summary-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
  .summary-card .s-label { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .8px; margin-bottom: 10px; }
  .summary-card .s-amount { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 26px; letter-spacing: -1px; }
  .summary-card .s-sub { color: var(--muted); font-size: 11px; margin-top: 4px; }
  .cc-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
  .progress-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin-top: 8px; }
  .progress-fill { height: 100%; border-radius: 2px; transition: width .5s ease; }
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.7); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 18px; padding: 32px; width: 520px; max-width: 95vw; max-height: 90vh; overflow-y: auto; animation: slideUp .25s ease; }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .modal-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 20px; }
  .modal-close { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 22px; }
  .modal-close:hover { color: var(--text); }
  .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }
  .tabs { display: flex; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 4px; width: fit-content; margin-bottom: 24px; }
  .tab { padding: 8px 18px; border-radius: 7px; cursor: pointer; font-size: 12px; color: var(--muted); transition: all var(--transition); }
  .tab.active { background: var(--accent); color: #111; font-weight: 600; }
  .color-picker { display: flex; gap: 10px; flex-wrap: wrap; }
  .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; transition: transform var(--transition); border: 3px solid transparent; }
  .color-dot:hover { transform: scale(1.15); }
  .color-dot.selected { border-color: white; }
  .page { display: none; }
  .page.active { display: block; }
  .empty { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty-icon { font-size: 40px; margin-bottom: 12px; }
  .cuota-badge { font-size: 10px; color: var(--muted); background: var(--surface2); border-radius: 4px; padding: 2px 6px; margin-left: 6px; }
  input[type=number] { -moz-appearance: textfield; }
  input[type=number]::-webkit-inner-spin-button { display: none; }
  .toast { position: fixed; bottom: 28px; right: 28px; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 20px; font-size: 13px; z-index: 999; display: none; }
  .toast.show { display: flex; align-items: center; gap: 10px; animation: slideUp .2s ease; }
  .toast.success { border-color: var(--accent); color: var(--accent); }
  .toast.error { border-color: var(--danger); color: var(--danger); }
  .loader { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-overlay { position: fixed; inset: 0; background: rgba(14,15,17,.9); z-index: 200; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px; }
  .loading-overlay .loader { width: 36px; height: 36px; border-width: 3px; }
  @media (max-width: 768px) {
    .sidebar { width: 60px; }
    .nav-item span:not(.nav-icon) { display: none; }
    .logo { padding: 0 16px 32px; font-size: 0; }
    .logo span { font-size: 22px; }
    .main { padding: 24px 16px; }
    .form-row { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="loading-overlay" id="loading-overlay">
  <div class="loader"></div>
  <div style="color:var(--muted);font-size:13px;">Conectando con Supabase...</div>
</div>

<div class="app">
  <nav class="sidebar">
    <div class="logo"><span>T</span>arjetApp</div>
    <div class="nav-item active" onclick="showPage('resumen',this)"><span class="nav-icon">üìä</span><span>Resumen</span></div>
    <div class="nav-item" onclick="showPage('gastos',this)"><span class="nav-icon">üí≥</span><span>Gastos</span></div>
    <div class="nav-item" onclick="showPage('tarjetas',this)"><span class="nav-icon">üóÇÔ∏è</span><span>Tarjetas</span></div>
    <div style="flex:1"></div>
    <div style="padding:16px 24px;font-size:11px;display:flex;align-items:center;gap:6px;">
      <span id="sync-dot" style="width:6px;height:6px;border-radius:50%;background:var(--muted);display:inline-block;flex-shrink:0;"></span>
      <span id="sync-text" style="color:var(--muted);">Conectando...</span>
    </div>
  </nav>

  <main class="main">

    <!-- RESUMEN -->
    <div class="page active" id="page-resumen">
      <div class="page-header">
        <div class="page-title">Resumen por Per√≠odo</div>
        <div class="page-sub">Gastos de cada per√≠odo de facturaci√≥n</div>
      </div>
      <div class="period-selector">
        <button class="period-btn" onclick="changePeriod(-1)">‚Äπ</button>
        <div class="period-label" id="period-label">‚Äî</div>
        <button class="period-btn" onclick="changePeriod(1)">‚Ä∫</button>
      </div>
      <div id="resumen-content"></div>
    </div>

    <!-- GASTOS -->
    <div class="page" id="page-gastos">
      <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div><div class="page-title">Gastos</div><div class="page-sub">Registr√° cada compra, en una o m√°s cuotas</div></div>
        <button class="btn btn-primary" onclick="openModalGasto()">Ôºã Nuevo gasto</button>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="filterGastos('todos',this)">Todos</div>
        <div class="tab" onclick="filterGastos('pendientes',this)">Pendientes</div>
        <div class="tab" onclick="filterGastos('pasados',this)">Pasados</div>
      </div>
      <div class="card" style="padding:0;overflow:hidden;">
        <table>
          <thead><tr><th>Descripci√≥n</th><th>Tarjeta</th><th>Fecha</th><th>Monto total</th><th>Cuotas</th><th></th></tr></thead>
          <tbody id="gastos-tbody"></tbody>
        </table>
        <div id="gastos-empty" class="empty" style="display:none;">
          <div class="empty-icon">üõçÔ∏è</div><div>No hay gastos registrados</div>
          <div style="margin-top:8px;font-size:12px;">Hac√© clic en "Nuevo gasto" para empezar</div>
        </div>
      </div>
    </div>

    <!-- TARJETAS -->
    <div class="page" id="page-tarjetas">
      <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div><div class="page-title">Mis Tarjetas</div><div class="page-sub">Configur√° cada tarjeta y sus fechas de cierre</div></div>
        <button class="btn btn-primary" onclick="openModalTarjeta()">Ôºã Nueva tarjeta</button>
      </div>
      <div class="cards-grid" id="cards-grid"></div>
      <div id="tarjetas-empty" class="empty" style="display:none;">
        <div class="empty-icon">üí≥</div><div>No hay tarjetas cargadas</div>
      </div>
      <div id="cierres-section" style="display:none;">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <div>
              <div id="cierre-titulo" style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;"></div>
              <div style="color:var(--muted);font-size:12px;margin-top:2px;">Ingres√° el d√≠a de cierre de cada mes</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="closeCierres()">‚úï Cerrar</button>
          </div>
          <div id="cierres-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;"></div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- MODAL TARJETA -->
<div class="modal-overlay" id="modal-tarjeta">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-tarjeta-title">Nueva Tarjeta</div>
      <button class="modal-close" onclick="closeModal('modal-tarjeta')">√ó</button>
    </div>
    <div class="form-grid">
      <div><label>Banco / Emisor</label><input type="text" id="tc-banco" placeholder="Ej: Galicia, BBVA..."></div>
      <div><label>Nombre de la tarjeta</label><input type="text" id="tc-nombre" placeholder="Ej: Visa Gold..."></div>
      <div><label>√öltimos 4 d√≠gitos (opcional)</label><input type="text" id="tc-digitos" maxlength="4" placeholder="1234"></div>
      <div>
        <label>Color</label>
        <div class="color-picker">
          <div class="color-dot selected" style="background:#c8f135" data-color="#c8f135" onclick="selectColor(this)"></div>
          <div class="color-dot" style="background:#5b8fff" data-color="#5b8fff" onclick="selectColor(this)"></div>
          <div class="color-dot" style="background:#ff9f40" data-color="#ff9f40" onclick="selectColor(this)"></div>
          <div class="color-dot" style="background:#ff5e9e" data-color="#ff5e9e" onclick="selectColor(this)"></div>
          <div class="color-dot" style="background:#4dd9ac" data-color="#4dd9ac" onclick="selectColor(this)"></div>
          <div class="color-dot" style="background:#e8c547" data-color="#e8c547" onclick="selectColor(this)"></div>
          <div class="color-dot" style="background:#cc66ff" data-color="#cc66ff" onclick="selectColor(this)"></div>
          <div class="color-dot" style="background:#ff6b6b" data-color="#ff6b6b" onclick="selectColor(this)"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-tarjeta')">Cancelar</button>
      <button class="btn btn-primary" id="btn-save-tarjeta" onclick="saveTarjeta()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL GASTO -->
<div class="modal-overlay" id="modal-gasto">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Registrar Gasto</div>
      <button class="modal-close" onclick="closeModal('modal-gasto')">√ó</button>
    </div>
    <div class="form-grid">
      <div><label>Descripci√≥n</label><input type="text" id="g-desc" placeholder="Ej: Supermercado, Netflix..."></div>
      <div class="form-row">
        <div><label>Tarjeta</label><select id="g-tarjeta" onchange="previewCuotas()"></select></div>
        <div><label>Fecha de compra</label><input type="date" id="g-fecha" onchange="previewCuotas()"></div>
      </div>
      <div class="form-row">
        <div><label>Monto total ($)</label><input type="number" id="g-monto" placeholder="0.00" min="0" step="0.01" oninput="previewCuotas()"></div>
        <div><label>Cantidad de cuotas</label><input type="number" id="g-cuotas" value="1" min="1" max="60" oninput="previewCuotas()"></div>
      </div>
      <div id="cuotas-preview" style="display:none;">
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;">
          <div style="color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;">Preview de cuotas</div>
          <div id="cuotas-preview-content"></div>
        </div>
      </div>
      <div>
        <label>Categor√≠a (opcional)</label>
        <select id="g-categoria">
          <option value="">Sin categor√≠a</option>
          <option>üõí Supermercado</option><option>üçΩÔ∏è Restaurantes</option>
          <option>‚õΩ Combustible</option><option>üè• Salud</option>
          <option>‚úàÔ∏è Viajes</option><option>üé¨ Entretenimiento</option>
          <option>üëó Ropa</option><option>üè† Hogar</option>
          <option>üì± Tecnolog√≠a</option><option>üíº Trabajo</option>
          <option>üéì Educaci√≥n</option><option>Otro</option>
        </select>
      </div>
      <div><label>Nota (opcional)</label><input type="text" id="g-nota" placeholder="Detalle adicional..."></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-gasto')">Cancelar</button>
      <button class="btn btn-primary" id="btn-save-gasto" onclick="saveGasto()">Registrar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SUPABASE_URL = 'https://ndiunufkwvgyrbtqctwp.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXVudWZrd3ZneXJidHFjdHdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDE3NDksImV4cCI6MjA4NzE3Nzc0OX0.jwry-uF9hstCHLrQyq4OfeGfarsxBaxich6enVOLR2U';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let tarjetas = [], cierres = [], gastos = [];
let selectedColor = '#c8f135', editingTarjetaId = null, gastoFilter = 'todos';
let allPeriods = [], currentPeriodIdx = 0;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
async function init() {
  try {
    const [t, c, g] = await Promise.all([
      sb.from('tarjetas').select('*').order('created_at'),
      sb.from('cierres').select('*'),
      sb.from('gastos').select('*').order('created_at', { ascending: false }),
    ]);
    if (t.error || c.error || g.error) throw new Error();
    tarjetas = t.data; cierres = c.data; gastos = g.data;
    setSyncStatus(true);
  } catch {
    setSyncStatus(false);
    showToast('Error al conectar con la base de datos', 'error');
  }
  document.getElementById('loading-overlay').style.display = 'none';
  buildAllPeriods();
  setCurrentPeriod();
  renderResumen();
}

function setSyncStatus(ok) {
  document.getElementById('sync-dot').style.background = ok ? 'var(--accent)' : 'var(--danger)';
  document.getElementById('sync-text').textContent = ok ? 'Sincronizado' : 'Sin conexi√≥n';
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function showPage(name, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  el.classList.add('active');
  if (name === 'resumen') renderResumen();
  if (name === 'gastos') renderGastos();
  if (name === 'tarjetas') renderTarjetas();
}

// ‚îÄ‚îÄ PER√çODOS ‚îÄ‚îÄ
function getMonthKey(y, m) { return `${y}-${String(m + 1).padStart(2,'0')}`; }
function nextMk(mk) { const [y,m] = mk.split('-').map(Number); const d = new Date(y, m, 1); return getMonthKey(d.getFullYear(), d.getMonth()); }

function getCierreDia(tarjetaId, mk) {
  const c = cierres.find(c => c.tarjeta_id === tarjetaId && c.mes_key === mk);
  return c ? c.dia : null;
}

function getCierreForFecha(tarjetaId, fechaStr) {
  const fc = new Date(fechaStr + 'T12:00:00');
  for (let i = 0; i < 24; i++) {
    const d = new Date(fc.getFullYear(), fc.getMonth() + i, 1);
    const mk = getMonthKey(d.getFullYear(), d.getMonth());
    const dia = getCierreDia(tarjetaId, mk);
    if (!dia) continue;
    if (new Date(d.getFullYear(), d.getMonth(), dia) >= fc) return mk;
  }
  return null;
}

function getCuotasPorPeriodo(gasto) {
  const result = {};
  const mk0 = getCierreForFecha(gasto.tarjeta_id, gasto.fecha);
  if (!mk0) return result;
  const cuotaMonto = gasto.monto / gasto.cuotas;
  let mk = mk0;
  for (let i = 0; i < gasto.cuotas; i++) {
    result[mk] = (result[mk] || 0) + cuotaMonto;
    mk = nextMk(mk);
  }
  return result;
}

function getPeriodRange(tarjetaId, mk) {
  const [y, m] = mk.split('-').map(Number);
  const diaActual = getCierreDia(tarjetaId, mk);
  if (!diaActual) return null;
  const d = new Date(y, m - 1, 1);
  const mkPrev = getMonthKey(d.getFullYear(), d.getMonth() - 1);
  const diaPrev = getCierreDia(tarjetaId, mkPrev);
  if (!diaPrev) return null;
  return {
    desde: new Date(d.getFullYear(), d.getMonth() - 1, diaPrev + 1),
    hasta: new Date(d.getFullYear(), d.getMonth(), diaActual)
  };
}

function buildAllPeriods() {
  const mks = new Set();
  cierres.forEach(c => mks.add(c.mes_key));
  allPeriods = [...mks].sort();
}

function setCurrentPeriod() {
  if (!allPeriods.length) return;
  const now = new Date();
  const mkNow = getMonthKey(now.getFullYear(), now.getMonth());
  const idx = allPeriods.indexOf(mkNow);
  currentPeriodIdx = idx >= 0 ? idx : allPeriods.length - 1;
}

function changePeriod(dir) {
  currentPeriodIdx = Math.max(0, Math.min(allPeriods.length - 1, currentPeriodIdx + dir));
  renderResumen();
}

function mkToLabel(mk) {
  const [y,m] = mk.split('-').map(Number);
  const mes = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][m-1];
  return `Per√≠odo ${mes} ${y}`;
}

// ‚îÄ‚îÄ RESUMEN ‚îÄ‚îÄ
function renderResumen() {
  buildAllPeriods();
  const el = document.getElementById('resumen-content');
  if (!tarjetas.length) { el.innerHTML = `<div class="empty"><div class="empty-icon">üìä</div><div>Primero configur√° tus tarjetas y sus fechas de cierre</div></div>`; document.getElementById('period-label').textContent = '‚Äî'; return; }
  if (!allPeriods.length) { el.innerHTML = `<div class="empty"><div class="empty-icon">üìÖ</div><div>Configur√° las fechas de cierre para ver el resumen</div></div>`; document.getElementById('period-label').textContent = '‚Äî'; return; }
  if (currentPeriodIdx >= allPeriods.length) currentPeriodIdx = allPeriods.length - 1;

  const mk = allPeriods[currentPeriodIdx];
  const [y, m] = mk.split('-').map(Number);
  document.getElementById('period-label').textContent = mkToLabel(mk);
  const esFuturo = new Date(y, m - 1, 28) > new Date();
  let totalGeneral = 0;
  let tarjetasHTML = '';

  tarjetas.forEach(t => {
    const range = getPeriodRange(t.id, mk);
    let total = 0;
    const gastosEnPeriodo = [];
    gastos.forEach(g => {
      if (g.tarjeta_id !== t.id) return;
      const dist = getCuotasPorPeriodo(g);
      if (dist[mk]) { total += dist[mk]; gastosEnPeriodo.push({ g, monto: dist[mk] }); }
    });
    if (!gastosEnPeriodo.length && !range) return;
    totalGeneral += total;

    const desde = range ? formatDate(range.desde) : '‚Äî';
    const hasta = range ? formatDate(range.hasta) : '‚Äî';

    const rows = gastosEnPeriodo.map(({g, monto}) => {
      const cuotaNum = Object.keys(getCuotasPorPeriodo(g)).sort().indexOf(mk) + 1;
      return `<tr>
        <td>${g.categoria ? g.categoria+' ' : ''}${g.descripcion}${g.nota ? `<br><span style="color:var(--muted);font-size:11px;">${g.nota}</span>` : ''}</td>
        <td style="color:var(--muted);font-size:12px;">${formatDate(new Date(g.fecha+'T12:00:00'))}</td>
        <td>${g.cuotas > 1 ? `<span class="cuota-badge">${cuotaNum}/${g.cuotas}</span>` : '<span class="cuota-badge">1 pago</span>'}</td>
        <td style="text-align:right;font-weight:600;">$${fmt(monto)}</td>
      </tr>`;
    }).join('');

    tarjetasHTML += `<div class="card" style="margin-bottom:16px;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="width:14px;height:14px;border-radius:50%;background:${t.color};flex-shrink:0;"></div>
          <div>
            <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;">${t.banco}</div>
            <div style="color:var(--muted);font-size:12px;">${t.nombre}${t.digitos?' ¬∑¬∑¬∑¬∑ '+t.digitos:''} ¬∑ ${desde} ‚Üí ${hasta}</div>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:24px;color:${esFuturo?'var(--accent)':'var(--text)'};">$${fmt(total)}</div>
          <div style="color:var(--muted);font-size:11px;">${esFuturo?'estimado':'facturado'}</div>
        </div>
      </div>
      ${gastosEnPeriodo.length ? `<table><thead><tr><th>Concepto</th><th>Fecha compra</th><th>Cuotas</th><th style="text-align:right;">Monto</th></tr></thead><tbody>${rows}</tbody><tfoot><tr class="total-row"><td colspan="3">Total tarjeta</td><td style="text-align:right;">$${fmt(total)}</td></tr></tfoot></table>` : `<div style="color:var(--muted);font-size:12px;">Sin gastos en este per√≠odo</div>`}
    </div>`;
  });

  el.innerHTML = `
    <div class="summary-grid">
      <div class="summary-card">
        <div class="s-label">Total del per√≠odo</div>
        <div class="s-amount" style="color:${esFuturo?'var(--accent)':'var(--text)'};">$${fmt(totalGeneral)}</div>
        <div class="s-sub">${esFuturo?'üìÖ Per√≠odo futuro (estimado)':'‚úÖ Per√≠odo cerrado o en curso'}</div>
      </div>
      ${tarjetas.map(t => {
        let tot = 0;
        gastos.forEach(g => { if(g.tarjeta_id===t.id){ const d=getCuotasPorPeriodo(g); tot+=d[mk]||0; }});
        return `<div class="summary-card">
          <div class="s-label"><span class="cc-dot" style="background:${t.color}"></span>${t.banco}</div>
          <div class="s-amount" style="font-size:20px;">$${fmt(tot)}</div>
          <div class="progress-bar"><div class="progress-fill" style="width:${totalGeneral?Math.round(tot/totalGeneral*100):0}%;background:${t.color};"></div></div>
          <div class="s-sub" style="margin-top:6px;">${totalGeneral?Math.round(tot/totalGeneral*100):0}% del total</div>
        </div>`;
      }).join('')}
    </div>
    ${tarjetasHTML || `<div class="empty"><div class="empty-icon">üéâ</div><div>Sin gastos en este per√≠odo</div></div>`}`;
}

// ‚îÄ‚îÄ GASTOS ‚îÄ‚îÄ
function renderGastos() {
  const tbody = document.getElementById('gastos-tbody');
  const empty = document.getElementById('gastos-empty');
  const now = new Date();
  let lista = [...gastos];

  if (gastoFilter === 'pendientes') lista = lista.filter(g => {
    const mks = Object.keys(getCuotasPorPeriodo(g)).sort();
    if (!mks.length) return true;
    const [y,m] = mks[mks.length-1].split('-').map(Number);
    return new Date(y, m-1, 28) >= now;
  });
  else if (gastoFilter === 'pasados') lista = lista.filter(g => {
    const mks = Object.keys(getCuotasPorPeriodo(g)).sort();
    if (!mks.length) return false;
    const [y,m] = mks[mks.length-1].split('-').map(Number);
    return new Date(y, m-1, 28) < now;
  });

  if (!lista.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  tbody.innerHTML = lista.map(g => {
    const t = tarjetas.find(t => t.id === g.tarjeta_id);
    return `<tr>
      <td><div style="font-weight:500;">${g.categoria?g.categoria+' ':''}${g.descripcion}</div>${g.nota?`<div style="color:var(--muted);font-size:11px;">${g.nota}</div>`:''}</td>
      <td>${t?`<span class="badge" style="background:${t.color}">${t.banco}</span>`:'‚Äî'}</td>
      <td style="color:var(--muted);">${formatDate(new Date(g.fecha+'T12:00:00'))}</td>
      <td style="font-weight:600;">$${fmt(g.monto)}</td>
      <td style="color:var(--muted);">${g.cuotas>1?`${g.cuotas}x $${fmt(g.monto/g.cuotas)}`:'1 pago'}</td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteGasto('${g.id}')">‚úï</button></td>
    </tr>`;
  }).join('');
}

function filterGastos(f, el) {
  gastoFilter = f;
  document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderGastos();
}

function openModalGasto() {
  if (!tarjetas.length) { showToast('Primero agreg√° una tarjeta', 'error'); return; }
  document.getElementById('g-tarjeta').innerHTML = tarjetas.map(t => `<option value="${t.id}">${t.banco} ‚Äì ${t.nombre}</option>`).join('');
  document.getElementById('g-fecha').value = new Date().toISOString().split('T')[0];
  ['g-monto','g-desc','g-nota'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('g-cuotas').value = 1;
  document.getElementById('g-categoria').value = '';
  document.getElementById('cuotas-preview').style.display = 'none';
  openModal('modal-gasto');
}

function previewCuotas() {
  const cuotas = parseInt(document.getElementById('g-cuotas').value) || 1;
  const monto = parseFloat(document.getElementById('g-monto').value) || 0;
  const tarjetaId = document.getElementById('g-tarjeta').value;
  const fecha = document.getElementById('g-fecha').value;
  const prev = document.getElementById('cuotas-preview');
  if (cuotas <= 1 || !monto || !fecha || !tarjetaId) { prev.style.display = 'none'; return; }

  const dist = getCuotasPorPeriodo({ tarjeta_id: tarjetaId, fecha, monto, cuotas });
  const mks = Object.keys(dist).sort();
  if (!mks.length) { prev.style.display = 'none'; return; }

  document.getElementById('cuotas-preview-content').innerHTML = mks.map((mk, i) =>
    `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);font-size:12px;">
      <span style="color:var(--muted);">Cuota ${i+1}/${cuotas} ¬∑ ${mkToLabel(mk)}</span>
      <span style="font-weight:600;">$${fmt(monto/cuotas)}</span>
    </div>`
  ).join('');
  prev.style.display = 'block';
}

async function saveGasto() {
  const descripcion = document.getElementById('g-desc').value.trim();
  const tarjeta_id = document.getElementById('g-tarjeta').value;
  const fecha = document.getElementById('g-fecha').value;
  const monto = parseFloat(document.getElementById('g-monto').value);
  const cuotas = parseInt(document.getElementById('g-cuotas').value) || 1;
  const categoria = document.getElementById('g-categoria').value;
  const nota = document.getElementById('g-nota').value.trim();

  if (!descripcion) { showToast('Ingres√° una descripci√≥n', 'error'); return; }
  if (!fecha) { showToast('Ingres√° la fecha de compra', 'error'); return; }
  if (!monto || monto <= 0) { showToast('Ingres√° un monto v√°lido', 'error'); return; }

  const btn = document.getElementById('btn-save-gasto');
  btn.disabled = true; btn.innerHTML = '<div class="loader"></div> Guardando...';

  const { data, error } = await sb.from('gastos').insert([{ descripcion, tarjeta_id, fecha, monto, cuotas, categoria, nota }]).select();
  if (error) { showToast('Error al guardar el gasto', 'error'); }
  else { gastos.unshift(data[0]); closeModal('modal-gasto'); renderGastos(); buildAllPeriods(); showToast('Gasto registrado ‚úì', 'success'); }
  btn.disabled = false; btn.innerHTML = 'Registrar';
}

async function deleteGasto(id) {
  if (!confirm('¬øEliminar este gasto?')) return;
  const { error } = await sb.from('gastos').delete().eq('id', id);
  if (error) { showToast('Error al eliminar', 'error'); return; }
  gastos = gastos.filter(g => g.id !== id);
  renderGastos();
  showToast('Gasto eliminado', 'success');
}

// ‚îÄ‚îÄ TARJETAS ‚îÄ‚îÄ
function renderTarjetas() {
  const grid = document.getElementById('cards-grid');
  const empty = document.getElementById('tarjetas-empty');
  if (!tarjetas.length) { grid.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  grid.innerHTML = tarjetas.map(t => {
    const count = cierres.filter(c => c.tarjeta_id === t.id).length;
    return `<div class="credit-card-preview" style="background:${t.color};" onclick="openCierres('${t.id}')">
      <div><div class="cc-bank">${t.banco}</div><div class="cc-name">${t.nombre}</div></div>
      <div style="font-size:22px;">‚¨õ</div>
      <div>
        <div style="font-size:13px;color:rgba(0,0,0,.6);letter-spacing:2px;">${t.digitos?'¬∑¬∑¬∑¬∑ ¬∑¬∑¬∑¬∑ ¬∑¬∑¬∑¬∑ '+t.digitos:'¬∑¬∑¬∑¬∑ ¬∑¬∑¬∑¬∑ ¬∑¬∑¬∑¬∑ ¬∑¬∑¬∑¬∑'}</div>
        <div style="font-size:11px;color:rgba(0,0,0,.5);margin-top:6px;">${count} fecha${count!==1?'s':''} de cierre configurada${count!==1?'s':''}</div>
        <div class="cc-actions" onclick="event.stopPropagation()">
          <button class="btn btn-sm" style="background:rgba(0,0,0,.25);color:#111;border:none;font-size:11px;" onclick="editTarjeta('${t.id}')">‚úèÔ∏è Editar</button>
          <button class="btn btn-sm" style="background:rgba(0,0,0,.25);color:#111;border:none;font-size:11px;" onclick="deleteTarjeta('${t.id}')">‚úï Eliminar</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function openModalTarjeta() {
  editingTarjetaId = null;
  document.getElementById('modal-tarjeta-title').textContent = 'Nueva Tarjeta';
  ['tc-banco','tc-nombre','tc-digitos'].forEach(id => document.getElementById(id).value = '');
  selectedColor = '#c8f135';
  document.querySelectorAll('.color-dot').forEach(d => d.classList.toggle('selected', d.dataset.color === selectedColor));
  openModal('modal-tarjeta');
}

function editTarjeta(id) {
  const t = tarjetas.find(t => t.id === id);
  if (!t) return;
  editingTarjetaId = id;
  document.getElementById('modal-tarjeta-title').textContent = 'Editar Tarjeta';
  document.getElementById('tc-banco').value = t.banco;
  document.getElementById('tc-nombre').value = t.nombre;
  document.getElementById('tc-digitos').value = t.digitos || '';
  selectedColor = t.color;
  document.querySelectorAll('.color-dot').forEach(d => d.classList.toggle('selected', d.dataset.color === t.color));
  openModal('modal-tarjeta');
}

async function saveTarjeta() {
  const banco = document.getElementById('tc-banco').value.trim();
  const nombre = document.getElementById('tc-nombre').value.trim();
  const digitos = document.getElementById('tc-digitos').value.trim();
  if (!banco) { showToast('Ingres√° el nombre del banco', 'error'); return; }
  if (!nombre) { showToast('Ingres√° el nombre de la tarjeta', 'error'); return; }

  const btn = document.getElementById('btn-save-tarjeta');
  btn.disabled = true; btn.innerHTML = '<div class="loader"></div>';

  if (editingTarjetaId) {
    const { error } = await sb.from('tarjetas').update({ banco, nombre, digitos, color: selectedColor }).eq('id', editingTarjetaId);
    if (error) { showToast('Error al actualizar', 'error'); }
    else { Object.assign(tarjetas.find(t => t.id === editingTarjetaId), { banco, nombre, digitos, color: selectedColor }); closeModal('modal-tarjeta'); renderTarjetas(); showToast('Tarjeta actualizada ‚úì', 'success'); }
  } else {
    const { data, error } = await sb.from('tarjetas').insert([{ banco, nombre, digitos, color: selectedColor }]).select();
    if (error) { showToast('Error al guardar', 'error'); }
    else { tarjetas.push(data[0]); closeModal('modal-tarjeta'); renderTarjetas(); showToast('Tarjeta creada ‚úì', 'success'); }
  }
  btn.disabled = false; btn.innerHTML = 'Guardar';
}

async function deleteTarjeta(id) {
  if (!confirm('¬øEliminar esta tarjeta? Se eliminar√°n tambi√©n sus cierres y gastos.')) return;
  const { error } = await sb.from('tarjetas').delete().eq('id', id);
  if (error) { showToast('Error al eliminar', 'error'); return; }
  tarjetas = tarjetas.filter(t => t.id !== id);
  cierres = cierres.filter(c => c.tarjeta_id !== id);
  gastos = gastos.filter(g => g.tarjeta_id !== id);
  renderTarjetas();
  document.getElementById('cierres-section').style.display = 'none';
  showToast('Tarjeta eliminada', 'success');
}

function selectColor(el) {
  selectedColor = el.dataset.color;
  document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
  el.classList.add('selected');
}

// ‚îÄ‚îÄ CIERRES ‚îÄ‚îÄ
function openCierres(tarjetaId) {
  const t = tarjetas.find(t => t.id === tarjetaId);
  document.getElementById('cierre-titulo').textContent = `${t.banco} ‚Äî ${t.nombre}`;
  const sec = document.getElementById('cierres-section');
  sec.style.display = 'block';
  sec.dataset.tid = tarjetaId;
  renderCierresGrid(tarjetaId);
  sec.scrollIntoView({ behavior: 'smooth' });
}

function renderCierresGrid(tarjetaId) {
  const now = new Date();
  const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  let html = '';
  for (let offset = -3; offset <= 9; offset++) {
    const d = new Date(now.getFullYear(), now.getMonth() + offset, 1);
    const mk = getMonthKey(d.getFullYear(), d.getMonth());
    const cierre = cierres.find(c => c.tarjeta_id === tarjetaId && c.mes_key === mk);
    const dia = cierre ? cierre.dia : '';
    html += `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;">
      <div style="color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">${meses[d.getMonth()]} ${d.getFullYear()}</div>
      <div style="display:flex;align-items:center;gap:8px;">
        <input type="number" min="1" max="31" placeholder="D√≠a" style="width:70px;" value="${dia}"
          onchange="saveCierre('${tarjetaId}','${mk}',this.value,'${cierre ? cierre.id : ''}')">
        <span style="color:var(--muted);font-size:11px;" id="cl-${mk}">${dia ? 'd√≠a ' + dia : 'sin fecha'}</span>
      </div>
    </div>`;
  }
  document.getElementById('cierres-grid').innerHTML = html;
}

async function saveCierre(tarjetaId, mk, valor, existingId) {
  const dia = parseInt(valor);
  if (dia >= 1 && dia <= 31) {
    if (existingId) {
      const { error } = await sb.from('cierres').update({ dia }).eq('id', existingId);
      if (!error) { const c = cierres.find(c => c.id === existingId); if (c) c.dia = dia; const lbl = document.getElementById('cl-'+mk); if(lbl) lbl.textContent='d√≠a '+dia; }
    } else {
      const { data, error } = await sb.from('cierres').insert([{ tarjeta_id: tarjetaId, mes_key: mk, dia }]).select();
      if (!error) { cierres.push(data[0]); renderCierresGrid(tarjetaId); }
    }
    buildAllPeriods();
    showToast('Cierre guardado ‚úì', 'success');
  } else if (!valor) {
    if (existingId) {
      await sb.from('cierres').delete().eq('id', existingId);
      cierres = cierres.filter(c => c.id !== existingId);
      renderCierresGrid(tarjetaId);
      buildAllPeriods();
    }
  }
}

function closeCierres() { document.getElementById('cierres-section').style.display = 'none'; }

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function fmt(n) {
  if (!n) return '0';
  const r = Math.round(n * 100) / 100;
  return r % 1 === 0 ? r.toLocaleString('es-AR') : r.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatDate(d) {
  if (!d || isNaN(d)) return '‚Äî';
  return `${d.getDate()} ${['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][d.getMonth()]} ${d.getFullYear()}`;
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = (type === 'success' ? '‚úì ' : '‚úï ') + msg;
  t.className = `toast show ${type}`;
  clearTimeout(t._t);
  t._t = setTimeout(() => t.className = 'toast', 3000);
}

document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); }));

init();
</script>
</body>
</html>
